# 长期优化计划：参考 CKEditor 5 架构

## 优化目标

参考 CKEditor 5 的架构设计，逐步改进当前实现，提升稳定性、可维护性和性能。

## 优化原则

1. **渐进式改进**：不一次性重构，分步骤实施
2. **向后兼容**：确保每个步骤都不破坏现有功能
3. **性能优先**：优化性能，减少不必要的 DOM 操作
4. **可维护性**：提高代码可读性和可维护性

## 优化步骤

### 阶段 1：统一 DOM 操作接口（Writer 模式）✅ 进行中

**目标**：创建统一的 DOM 操作接口，类似 CKEditor 5 的 `writer`

**实施内容**：
1. 创建 `DOMWriter` 类，封装所有 DOM 操作
2. 确保操作原子性（要么全部成功，要么全部失败）
3. 自动处理光标位置保存/恢复
4. 自动触发状态同步

**预期效果**：
- 所有 DOM 操作通过统一接口
- 减少重复代码
- 提高操作一致性
- 为后续优化打下基础

### 阶段 2：内容变化追踪

**目标**：记录所有 DOM 操作，为撤销/重做做准备

**实施内容**：
1. 在 `DOMWriter` 中记录所有操作
2. 实现操作历史栈
3. 支持操作回滚

**预期效果**：
- 为撤销/重做功能打下基础
- 可以精确追踪内容变化

### 阶段 3：批量操作支持

**目标**：支持批量 DOM 操作，减少重绘

**实施内容**：
1. 在 `DOMWriter` 中实现批量操作模式
2. 延迟 DOM 更新，批量执行
3. 减少 `requestAnimationFrame` 调用

**预期效果**：
- 提高性能，减少重绘
- 减少光标跳动

### 阶段 4：内容同步优化

**目标**：优化内容同步机制，减少不必要的 DOM 重新加载

**实施内容**：
1. 实现更精确的内容比较
2. 增量更新 DOM，而不是完全重新加载
3. 优化光标位置恢复机制

**预期效果**：
- 减少 DOM 重新加载
- 提高性能
- 减少光标跳动

### 阶段 5：抽象数据模型（可选）

**目标**：引入独立于 DOM 的数据模型

**实施内容**：
1. 设计数据模型结构
2. 实现 Model 到 View 的转换
3. 实现 View 到 Model 的转换
4. 所有操作通过 Model 进行

**预期效果**：
- 完全解耦 DOM 和业务逻辑
- 支持撤销/重做
- 提高可测试性

## 实施优先级

1. **高优先级**：阶段 1（统一 DOM 操作接口）
2. **中优先级**：阶段 3（批量操作支持）、阶段 4（内容同步优化）
3. **低优先级**：阶段 2（内容变化追踪）、阶段 5（抽象数据模型）

## 当前状态

### 阶段 1：统一 DOM 操作接口（Writer 模式）✅ 已完成

**已完成**：
- ✅ 创建 `DOMWriter` 类，封装所有 DOM 操作
- ✅ 实现操作原子性（通过 `execute` 方法）
- ✅ 自动处理光标位置保存/恢复
- ✅ 自动触发状态同步
- ✅ 支持批量操作模式（`beginBatch` / `endBatch`）
- ✅ 提供常用 DOM 操作方法（`insertNode`, `removeNode`, `replaceNode`, `setAttribute`, `setClass`, `setStyle`, `setContent`, `setSelection`）

**待迁移**：
- ⏳ 逐步将现有 DOM 操作迁移到使用 `DOMWriter`
- ⏳ 优先迁移关键操作（格式应用、列表插入等）

**使用示例**：
```javascript
// 单个操作
domWriter.insertNode(newNode, referenceNode);

// 批量操作
domWriter.beginBatch();
domWriter.insertNode(node1, ref1);
domWriter.insertNode(node2, ref2);
domWriter.removeNode(oldNode);
domWriter.endBatch(); // 所有操作一次性执行
```

### 阶段 2：内容变化追踪 ✅ 已完成

**已完成**：
- ✅ 在 `DOMWriter` 中记录所有操作
- ✅ 实现操作历史栈（最多保存 50 个操作）
- ✅ 支持操作回滚（撤销/重做）
- ✅ 提供撤销/重做接口（`undo`, `redo`, `canUndo`, `canRedo`）
- ✅ 自动清空历史记录（当外部加载内容时）

**实现细节**：
- 每个操作记录前后状态快照（HTML 和光标位置）
- 支持批量操作的历史记录
- 自动限制历史大小（最多 50 个操作）

**使用示例**：
```javascript
// 撤销
window.MiNoteWebEditor.undo();

// 重做
window.MiNoteWebEditor.redo();

// 检查是否可以撤销/重做
if (window.MiNoteWebEditor.canUndo()) {
    // 可以撤销
}
```

### 阶段 3：批量操作支持 ✅ 已完成

**已完成**：
- ✅ 在 `DOMWriter` 中实现批量操作模式
- ✅ 延迟 DOM 更新，批量执行
- ✅ 减少 `requestAnimationFrame` 调用

### 阶段 4：内容同步优化 ✅ 部分完成

**已完成**：
- ✅ 实现精确的内容比较（XML 和 HTML 双重比较）
- ✅ 避免不必要的 DOM 重新加载
- ✅ 优化光标位置恢复机制

**待优化**：
- ⏳ 实现增量更新 DOM，而不是完全重新加载
- ⏳ 进一步优化内容比较算法

### 阶段 5：抽象数据模型（可选）⏳ 待实施

**计划**：
- 设计数据模型结构
- 实现 Model 到 View 的转换
- 实现 View 到 Model 的转换
- 所有操作通过 Model 进行

