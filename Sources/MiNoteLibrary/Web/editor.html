<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>小米笔记编辑器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* 浅色模式颜色变量 */
        :root {
            --bg-color: #fff;
            --text-color: #333;
            --bullet-color: #666;
            --quote-border: #ccc;
            --quote-text: #666;
            --hr-color: #ddd;
            --placeholder-color: #999;
        }
        
        /* 深色模式颜色变量 */
        html[data-color-scheme="dark"],
        :root[data-color-scheme="dark"] {
            --bg-color: #1e1e1e;
            --text-color: #d4d4d4;
            --bullet-color: #858585;
            --quote-border: #5a5a5a;
            --quote-text: #858585;
            --hr-color: #3e3e42;
            --placeholder-color: #6a6a6a;
            }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--bg-color);
            padding: 0;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        
        #editor-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #editor-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            outline: none;
            min-height: 200px;
            color: var(--text-color);
            background-color: var(--bg-color);
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        
        /* 小米笔记样式 */
        .mi-note-highlight {
            background-color: rgba(154, 255, 232, 0.69); /* #9affe8af */
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .mi-note-text {
            margin-bottom: 8px;
            padding-left: 0;
        }
        
        .mi-note-text.indent-1 { padding-left: 0; }
        .mi-note-text.indent-2 { padding-left: 20px; }
        .mi-note-text.indent-3 { padding-left: 40px; }
        .mi-note-text.indent-4 { padding-left: 60px; }
        .mi-note-text.indent-5 { padding-left: 80px; }
        
        .mi-note-bullet, .mi-note-order, .mi-note-checkbox {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            position: relative;
        }
        
        .mi-note-bullet::before {
            content: "•";
            margin-right: 8px;
            color: var(--bullet-color);
            flex-shrink: 0;
        }
        
        .mi-note-order::before {
            content: attr(data-number) ".";
            margin-right: 8px;
            color: var(--bullet-color);
            min-width: 20px;
            text-align: right;
            flex-shrink: 0;
        }
        
        .mi-note-order:empty,
        .mi-note-bullet:empty {
            min-height: 1.5em;
        }
        
        /* 零宽度空格用于保持光标可见，但不应该显示出来 */
        .mi-note-order,
        .mi-note-bullet,
        .mi-note-checkbox span {
            white-space: pre-wrap;
        }
        
        /* 确保零宽度空格不可见 */
        .mi-note-order *,
        .mi-note-bullet *,
        .mi-note-checkbox span * {
            font-size: inherit;
        }
        
        .mi-note-checkbox {
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .mi-note-checkbox input[type="checkbox"] {
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .mi-note-checkbox > *:not(input[type="checkbox"]) {
            flex: 1;
            min-width: 0;
        }
        
        .mi-note-hr {
            height: 1px;
            background-color: var(--hr-color);
            margin: 16px 0;
            border: none;
            transition: background-color 0.2s ease;
        }
        
        .mi-note-quote {
            border-left: 3px solid var(--quote-border);
            padding-left: 12px;
            margin: 8px 0;
            color: var(--quote-text);
            transition: border-color 0.2s ease, color 0.2s ease;
        }
        
        .mi-note-text.center {
            text-align: center;
        }
        
        .mi-note-text.right {
            text-align: right;
        }
        
        /* 富文本样式 */
        .mi-note-text b, .mi-note-text strong {
            font-weight: bold;
        }
        
        .mi-note-text i, .mi-note-text em {
            font-style: italic;
        }
        
        .mi-note-text u {
            text-decoration: underline;
        }
        
        .mi-note-text s, .mi-note-text del {
            text-decoration: line-through;
        }
        
        .mi-note-text .mi-note-size {
            font-size: 24px;
            font-weight: bold;
        }
        
        .mi-note-text .mi-note-mid-size {
            font-size: 20px;
            font-weight: bold;
        }
        
        .mi-note-text .mi-note-h3-size {
            font-size: 18px;
            font-weight: bold;
        }
        
        /* 图片样式 */
        .mi-note-image {
            max-width: 100%;
            height: auto;
            margin: 8px 0;
        }
        
        .mi-note-image-container {
            margin: 8px 0;
        }
        
        /* 占位符 */
        .placeholder {
            color: var(--placeholder-color);
        }
        
        /* 确保所有文本元素使用正确的颜色 */
        .mi-note-text,
        .mi-note-bullet,
        .mi-note-order,
        .mi-note-checkbox {
            color: var(--text-color);
        }
        
        /* 焦点样式 */
        #editor-content:focus {
            outline: none;
        }
    </style>
</head>
<body>
    <div id="editor-container">
        <div id="editor-content" contenteditable="true" spellcheck="false" style="white-space: pre-wrap;">
            <!-- 内容将在这里动态加载 -->
        </div>
    </div>

    <!-- 引入格式转换模块 -->
    <script src="xml-to-html.js"></script>
    <script src="html-to-xml.js"></script>

    <script>
        // ==================== 全局变量 ====================
        let xmlToHtmlConverter = null;
        let htmlToXmlConverter = null;
        let currentContent = '';
        let isInitialized = false;
        let isLoadingContent = false;
        let contentChangeTimer = null;

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化转换器
            xmlToHtmlConverter = new XMLToHTMLConverter();
            htmlToXmlConverter = new HTMLToXMLConverter();

            const editor = document.getElementById('editor-content');
            if (!editor) {
                console.error('[Editor] 无法找到编辑器元素');
                    return;
                }
                
            // 设置占位符
            if (!editor.innerHTML.trim()) {
                editor.innerHTML = '<div class="placeholder">开始输入...</div>';
            }

            // 内容变化监听（防抖处理）
            editor.addEventListener('input', function() {
                if (isLoadingContent) {
                    return;
                }
                clearTimeout(contentChangeTimer);
                contentChangeTimer = setTimeout(function() {
                    notifyContentChanged();
                }, 300); // 300ms 防抖
            });

            // 选择变化监听（用于同步格式状态）
            document.addEventListener('selectionchange', function() {
                if (isLoadingContent || !isInitialized) {
                    return;
                }
                syncFormatState();
            });

            // 处理回车键事件
            editor.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    handleEnterKey(e);
                }
            });

            // 初始化完成
            isInitialized = true;
            console.log('[Editor] 编辑器初始化完成');

            // 通知 Swift 编辑器已准备好
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.editorBridge) {
                        window.webkit.messageHandlers.editorBridge.postMessage({
                    type: 'editorReady'
                });
            }
        });

        // ==================== window.MiNoteWebEditor 接口 ====================
        window.MiNoteWebEditor = {
            /**
             * 加载 XML 内容到编辑器
             * @param {string} xmlContent - 小米笔记 XML 格式内容
             * @returns {string} 状态信息
             */
            loadContent: function(xmlContent) {
                const editor = document.getElementById('editor-content');
                if (!editor) {
                    console.error('[loadContent] 无法找到编辑器元素');
                    return '编辑器元素不存在';
                }

                console.log('[loadContent] 开始加载内容，XML长度:', xmlContent ? xmlContent.length : 0);

                // 如果内容没有实际变化，不需要重新加载
                if (currentContent === xmlContent) {
                    console.log('[loadContent] 内容未变化，跳过加载');
                    return '内容未变化';
                }

                // 设置加载标志
                isLoadingContent = true;
                currentContent = xmlContent;

                // 如果内容为空，显示占位符
                if (!xmlContent || xmlContent.trim() === '') {
                    editor.innerHTML = '<div class="placeholder">开始输入...</div>';
                    isLoadingContent = false;
                    isInitialized = true;
                    return '内容已加载（空内容）';
                }

                // 转换为 HTML
                try {
                    const html = xmlToHtmlConverter.convert(xmlContent);
                    if (!html || html.trim() === '') {
                        editor.innerHTML = '<div class="placeholder">开始输入...</div>';
                    } else {
                        editor.innerHTML = html;
                    }
                    console.log('[loadContent] 内容已加载，HTML长度:', html.length);
                    isInitialized = true;
                    } catch (error) {
                    console.error('[loadContent] 转换失败:', error);
                    console.error('[loadContent] 错误详情:', error.message, error.stack);
                    editor.innerHTML = '<div class="placeholder">内容加载失败</div>';
                } finally {
                    isLoadingContent = false;
                }

                return '内容已加载';
            },

            /**
             * 获取当前编辑器的内容并转换为 XML
             * @returns {string} 小米笔记 XML 格式内容
             */
            getContent: function() {
                const editor = document.getElementById('editor-content');
                if (!editor) {
                    console.error('[getContent] 无法找到编辑器元素');
                    return '';
                }

                const htmlContent = editor.innerHTML;
                
                // 检查是否是占位符或空内容
                if (!htmlContent || 
                    htmlContent.trim() === '' || 
                    htmlContent.includes('开始输入...') ||
                    htmlContent.trim() === '<div class="placeholder">开始输入...</div>') {
                    return '';
                }

                try {
                    const xmlContent = htmlToXmlConverter.convert(htmlContent);
                    console.log('[getContent] 转换完成，XML长度:', xmlContent.length);
                    return xmlContent;
                } catch (error) {
                    console.error('[getContent] 转换失败:', error);
                    console.error('[getContent] 错误详情:', error.message, error.stack);
                    return '';
                }
            },

            /**
             * 强制立即保存当前内容
             * @returns {string} 状态信息
             */
            forceSaveContent: function() {
                console.log('[forceSaveContent] 强制保存当前内容');
                notifyContentChanged();
                return '内容已强制保存';
            },
            
            /**
             * 设置颜色方案（深色/浅色模式）
             * @param {string} scheme - 'light' 或 'dark'
             * @returns {string} 状态信息
             */
            setColorScheme: function(scheme) {
                console.log('[setColorScheme] 设置颜色方案:', scheme);
                
                const root = document.documentElement;
                const body = document.body;
                
                if (scheme === 'dark') {
                    root.setAttribute('data-color-scheme', 'dark');
                    if (body) {
                        body.setAttribute('data-color-scheme', 'dark');
                    }
                    console.log('[setColorScheme] 已设置为深色模式');
                } else {
                    root.setAttribute('data-color-scheme', 'light');
                    if (body) {
                        body.setAttribute('data-color-scheme', 'light');
                    }
                    console.log('[setColorScheme] 已设置为浅色模式');
                }
                
                return '颜色方案已设置为: ' + scheme;
            },
            
            /**
             * 执行格式操作
             * @param {string} action - 操作类型
             * @param {string} value - 操作值（可选）
             * @returns {string} 状态信息
             */
            executeFormatAction: function(action, value) {
                console.log('[executeFormatAction] 执行格式操作:', action, value);
                const editor = document.getElementById('editor-content');
                if (!editor) {
                    console.error('[executeFormatAction] 无法找到编辑器元素');
                    return '编辑器元素不存在';
                }

                // 确保编辑器有焦点
                editor.focus();

                try {
                    switch (action) {
                        case 'bold':
                            return this.applyFormat('bold');
                        case 'italic':
                            return this.applyFormat('italic');
                        case 'underline':
                            return this.applyFormat('underline');
                        case 'strikethrough':
                            return this.applyFormat('strikethrough');
                        case 'highlight':
                            return this.applyFormat('highlight');
                        case 'heading':
                            return this.applyHeading(value ? parseInt(value, 10) : 0);
                        case 'textAlignment':
                            return this.applyAlignment(value || 'left');
                        case 'bulletList':
                            return this.insertBulletList();
                        case 'orderList':
                            return this.insertOrderList();
                        case 'quote':
                            return this.insertQuote();
                        case 'checkbox':
                            return this.insertCheckbox();
                        case 'horizontalRule':
                            return this.insertHorizontalRule();
                        default:
                            console.log('[executeFormatAction] 未实现的操作:', action);
                            return '操作暂未实现: ' + action;
                    }
                } catch (error) {
                    console.error('[executeFormatAction] 执行失败:', error);
                    console.error('[executeFormatAction] 错误堆栈:', error.stack);
                    return '操作执行失败: ' + error.message;
                }
            },

            /**
             * 应用文本格式（加粗、斜体、下划线、删除线、高亮）
             * @param {string} format - 格式类型
             * @returns {string} 状态信息
             */
            applyFormat: function(format) {
                const selection = window.getSelection();
                if (!selection.rangeCount) {
                    return '请先选中文本';
                }

                const range = selection.getRangeAt(0);
                
                try {
                    // 检查当前格式状态
                    const isCurrentlyFormatted = this._checkFormatStateInternal(range, format);
                    
                    let tagName = '';
                    let className = '';
                    
                    switch (format) {
                        case 'bold':
                            tagName = 'b';
                            break;
                        case 'italic':
                            tagName = 'i';
                            break;
                        case 'underline':
                            tagName = 'u';
                            break;
                        case 'strikethrough':
                            tagName = 's';
                            break;
                        case 'highlight':
                            className = 'mi-note-highlight';
                            break;
                    }

                    if (range.collapsed) {
                        // 光标位置：需要清除或应用格式
                        if (isCurrentlyFormatted) {
                            // 当前已应用格式，需要清除
                            // 将光标移出格式元素，确保后续输入不继承格式
                            this.clearFormatAtCursor(range, format, tagName, className);
                        } else {
                            // 当前未应用格式，需要应用
                            // 获取更新后的 range（可能已经被移动）
                            const updatedRange = selection.rangeCount > 0 ? selection.getRangeAt(0) : range;
                            
                            // 确保光标不在其他格式元素内，然后应用格式
                            this.ensureCursorOutsideFormatElements(updatedRange, format, tagName, className);
                            
                            // 再次获取 range（可能已经被移动）
                            const finalRange = selection.rangeCount > 0 ? selection.getRangeAt(0) : updatedRange;
                            
                            if (tagName) {
                                // 使用 execCommand 应用格式（会在输入时生效）
                                document.execCommand(format, false, null);
                            } else if (className) {
                                // 高亮：创建高亮 span 等待输入
                                const highlightSpan = document.createElement('span');
                                highlightSpan.className = className;
                                highlightSpan.style.backgroundColor = 'rgba(154, 255, 232, 0.69)';
                                highlightSpan.innerHTML = '\u200B';
                                
                                // 确保在正确的位置插入
                                finalRange.insertNode(highlightSpan);
                                
                                // 移动光标到 span 内
                                const newRange = document.createRange();
                                newRange.setStart(highlightSpan, 0);
                                newRange.collapse(true);
                                selection.removeAllRanges();
                                selection.addRange(newRange);
                            }
                        }
                    } else {
                        // 有选中文本：切换格式
                        if (isCurrentlyFormatted) {
                            // 当前已应用格式，需要清除
                            this.removeFormatFromSelection(range, format, tagName, className);
                        } else {
                            // 当前未应用格式，需要应用
                            if (tagName) {
                                document.execCommand(format, false, null);
                            } else if (className) {
                                const selectedText = range.toString();
                                const highlightSpan = document.createElement('span');
                                highlightSpan.className = className;
                                highlightSpan.style.backgroundColor = 'rgba(154, 255, 232, 0.69)';
                                highlightSpan.textContent = selectedText;
                                range.deleteContents();
                                range.insertNode(highlightSpan);
                                
                                // 恢复选择
                                selection.removeAllRanges();
                                const newRange = document.createRange();
                                newRange.selectNodeContents(highlightSpan);
                                selection.addRange(newRange);
                            }
                        }
                    }

                    notifyContentChanged();
                    return format + ' 格式已' + (isCurrentlyFormatted ? '清除' : '应用');
                } catch (error) {
                    console.error('[applyFormat] 应用格式失败:', error);
                    return '应用格式失败: ' + error.message;
                }
            },

            /**
             * 检查当前格式状态（供外部调用）
             * @param {Range} range - 选择范围（可选，如果不提供则使用当前选择）
             * @param {string} format - 格式类型
             * @returns {boolean} 是否已应用格式
             */
            checkFormatState: function(range, format) {
                // 如果没有提供 range，使用当前选择
                if (!range) {
                    const selection = window.getSelection();
                    if (!selection.rangeCount) {
                        return false;
                    }
                    range = selection.getRangeAt(0);
                }
                
                return this._checkFormatStateInternal(range, format);
            },

            /**
             * 内部方法：检查当前格式状态
             * @param {Range} range - 选择范围
             * @param {string} format - 格式类型
             * @returns {boolean} 是否已应用格式
             */
            _checkFormatStateInternal: function(range, format) {
                let tagName = '';
                let className = '';
                
                switch (format) {
                    case 'bold':
                        tagName = 'b';
                        break;
                    case 'italic':
                        tagName = 'i';
                        break;
                    case 'underline':
                        tagName = 'u';
                        break;
                    case 'strikethrough':
                        tagName = 's';
                        break;
                    case 'highlight':
                        className = 'mi-note-highlight';
                        break;
                }

                // 方法1：使用 document.queryCommandState 检查格式状态（最准确，类似 CKEditor 5）
                try {
                    if (tagName) {
                        const state = document.queryCommandState(format);
                        // 确保返回值是有效的布尔值
                        if (state !== undefined && state !== null) {
                            return Boolean(state);
                        }
                    }
                } catch (e) {
                    // queryCommandState 可能不支持某些格式，继续使用 DOM 检查
                }

                // 方法2：使用 DOM 检查格式状态（更可靠的方法，参考 CKEditor 5）
                let container = range.commonAncestorContainer;
                
                // 如果是文本节点，检查其父元素
                if (container.nodeType === Node.TEXT_NODE) {
                    container = container.parentElement;
                }

                // 向上查找格式标签（支持所有可能的标签变体）
                let current = container;
                while (current && current !== document.body) {
                    if (current.nodeType === Node.ELEMENT_NODE) {
                        const tag = current.tagName ? current.tagName.toLowerCase() : '';
                        // 检查所有可能的格式标签变体（类似 CKEditor 5 的处理）
                        if (tagName) {
                            if (tag === tagName || 
                                (tag === 'strong' && tagName === 'b') || 
                                (tag === 'em' && tagName === 'i') ||
                                (tag === 'strike' && tagName === 's') ||
                                (tag === 'del' && tagName === 's')) {
                                return true;
                            }
                        }
                        if (className && current.classList && current.classList.contains(className)) {
                            return true;
                        }
                    }
                    current = current.parentElement || current.parentNode;
                }

                // 方法3：如果光标位置没有格式，检查选中文本是否包含格式
                if (!range.collapsed) {
                    try {
                        const contents = range.cloneContents();
                        // 检查克隆内容中是否包含格式元素
                        if (tagName) {
                            const formatElements = contents.querySelectorAll(tagName + ', strong, em, strike, del');
                            if (formatElements.length > 0) {
                                return true;
                            }
                        }
                        if (className) {
                            const formatElements = contents.querySelectorAll('.' + className);
                            if (formatElements.length > 0) {
                                return true;
                            }
                        }
                    } catch (e) {
                        // 忽略错误
                    }
                }

                return false;
            },

            /**
             * 清除光标位置的格式（改进版，参考 CKEditor 5 的实现方式）
             * @param {Range} range - 选择范围
             * @param {string} format - 格式类型
             * @param {string} tagName - 标签名
             * @param {string} className - 类名
             */
            clearFormatAtCursor: function(range, format, tagName, className) {
                const selection = window.getSelection();
                
                // 方法1：尝试使用 removeFormat 命令（更可靠，类似 CKEditor 5 的方式）
                // 这是最接近标准实现的方法
                try {
                    // 先使用 removeFormat 清除所有格式
                    document.execCommand('removeFormat', false, null);
                    // 然后再次应用格式以切换状态（这会清除当前格式）
                    // 注意：这里不需要再次应用，因为我们要清除格式
                    // 但为了确保状态正确，我们检查一下
                    const stillFormatted = document.queryCommandState(format);
                    if (!stillFormatted) {
                        // 格式已清除，光标位置应该已经正确
                        return;
                    }
                } catch (e) {
                    // removeFormat 可能不支持，继续使用手动方法
                    console.warn('[clearFormatAtCursor] removeFormat 命令失败，使用手动方法:', e);
                }
                
                // 方法2：手动清除（当 removeFormat 不可用时）
                // 查找光标位置所在的格式元素
                let container = range.commonAncestorContainer;
                let formatElement = null;
                
                // 向上查找格式标签
                let current = container;
                while (current && current !== document.body) {
                    if (current.nodeType === Node.ELEMENT_NODE) {
                        const tag = current.tagName ? current.tagName.toLowerCase() : '';
                        // 检查是否是目标格式元素
                        if (tagName && (tag === tagName || (tag === 'strong' && tagName === 'b') || (tag === 'em' && tagName === 'i'))) {
                            formatElement = current;
                            break;
                        }
                        if (className && current.classList && current.classList.contains(className)) {
                            formatElement = current;
                            break;
                        }
                    }
                    current = current.parentElement || current.parentNode;
                }

                if (formatElement) {
                    // 如果光标在格式元素内，需要将光标移出格式元素
                    const parent = formatElement.parentElement;
                    if (!parent) {
                        // 如果没有父元素，使用 execCommand
                        try {
                            document.execCommand(format, false, null);
                        } catch (e) {
                            console.warn('[clearFormatAtCursor] execCommand 清除格式失败:', e);
                        }
                        return;
                    }

                    // 检查光标是否在格式元素的末尾
                    let isAtEnd = false;
                    if (container.nodeType === Node.TEXT_NODE) {
                        const textNode = container;
                        const offset = range.startOffset;
                        const lastTextNode = this.getLastTextNode(formatElement);
                        if (textNode === lastTextNode) {
                            isAtEnd = offset === textNode.textContent.length;
                        }
                    } else {
                        const lastTextNode = this.getLastTextNode(formatElement);
                        if (lastTextNode) {
                            const offset = range.startOffset;
                            isAtEnd = offset === lastTextNode.textContent.length;
                        }
                    }
                    
                    // 无论光标在格式元素的什么位置，都将其移出
                    // 在格式元素后插入文本节点（类似 CKEditor 5 的行为）
                    const textNode = document.createTextNode('');
                    if (formatElement.nextSibling) {
                        parent.insertBefore(textNode, formatElement.nextSibling);
                    } else {
                        parent.appendChild(textNode);
                    }
                    
                    // 移动光标到文本节点
                    const newRange = document.createRange();
                    newRange.setStart(textNode, 0);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                } else {
                    // 使用 execCommand 清除格式
                    try {
                        document.execCommand(format, false, null);
                    } catch (e) {
                        console.warn('[clearFormatAtCursor] execCommand 清除格式失败:', e);
                    }
                }
            },

            /**
             * 获取元素的最后一个文本节点
             * @param {Node} element - 元素
             * @returns {Node|null} 最后一个文本节点
             */
            getLastTextNode: function(element) {
                if (!element) return null;
                
                // 深度优先搜索最后一个文本节点
                const walker = document.createTreeWalker(
                    element,
                    NodeFilter.SHOW_TEXT,
                    null
                );
                
                let lastTextNode = null;
                let node = walker.nextNode();
                while (node) {
                    lastTextNode = node;
                    node = walker.nextNode();
                }
                
                return lastTextNode;
            },

            /**
             * 确保光标不在格式元素内（应用格式前调用）
             * 如果光标在任何格式元素内，将其移出，确保新输入的内容格式与菜单状态一致
             * @param {Range} range - 选择范围
             * @param {string} format - 格式类型
             * @param {string} tagName - 标签名
             * @param {string} className - 类名
             */
            ensureCursorOutsideFormatElements: function(range, format, tagName, className) {
                const selection = window.getSelection();
                
                // 查找光标位置是否在任何格式元素内（加粗、斜体、下划线、删除线、高亮）
                let container = range.commonAncestorContainer;
                let formatElement = null;
                
                // 向上查找所有可能的格式标签
                let current = container;
                while (current && current !== document.body) {
                    if (current.nodeType === Node.ELEMENT_NODE) {
                        const tag = current.tagName ? current.tagName.toLowerCase() : '';
                        const hasClass = current.classList || false;
                        
                        // 检查是否是任何格式元素
                        const isFormatElement = 
                            tag === 'b' || tag === 'strong' ||  // 加粗
                            tag === 'i' || tag === 'em' ||      // 斜体
                            tag === 'u' ||                       // 下划线
                            tag === 's' || tag === 'strike' || tag === 'del' ||  // 删除线
                            (hasClass && current.classList.contains('mi-note-highlight'));  // 高亮
                        
                        if (isFormatElement) {
                            formatElement = current;
                            break;
                        }
                    }
                    current = current.parentElement || current.parentNode;
                }

                if (formatElement) {
                    // 光标在格式元素内，需要移出
                    const parent = formatElement.parentElement;
                    if (parent) {
                        // 检查光标是否在格式元素的末尾
                        let isAtEnd = false;
                        if (container.nodeType === Node.TEXT_NODE) {
                            const textNode = container;
                            const offset = range.startOffset;
                            const lastTextNode = this.getLastTextNode(formatElement);
                            if (textNode === lastTextNode) {
                                isAtEnd = offset === textNode.textContent.length;
                            }
                        } else {
                            const lastTextNode = this.getLastTextNode(formatElement);
                            if (lastTextNode) {
                                const offset = range.startOffset;
                                isAtEnd = offset === lastTextNode.textContent.length;
                            }
                        }
                        
                        // 无论光标在格式元素的什么位置，都将其移出
                        // 在格式元素后插入文本节点
                        const textNode = document.createTextNode('');
                        if (formatElement.nextSibling) {
                            parent.insertBefore(textNode, formatElement.nextSibling);
                        } else {
                            parent.appendChild(textNode);
                        }
                        
                        // 移动光标到文本节点
                        const newRange = document.createRange();
                        newRange.setStart(textNode, 0);
                        newRange.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    }
                }
            },

            /**
             * 从选中文本中移除格式
             * @param {Range} range - 选择范围
             * @param {string} format - 格式类型
             * @param {string} tagName - 标签名
             * @param {string} className - 类名
             */
            removeFormatFromSelection: function(range, format, tagName, className) {
                // 使用 execCommand 移除格式
                try {
                    document.execCommand(format, false, null);
                } catch (e) {
                    // 如果 execCommand 失败，手动移除格式标签
                    console.warn('[removeFormatFromSelection] execCommand 失败，手动移除格式:', e);
                    
                    const contents = range.extractContents();
                    const walker = document.createTreeWalker(
                        contents,
                        NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT,
                        null
                    );

                    const fragment = document.createDocumentFragment();
                    let node = walker.nextNode();
                    while (node) {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            if (tagName && node.tagName && node.tagName.toLowerCase() === tagName) {
                                // 移除格式标签，保留内容
                                while (node.firstChild) {
                                    fragment.appendChild(node.firstChild);
                                }
                            } else if (className && node.classList && node.classList.contains(className)) {
                                // 移除高亮，保留内容
                                while (node.firstChild) {
                                    fragment.appendChild(node.firstChild);
                                }
                            } else {
                                fragment.appendChild(node.cloneNode(true));
                            }
                        } else {
                            fragment.appendChild(node.cloneNode(true));
                        }
                        node = walker.nextNode();
                    }

                    range.insertNode(fragment);
                }
            },

            /**
             * 应用标题格式
             * @param {number} level - 标题级别 (0=清除, 1=大标题, 2=二级标题, 3=三级标题)
             * @returns {string} 状态信息
             */
            applyHeading: function(level) {
                const selection = window.getSelection();
                if (!selection.rangeCount) {
                    return '请先选中文本或定位光标';
                }

                const range = selection.getRangeAt(0);
                
                try {
                    // 查找包含选中文本的文本元素
                    let textElement = range.commonAncestorContainer;
                    if (textElement.nodeType === Node.TEXT_NODE) {
                        textElement = textElement.parentElement;
                    }

                    // 向上查找 mi-note-text 元素
                    while (textElement && !textElement.classList.contains('mi-note-text')) {
                        textElement = textElement.parentElement;
                    }

                    if (textElement && textElement.classList.contains('mi-note-text')) {
                        // 在文本元素中应用标题格式
                        if (level === 0) {
                            // 清除标题格式：移除所有标题 span
                            const titleSpans = textElement.querySelectorAll('.mi-note-size, .mi-note-mid-size, .mi-note-h3-size');
                            titleSpans.forEach(span => {
                                const parent = span.parentNode;
                                while (span.firstChild) {
                                    parent.insertBefore(span.firstChild, span);
                                }
                                parent.removeChild(span);
                            });
                        } else {
                            // 应用标题格式
                            let className = '';
                            if (level === 1) {
                                className = 'mi-note-size'; // 大标题 <size>
                            } else if (level === 2) {
                                className = 'mi-note-mid-size'; // 二级标题 <mid-size>
                            } else if (level === 3) {
                                className = 'mi-note-h3-size'; // 三级标题 <h3-size>
                            }

                            if (className && !range.collapsed) {
                                // 有选中文本，包装选中文本
                                const selectedText = range.toString();
                                const titleSpan = document.createElement('span');
                                titleSpan.className = className;
                                titleSpan.textContent = selectedText;
                                range.deleteContents();
                                range.insertNode(titleSpan);
                            } else if (className) {
                                // 光标位置，在文本元素开头插入标题 span
                                const titleSpan = document.createElement('span');
                                titleSpan.className = className;
                                titleSpan.innerHTML = '\u200B';
                                textElement.insertBefore(titleSpan, textElement.firstChild);
                                
                                // 移动光标到标题 span 内
                                range.setStart(titleSpan, 0);
                                range.collapse(true);
                                selection.removeAllRanges();
                                selection.addRange(range);
                            }
                        }
                    } else {
                        // 如果没有文本元素，创建新的文本元素并应用标题格式
                        const editor = document.getElementById('editor-content');
                        const textDiv = document.createElement('div');
                        textDiv.className = 'mi-note-text indent-1';
                        
                        if (level > 0) {
                            let className = '';
                            if (level === 1) {
                                className = 'mi-note-size';
                            } else if (level === 2) {
                                className = 'mi-note-mid-size';
                            } else if (level === 3) {
                                className = 'mi-note-h3-size';
                            }
                            
                            if (className) {
                                const titleSpan = document.createElement('span');
                                titleSpan.className = className;
                                titleSpan.innerHTML = '\u200B';
                                textDiv.appendChild(titleSpan);
                            } else {
                                textDiv.innerHTML = '\u200B';
                            }
                        } else {
                            textDiv.innerHTML = '\u200B';
                        }

                        if (range.collapsed) {
                            range.insertNode(textDiv);
                            range.setStart(textDiv, 0);
                            range.collapse(true);
                        } else {
                            range.deleteContents();
                            range.insertNode(textDiv);
                            range.setStart(textDiv, 0);
                            range.collapse(true);
                        }
                        
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }

                    notifyContentChanged();
                    return '标题格式已应用';
                } catch (error) {
                    console.error('[applyHeading] 应用标题格式失败:', error);
                    return '应用标题格式失败: ' + error.message;
                }
            },

            /**
             * 应用对齐方式
             * @param {string} alignment - 对齐方式 (left, center, right)
             * @returns {string} 状态信息
             */
            applyAlignment: function(alignment) {
                const selection = window.getSelection();
                if (!selection.rangeCount) {
                    return '没有选中文本';
                }

                const range = selection.getRangeAt(0);
                
                // 查找包含选中文本的文本元素
                let textElement = range.commonAncestorContainer;
                if (textElement.nodeType === Node.TEXT_NODE) {
                    textElement = textElement.parentElement;
                }

                // 向上查找 mi-note-text 元素
                while (textElement && !textElement.classList.contains('mi-note-text')) {
                    textElement = textElement.parentElement;
                }

                if (!textElement || !textElement.classList.contains('mi-note-text')) {
                    return '请选中文本元素';
                }

                try {
                    // 移除现有的对齐类
                    textElement.classList.remove('center', 'right');
                    
                    // 应用新的对齐方式
                    if (alignment === 'center') {
                        textElement.classList.add('center');
                    } else if (alignment === 'right') {
                        textElement.classList.add('right');
                    }

                    notifyContentChanged();
                    return '对齐方式已应用: ' + alignment;
                } catch (error) {
                    console.error('[applyAlignment] 应用对齐方式失败:', error);
                    return '应用对齐方式失败: ' + error.message;
                }
            },

            /**
             * 插入无序列表
             * @returns {string} 状态信息
             */
            insertBulletList: function() {
                const editor = document.getElementById('editor-content');
                if (!editor) {
                    return '编辑器元素不存在';
                }

                const selection = window.getSelection();
                let range = null;

                if (selection.rangeCount > 0) {
                    range = selection.getRangeAt(0);
                } else {
                    range = document.createRange();
                    if (editor.childNodes.length === 0 || 
                        (editor.childNodes.length === 1 && editor.childNodes[0].classList && 
                         editor.childNodes[0].classList.contains('placeholder'))) {
                        editor.innerHTML = '';
                    }
                    range.selectNodeContents(editor);
                    range.collapse(false);
                }

                // 创建无序列表元素
                const bulletDiv = document.createElement('div');
                bulletDiv.className = 'mi-note-bullet';
                bulletDiv.style.paddingLeft = '0px'; // indent 1
                bulletDiv.innerHTML = '\u200B';

                // 插入元素
                range.insertNode(bulletDiv);

                // 移动光标到列表项后
                range.setStartAfter(bulletDiv);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);

                notifyContentChanged();
                return '无序列表已插入';
            },

            /**
             * 插入有序列表
             * @returns {string} 状态信息
             */
            insertOrderList: function() {
                const editor = document.getElementById('editor-content');
                if (!editor) {
                    return '编辑器元素不存在';
                }

                const selection = window.getSelection();
                let range = null;

                if (selection.rangeCount > 0) {
                    range = selection.getRangeAt(0);
                } else {
                    range = document.createRange();
                    if (editor.childNodes.length === 0 || 
                        (editor.childNodes.length === 1 && editor.childNodes[0].classList && 
                         editor.childNodes[0].classList.contains('placeholder'))) {
                        editor.innerHTML = '';
                    }
                    range.selectNodeContents(editor);
                    range.collapse(false);
                }

                // 创建有序列表元素
                const orderDiv = document.createElement('div');
                orderDiv.className = 'mi-note-order';
                orderDiv.setAttribute('data-number', '1');
                orderDiv.style.paddingLeft = '0px'; // indent 1
                orderDiv.innerHTML = '\u200B';

                // 插入元素
                range.insertNode(orderDiv);

                // 移动光标到列表项后
                range.setStartAfter(orderDiv);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);

                notifyContentChanged();
                return '有序列表已插入';
            },

            /**
             * 插入引用块
             * @returns {string} 状态信息
             */
            insertQuote: function() {
                const editor = document.getElementById('editor-content');
                if (!editor) {
                    return '编辑器元素不存在';
                }

                const selection = window.getSelection();
                let range = null;

                if (selection.rangeCount > 0) {
                    range = selection.getRangeAt(0);
                } else {
                    range = document.createRange();
                    if (editor.childNodes.length === 0 || 
                        (editor.childNodes.length === 1 && editor.childNodes[0].classList && 
                         editor.childNodes[0].classList.contains('placeholder'))) {
                        editor.innerHTML = '';
                    }
                    range.selectNodeContents(editor);
                    range.collapse(false);
                }

                // 创建引用块元素
                const quoteDiv = document.createElement('div');
                quoteDiv.className = 'mi-note-quote';

                // 创建引用块内的文本元素
                const textDiv = document.createElement('div');
                textDiv.className = 'mi-note-text indent-1';
                textDiv.innerHTML = '\u200B';
                quoteDiv.appendChild(textDiv);

                // 插入元素
                range.insertNode(quoteDiv);

                // 移动光标到引用块内
                range.selectNodeContents(textDiv);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);

                notifyContentChanged();
                return '引用块已插入';
            },

            /**
             * 插入复选框
             * @returns {string} 状态信息
             */
            insertCheckbox: function() {
            const editor = document.getElementById('editor-content');
                if (!editor) {
                    return '编辑器元素不存在';
                }

            const selection = window.getSelection();
                let range = null;

                if (selection.rangeCount > 0) {
                    range = selection.getRangeAt(0);
                        } else {
                    range = document.createRange();
                    // 如果编辑器为空，直接添加到末尾
                    if (editor.childNodes.length === 0 || 
                        (editor.childNodes.length === 1 && editor.childNodes[0].classList && 
                         editor.childNodes[0].classList.contains('placeholder'))) {
                        // 清空占位符
                        editor.innerHTML = '';
                    }
                    range.selectNodeContents(editor);
                    range.collapse(false);
                }

                // 创建复选框元素
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'mi-note-checkbox';
                checkboxDiv.setAttribute('data-level', '3');
                checkboxDiv.style.paddingLeft = '0px'; // indent 1

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkboxDiv.appendChild(checkbox);

                const span = document.createElement('span');
                span.innerHTML = '\u200B'; // 零宽度空格，确保光标可见
                checkboxDiv.appendChild(span);

                // 插入元素
                range.insertNode(checkboxDiv);

                // 移动光标到复选框后
                range.setStartAfter(span);
                        range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                // 通知内容变化
                    notifyContentChanged();
                return '复选框已插入';
            },

            /**
             * 插入分割线
             * @returns {string} 状态信息
             */
            insertHorizontalRule: function() {
            const editor = document.getElementById('editor-content');
                if (!editor) {
                    return '编辑器元素不存在';
                }

                const selection = window.getSelection();
                let range = null;
                
                if (selection.rangeCount > 0) {
                    range = selection.getRangeAt(0);
                        } else {
                    range = document.createRange();
                    // 如果编辑器为空，直接添加到末尾
                    if (editor.childNodes.length === 0 || 
                        (editor.childNodes.length === 1 && editor.childNodes[0].classList && 
                         editor.childNodes[0].classList.contains('placeholder'))) {
                        // 清空占位符
                        editor.innerHTML = '';
                    }
                    range.selectNodeContents(editor);
                    range.collapse(false);
                }

                // 创建分割线元素
                const hr = document.createElement('hr');
                hr.className = 'mi-note-hr';

                // 插入元素
                range.insertNode(hr);

                // 在分割线后插入换行，确保可以继续输入
                const br = document.createElement('br');
                range.setStartAfter(hr);
                range.insertNode(br);

                // 移动光标到分割线后
                range.setStartAfter(br);
                        range.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(range);
                        
                        // 通知内容变化
                            notifyContentChanged();
                return '分割线已插入';
            },

            /**
             * 插入图片
             * @param {string} imageUrl - 图片 URL
             * @param {string} altText - 替代文本（可选）
             * @returns {string} 状态信息
             */
            insertImage: function(imageUrl, altText) {
                const editor = document.getElementById('editor-content');
                if (!editor) {
                    return '编辑器元素不存在';
                }

                if (!imageUrl) {
                    return '图片 URL 不能为空';
                }

                const selection = window.getSelection();
                let range = null;

                if (selection.rangeCount > 0) {
                    range = selection.getRangeAt(0);
                    } else {
                    range = document.createRange();
                    // 如果编辑器为空，直接添加到末尾
                    if (editor.childNodes.length === 0 || 
                        (editor.childNodes.length === 1 && editor.childNodes[0].classList && 
                         editor.childNodes[0].classList.contains('placeholder'))) {
                        // 清空占位符
                        editor.innerHTML = '';
                    }
                    range.selectNodeContents(editor);
                    range.collapse(false);
                }

                // 创建图片容器
                const container = document.createElement('div');
                container.className = 'mi-note-image-container';

                // 创建图片元素
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = altText || '图片';
                img.className = 'mi-note-image';
                
                // 如果是 data URL，可以在这里处理
                // data URL 格式: data:image/png;base64,...
                if (imageUrl.startsWith('data:')) {
                    // data URL 可以直接使用，不需要额外处理
                    console.log('[insertImage] 插入 data URL 图片');
                } else if (imageUrl.startsWith('minote://')) {
                    // 小米笔记的图片 URL 格式
                    console.log('[insertImage] 插入小米笔记图片:', imageUrl);
                }

                container.appendChild(img);

                // 插入元素
                range.insertNode(container);

                // 在图片后插入换行，确保可以继续输入
                const br = document.createElement('br');
                range.setStartAfter(container);
                range.insertNode(br);

                // 移动光标到图片后
                range.setStartAfter(br);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    // 通知内容变化
                        notifyContentChanged();
                return '图片已插入';
            }
        };

        // ==================== 回车键处理 ====================
        /**
         * 处理回车键事件
         * @param {KeyboardEvent} e - 键盘事件
         */
        function handleEnterKey(e) {
            const editor = document.getElementById('editor-content');
            if (!editor) return;
            
            const selection = window.getSelection();
            if (!selection.rangeCount) {
                return;
            }

            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer;
            
            // 查找当前所在的元素
            let currentNode = container;
            if (container.nodeType === Node.TEXT_NODE) {
                currentNode = container.parentElement;
            } else if (container.nodeType === Node.ELEMENT_NODE) {
                currentNode = container;
            }

            // 向上查找 checkbox、bullet 或 order 元素
            let checkboxElement = null;
            let bulletElement = null;
            let orderElement = null;
            let current = currentNode;
            
            while (current && current !== editor) {
                if (current.classList && current.classList.contains('mi-note-checkbox')) {
                    checkboxElement = current;
                    break;
                }
                if (current.classList && current.classList.contains('mi-note-bullet')) {
                    bulletElement = current;
                    break;
                }
                if (current.classList && current.classList.contains('mi-note-order')) {
                    orderElement = current;
                    break;
                }
                current = current.parentElement;
            }

            // 处理 checkbox 回车
            if (checkboxElement) {
                                    e.preventDefault();
                createNewCheckbox(checkboxElement);
                return;
            }

            // 处理无序列表回车
            if (bulletElement) {
                e.preventDefault();
                createNewBullet(bulletElement);
                                    return;
            }

            // 处理有序列表回车
            if (orderElement) {
                e.preventDefault();
                createNewOrder(orderElement);
                return;
            }
        }

        /**
         * 创建新的 checkbox
         * @param {HTMLElement} currentCheckbox - 当前的 checkbox 元素
         */
        function createNewCheckbox(currentCheckbox) {
            const editor = document.getElementById('editor-content');
            if (!editor) return;
            
            const indent = getIndentFromElement(currentCheckbox);
            const level = currentCheckbox.getAttribute('data-level') || '3';

            // 创建新的 checkbox
            const newCheckbox = document.createElement('div');
            newCheckbox.className = 'mi-note-checkbox';
            newCheckbox.setAttribute('data-level', level);
            newCheckbox.style.paddingLeft = currentCheckbox.style.paddingLeft || '0px';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            newCheckbox.appendChild(checkbox);

            const span = document.createElement('span');
            span.innerHTML = '\u200B';
            newCheckbox.appendChild(span);

            // 插入到当前 checkbox 之后
            if (currentCheckbox.nextSibling) {
                editor.insertBefore(newCheckbox, currentCheckbox.nextSibling);
                } else {
                editor.appendChild(newCheckbox);
            }

            // 设置光标到新 checkbox
            const selection = window.getSelection();
                        const range = document.createRange();
            range.selectNodeContents(span);
                        range.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(range);

            notifyContentChanged();
        }

        /**
         * 创建新的无序列表项
         * @param {HTMLElement} currentBullet - 当前的无序列表项
         */
        function createNewBullet(currentBullet) {
            const editor = document.getElementById('editor-content');
            if (!editor) return;
            
            const indent = getIndentFromElement(currentBullet);

            // 创建新的 bullet
            const newBullet = document.createElement('div');
            newBullet.className = 'mi-note-bullet';
            newBullet.style.paddingLeft = currentBullet.style.paddingLeft || '0px';
            newBullet.innerHTML = '\u200B';

            // 插入到当前 bullet 之后
            if (currentBullet.nextSibling) {
                editor.insertBefore(newBullet, currentBullet.nextSibling);
                            } else {
                editor.appendChild(newBullet);
            }

            // 设置光标到新 bullet
            const selection = window.getSelection();
                        const range = document.createRange();
            range.selectNodeContents(newBullet);
                        range.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(range);

            notifyContentChanged();
        }

        /**
         * 创建新的有序列表项
         * @param {HTMLElement} currentOrder - 当前的有序列表项
         */
        function createNewOrder(currentOrder) {
            const editor = document.getElementById('editor-content');
            if (!editor) return;
            
            const indent = getIndentFromElement(currentOrder);
            const currentNumber = parseInt(currentOrder.getAttribute('data-number') || '1', 10);
            const nextNumber = currentNumber + 1;

            // 创建新的 order
            const newOrder = document.createElement('div');
            newOrder.className = 'mi-note-order';
            newOrder.setAttribute('data-number', nextNumber.toString());
            newOrder.style.paddingLeft = currentOrder.style.paddingLeft || '0px';
            newOrder.innerHTML = '\u200B';

            // 插入到当前 order 之后
            if (currentOrder.nextSibling) {
                editor.insertBefore(newOrder, currentOrder.nextSibling);
                } else {
                editor.appendChild(newOrder);
            }

            // 设置光标到新 order
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(newOrder);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            
            notifyContentChanged();
        }

        /**
         * 从元素获取缩进级别
         * @param {HTMLElement} element - 元素
         * @returns {string} 缩进级别
         */
        function getIndentFromElement(element) {
            const style = element.getAttribute('style') || '';
            const match = style.match(/padding-left:\s*(\d+)px/);
            if (match) {
                const paddingLeft = parseInt(match[1], 10);
                const indent = Math.floor(paddingLeft / 20) + 1;
                return indent.toString();
            }
            return '1';
        }

        // ==================== 格式状态同步 ====================
        /**
         * 同步格式状态到 Swift（用于更新格式菜单）
         */
        function syncFormatState() {
            const selection = window.getSelection();
            if (!selection.rangeCount) {
                return;
            }

            const range = selection.getRangeAt(0);
            
            // 检查各种格式状态
            const formatState = {
                isBold: window.MiNoteWebEditor.checkFormatState(range, 'bold'),
                isItalic: window.MiNoteWebEditor.checkFormatState(range, 'italic'),
                isUnderline: window.MiNoteWebEditor.checkFormatState(range, 'underline'),
                isStrikethrough: window.MiNoteWebEditor.checkFormatState(range, 'strikethrough'),
                isHighlighted: window.MiNoteWebEditor.checkFormatState(range, 'highlight')
            };

            // 通知 Swift 更新格式状态
            if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.editorBridge) {
                window.webkit.messageHandlers.editorBridge.postMessage({
                    type: 'formatStateChanged',
                    formatState: formatState
                });
            }
        }

        // ==================== 内容变化通知 ====================
        /**
         * 通知内容已变化
         */
        function notifyContentChanged() {
            if (isLoadingContent || !isInitialized) {
                return;
            }

            const xmlContent = window.MiNoteWebEditor.getContent();
            
            // 更新当前内容
            if (currentContent !== xmlContent) {
                currentContent = xmlContent;
                
                // 通知 Swift
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.editorBridge) {
                    window.webkit.messageHandlers.editorBridge.postMessage({
                        type: 'contentChanged',
                        content: xmlContent
                    });
                }
            }
            
            // 同步格式状态
            syncFormatState();
        }

        // ==================== 日志重定向 ====================
        // 重写 console 方法以发送日志到 Swift
        (function() {
            const originalLog = console.log;
            const originalWarn = console.warn;
            const originalError = console.error;

            function createLogSender(level, original) {
                return function(...args) {
                    original.apply(console, args);
                    const message = args.map(arg => {
                        if (typeof arg === 'object') {
                            try { 
                                return JSON.stringify(arg); 
                            } catch(e) { 
                                return String(arg); 
                            }
                        }
                        return String(arg);
                    }).join(' ');
                    
                    if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.editorBridge) {
                        window.webkit.messageHandlers.editorBridge.postMessage({
                            type: 'log',
                            level: level,
                            message: message
                        });
                    }
                };
            }

            console.log = createLogSender('log', originalLog);
            console.warn = createLogSender('warn', originalWarn);
            console.error = createLogSender('error', originalError);
        })();
    </script>
</body>
</html>
