# 下一阶段优化计划

## 当前状态总结

### 已完成 ✅
1. **DOMWriter 基础架构**：统一 DOM 操作接口
2. **撤销/重做功能**：操作历史记录和回滚
3. **批量操作支持**：减少重绘和性能优化
4. **内容同步优化**：精确比较和避免不必要重新加载

### 进行中 ⏳
1. **迁移 DOM 操作到 DOMWriter**：部分完成
2. **优化 execCommand 操作**：需要特殊处理

## 下一阶段目标

### 优先级 1：完善 execCommand 操作的历史记录

**问题**：
- `execCommand` 是浏览器原生 API，不能直接包装
- 当前这些操作没有记录到历史中，无法撤销/重做

**解决方案**：
- 在 `execCommand` 调用前后使用 DOMWriter 记录状态
- 创建一个包装函数 `executeCommandWithHistory`

**实施步骤**：
1. 创建 `executeCommandWithHistory` 方法
2. 在 `applyFormat` 中使用该方法包装所有 `execCommand` 调用
3. 测试撤销/重做功能

### 优先级 2：迁移列表插入操作

**目标操作**：
- `insertBulletList`
- `insertOrderList`
- `insertCheckbox`

**实施步骤**：
1. 识别这些函数中的直接 DOM 操作
2. 使用 DOMWriter 的批量操作模式包装
3. 确保操作记录到历史中
4. 测试功能完整性

### 优先级 3：迁移标题和对齐操作

**目标操作**：
- `applyHeading`
- `applyAlignment`

**实施步骤**：
1. 识别直接 DOM 操作
2. 使用 DOMWriter 包装
3. 测试功能

### 优先级 4：优化内容同步（增量更新）

**目标**：
- 实现增量 DOM 更新，而不是完全重新加载
- 减少性能开销

**实施步骤**：
1. 实现 DOM diff 算法
2. 只更新变化的部分
3. 保持光标位置

## 实施顺序

1. **第一步**：完善 execCommand 操作的历史记录（优先级 1）✅ **已完成**
   - ✅ 创建 `executeCommandWithHistory` 方法
   - ✅ 替换所有 `execCommand` 调用
   - ✅ 所有格式操作现在都支持撤销/重做

2. **第二步**：迁移列表插入操作（优先级 2）⏳ **进行中**
3. **第三步**：迁移标题和对齐操作（优先级 3）⏳ **待实施**
4. **第四步**：优化内容同步（优先级 4）⏳ **待实施**

## 预期效果

1. **所有操作都支持撤销/重做**
2. **代码更统一和可维护**
3. **性能进一步提升**
4. **更好的用户体验**

