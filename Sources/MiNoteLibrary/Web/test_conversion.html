<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>小米笔记转换逻辑测试</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; }
        .test-case { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h1>小米笔记XML/HTML转换逻辑测试</h1>
    
    <div id="test-results"></div>
    
    <script>
        // 从editor.html复制关键函数
        function processRichTextTags(content) {
            // 替换小米笔记标签为标准HTML标签
            content = content.replace(/<b>/g, '<b>').replace(/<\/b>/g, '</b>');
            content = content.replace(/<i>/g, '<i>').replace(/<\/i>/g, '</i>');
            content = content.replace(/<u>/g, '<u>').replace(/<\/u>/g, '</u>');
            content = content.replace(/<delete>/g, '<delete>').replace(/<\/delete>/g, '</delete>');
            
            // 处理标题标签（根据小米笔记格式示例）
            content = content.replace(/<size>/g, '<span class="size-large">').replace(/<\/size>/g, '</span>');
            content = content.replace(/<mid-size>/g, '<span class="size-mid">').replace(/<\/mid-size>/g, '</span>');
            content = content.replace(/<h3-size>/g, '<span class="size-h3">').replace(/<\/h3-size>/g, '</span>');
            
            // 处理对齐标签
            content = content.replace(/<center>/g, '<span style="text-align: center; display: block;">').replace(/<\/center>/g, '</span>');
            content = content.replace(/<right>/g, '<span style="text-align: right; display: block;">').replace(/<\/right>/g, '</span>');
            
            return content;
        }
        
        function parseTextElement(line) {
            const indentMatch = line.match(/indent="(\d+)"/);
            const indent = indentMatch ? parseInt(indentMatch[1]) : 1;
            
            const contentStart = line.indexOf('>') + 1;
            const contentEnd = line.lastIndexOf('<');
            let content = line.substring(contentStart, contentEnd);
            
            let alignClass = '';
            if (content.includes('<center>')) {
                alignClass = 'center';
            } else if (content.includes('<right>')) {
                alignClass = 'right';
            }
            
            content = processRichTextTags(content);
            
            let className = `mi-note-text indent-${indent}`;
            if (alignClass) {
                className += ` ${alignClass}`;
            }
            
            return `<div class="${className}">${content}</div>`;
        }
        
        function parseBulletElement(line) {
            const indentMatch = line.match(/indent="(\d+)"/);
            const indent = indentMatch ? parseInt(indentMatch[1]) : 1;
            
            const contentStart = line.indexOf('>') + 1;
            const contentEnd = line.lastIndexOf('<');
            let content = line.substring(contentStart, contentEnd);
            
            content = processRichTextTags(content);
            
            return `<div class="mi-note-bullet indent-${indent}">${content}</div>`;
        }
        
        function parseOrderElement(line, currentNumber) {
            const indentMatch = line.match(/indent="(\d+)"/);
            const inputNumberMatch = line.match(/inputNumber="(\d+)"/);
            const indent = indentMatch ? parseInt(indentMatch[1]) : 1;
            const inputNumber = inputNumberMatch ? parseInt(inputNumberMatch[1]) : 0;
            
            const contentStart = line.indexOf('>') + 1;
            const contentEnd = line.lastIndexOf('<');
            let content = line.substring(contentStart, contentEnd);
            
            content = processRichTextTags(content);
            
            let displayNumber;
            let nextNumber;
            
            if (inputNumber === 0) {
                // 后续行：使用当前计数器值
                displayNumber = currentNumber;
                nextNumber = currentNumber + 1;
            } else {
                // 第一行：使用指定的inputNumber，重置计数器
                displayNumber = inputNumber;
                nextNumber = inputNumber + 1;
            }
            
            const html = `<div class="mi-note-order indent-${indent}" data-number="${displayNumber}">${content}</div>`;
            
            return {
                html: html,
                nextNumber: nextNumber
            };
        }
        
        function parseCheckboxElement(line) {
            const checkedMatch = line.match(/checked="(\w+)"/);
            const indentMatch = line.match(/indent="(\d+)"/);
            const levelMatch = line.match(/level="(\d+)"/);
            
            const checked = checkedMatch ? (checkedMatch[1] === 'true') : false;
            const indent = indentMatch ? parseInt(indentMatch[1]) : 1;
            const level = levelMatch ? parseInt(levelMatch[1]) : 3;
            
            const contentStart = line.indexOf('>') + 1;
            const contentEnd = line.lastIndexOf('<');
            let content = line.substring(contentStart, contentEnd);
            
            content = processRichTextTags(content);
            
            const checkedAttr = checked ? 'checked' : '';
            return `<div class="mi-note-checkbox indent-${indent}"><input type="checkbox" ${checkedAttr}>${content}</div>`;
        }
        
        function parseHRElement(line) {
            return '<hr class="mi-note-hr">';
        }
        
        function parseQuoteElement(line) {
            const contentStart = line.indexOf('>') + 1;
            const contentEnd = line.lastIndexOf('<');
            let content = line.substring(contentStart, contentEnd);
            
            content = processRichTextTags(content);
            
            return `<blockquote class="mi-note-quote">${content}</blockquote>`;
        }
        
        // 测试用例
        const testCases = [
            {
                name: "普通文本",
                xml: '<text indent="1">测试文本</text>',
                expectedClass: 'mi-note-text indent-1'
            },
            {
                name: "大标题",
                xml: '<text indent="1"><size>大标题</size></text>',
                expectedContains: 'size-large'
            },
            {
                name: "二级标题",
                xml: '<text indent="1"><mid-size>二级标题</mid-size></text>',
                expectedContains: 'size-mid'
            },
            {
                name: "三级标题",
                xml: '<text indent="1"><h3-size>三级标题</h3-size></text>',
                expectedContains: 'size-h3'
            },
            {
                name: "加粗文本",
                xml: '<text indent="1"><b>加粗</b></text>',
                expectedContains: '<b>加粗</b>'
            },
            {
                name: "斜体文本",
                xml: '<text indent="1"><i>斜体</i></text>',
                expectedContains: '<i>斜体</i>'
            },
            {
                name: "下划线文本",
                xml: '<text indent="1"><u>下划线</u></text>',
                expectedContains: '<u>下划线</u>'
            },
            {
                name: "删除线文本",
                xml: '<text indent="1"><delete>删除线</delete></text>',
                expectedContains: '<delete>删除线</delete>'
            },
            {
                name: "无序列表",
                xml: '<bullet indent="1">无序列表</bullet>',
                expectedClass: 'mi-note-bullet indent-1'
            },
            {
                name: "有序列表（第一行）",
                xml: '<order indent="1" inputNumber="1">有序列表1</order>',
                expectedContains: 'data-number="1"'
            },
            {
                name: "有序列表（后续行）",
                xml: '<order indent="1" inputNumber="0">有序列表2</order>',
                expectedContains: 'data-number="2"'
            },
            {
                name: "复选框",
                xml: '<input type="checkbox" indent="1" level="3" checked="false">checkbox</input>',
                expectedContains: 'mi-note-checkbox indent-1'
            },
            {
                name: "分割线",
                xml: '<hr/>',
                expectedContains: 'mi-note-hr'
            },
            {
                name: "引用块",
                xml: '<quote><text indent="1">引用1</text></quote>',
                expectedContains: 'mi-note-quote'
            },
            {
                name: "居中对齐",
                xml: '<text indent="1"><center>居中</center></text>',
                expectedContains: 'center'
            },
            {
                name: "右侧对齐",
                xml: '<text indent="1"><right>居右</right></text>',
                expectedContains: 'right'
            },
            {
                name: "缩进文本",
                xml: '<text indent="2">缩进</text>',
                expectedClass: 'mi-note-text indent-2'
            }
        ];
        
        // 运行测试
        function runTests() {
            const resultsDiv = document.getElementById('test-results');
            let passed = 0;
            let failed = 0;
            let orderCounter = 1; // 全局有序列表计数器
            
            testCases.forEach((testCase, index) => {
                const testDiv = document.createElement('div');
                testDiv.className = 'test-case';
                
                let resultHTML = '';
                let htmlResult = '';
                
                try {
                    if (testCase.xml.startsWith('<text')) {
                        htmlResult = parseTextElement(testCase.xml);
                    } else if (testCase.xml.startsWith('<bullet')) {
                        htmlResult = parseBulletElement(testCase.xml);
                    } else if (testCase.xml.startsWith('<order')) {
                        const result = parseOrderElement(testCase.xml, orderCounter);
                        htmlResult = result.html;
                        orderCounter = result.nextNumber;
                    } else if (testCase.xml.startsWith('<input')) {
                        htmlResult = parseCheckboxElement(testCase.xml);
                    } else if (testCase.xml.startsWith('<hr')) {
                        htmlResult = parseHRElement(testCase.xml);
                    } else if (testCase.xml.startsWith('<quote')) {
                        htmlResult = parseQuoteElement(testCase.xml);
                    }
                    
                    let passedTest = false;
                    
                    if (testCase.expectedClass) {
                        passedTest = htmlResult.includes(`class="${testCase.expectedClass}"`) || 
                                    htmlResult.includes(`class="${testCase.expectedClass} `);
                    } else if (testCase.expectedContains) {
                        passedTest = htmlResult.includes(testCase.expectedContains);
                    }
                    
                    if (passedTest) {
                        passed++;
                        resultHTML = `<div class="success">✓ ${testCase.name} 通过</div>`;
                    } else {
                        failed++;
                        resultHTML = `<div class="error">✗ ${testCase.name} 失败</div>`;
                    }
                    
                    resultHTML += `<div><strong>XML输入:</strong> <pre>${testCase.xml}</pre></div>`;
                    resultHTML += `<div><strong>HTML输出:</strong> <pre>${htmlResult}</pre></div>`;
                    
                    if (!passedTest) {
                        if (testCase.expectedClass) {
                            resultHTML += `<div><strong>期望包含:</strong> class="${testCase.expectedClass}"</div>`;
                        } else if (testCase.expectedContains) {
                            resultHTML += `<div><strong>期望包含:</strong> ${testCase.expectedContains}</div>`;
                        }
                    }
                    
                } catch (error) {
                    failed++;
                    resultHTML = `<div class="error">✗ ${testCase.name} 错误: ${error.message}</div>`;
                    resultHTML += `<div><strong>XML输入:</strong> <pre>${testCase.xml}</pre></div>`;
                }
                
                testDiv.innerHTML = resultHTML;
                resultsDiv.appendChild(testDiv);
            });
            
            // 显示总结
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'test-case';
            summaryDiv.style.backgroundColor = failed === 0 ? '#d4edda' : '#f8d7da';
            summaryDiv.innerHTML = `
                <h3>测试总结</h3>
                <p>总共: ${testCases.length} 个测试用例</p>
                <p class="${passed === testCases.length ? 'success' : 'error'}">通过: ${passed}</p>
                <p class="${failed === 0 ? 'success' : 'error'}">失败: ${failed}</p>
                <p>通过率: ${((passed / testCases.length) * 100).toFixed(1)}%</p>
            `;
            
            resultsDiv.appendChild(summaryDiv);
        }
        
        // 页面加载完成后运行测试
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
