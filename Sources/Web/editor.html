<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>小米笔记编辑器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* 浅色模式颜色变量 */
        :root {
            --bg-color: #fff;
            --text-color: #333;
            --bullet-color: #666;
            --quote-border: #ccc;
            --quote-text: #666;
            --hr-color: #ddd;
            --placeholder-color: #999;
            
            /* 编辑器显示设置 */
            --editor-font-size: 14px;
            --editor-line-height: 1.5;
        }
        
        /* 深色模式颜色变量 */
        html[data-color-scheme="dark"],
        :root[data-color-scheme="dark"] {
            --bg-color: #1e1e1e;
            --text-color: #d4d4d4;
            --bullet-color: #858585;
            --quote-border: #5a5a5a;
            --quote-text: #858585;
            --hr-color: #3e3e42;
            --placeholder-color: #6a6a6a;
            }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: var(--editor-font-size);
            line-height: var(--editor-line-height);
            color: var(--text-color);
            background-color: var(--bg-color);
            padding: 0;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.2s ease, color 0.2s ease, font-size 0.2s ease, line-height 0.2s ease;
        }
        
        #editor-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #editor-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            outline: none;
            min-height: 200px;
            color: var(--text-color);
            background-color: var(--bg-color);
            font-size: var(--editor-font-size);
            line-height: var(--editor-line-height);
            transition: background-color 0.2s ease, color 0.2s ease, font-size 0.2s ease, line-height 0.2s ease;
        }
        
        /* 小米笔记样式 */
        .mi-note-highlight {
            background-color: rgba(154, 255, 232, 0.69); /* #9affe8af */
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .mi-note-text {
            margin-bottom: 8px;
            padding-left: 0;
            font-size: var(--editor-font-size);
            line-height: var(--editor-line-height);
        }
        
        .mi-note-text.indent-1 { padding-left: 0; }
        .mi-note-text.indent-2 { padding-left: 20px; }
        .mi-note-text.indent-3 { padding-left: 40px; }
        .mi-note-text.indent-4 { padding-left: 60px; }
        .mi-note-text.indent-5 { padding-left: 80px; }
        
        .mi-note-bullet, .mi-note-order, .mi-note-checkbox {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            position: relative;
            font-size: var(--editor-font-size);
            line-height: var(--editor-line-height);
        }
        
        .mi-note-bullet::before {
            content: "•";
            margin-right: 8px;
            color: var(--bullet-color);
            flex-shrink: 0;
        }
        
        .mi-note-order::before {
            content: attr(data-number) ".";
            margin-right: 8px;
            color: var(--bullet-color);
            min-width: 20px;
            text-align: right;
            flex-shrink: 0;
        }
        
        .mi-note-order:empty,
        .mi-note-bullet:empty {
            min-height: 1.5em;
        }
        
        /* 零宽度空格用于保持光标可见，但不应该显示出来 */
        .mi-note-order,
        .mi-note-bullet,
        .mi-note-checkbox span {
            white-space: pre-wrap;
        }
        
        /* 确保零宽度空格不可见 */
        .mi-note-order *,
        .mi-note-bullet *,
        .mi-note-checkbox span * {
            font-size: inherit;
        }
        
        .mi-note-checkbox {
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .mi-note-checkbox input[type="checkbox"] {
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .mi-note-checkbox > *:not(input[type="checkbox"]) {
            flex: 1;
            min-width: 0;
        }
        
        .mi-note-hr {
            height: 1px;
            background-color: var(--hr-color);
            margin: 16px 0;
            border: none;
            transition: background-color 0.2s ease;
        }
        
        .mi-note-quote {
            border-left: 3px solid var(--quote-border);
            padding-left: 12px;
            margin: 8px 0;
            color: var(--quote-text);
            transition: border-color 0.2s ease, color 0.2s ease;
        }
        
        .mi-note-text.center {
            text-align: center;
        }
        
        .mi-note-text.right {
            text-align: right;
        }
        
        /* 富文本样式 */
        .mi-note-text b, .mi-note-text strong {
            font-weight: bold;
        }
        
        .mi-note-text i, .mi-note-text em {
            font-style: italic;
        }
        
        .mi-note-text u {
            text-decoration: underline;
        }
        
        .mi-note-text s, .mi-note-text del {
            text-decoration: line-through;
        }
        
        .mi-note-text .mi-note-size {
            font-size: calc(var(--editor-font-size) * 1.714); /* 24px when base is 14px */
            font-weight: bold;
        }
        
        .mi-note-text .mi-note-mid-size {
            font-size: calc(var(--editor-font-size) * 1.429); /* 20px when base is 14px */
            font-weight: bold;
        }
        
        .mi-note-text .mi-note-h3-size {
            font-size: calc(var(--editor-font-size) * 1.286); /* 18px when base is 14px */
            font-weight: bold;
        }
        
        /* 图片样式 */
        .mi-note-image {
            max-width: 100%;
            height: auto;
            margin: 8px 0;
        }
        
        .mi-note-image-container {
            margin: 8px 0;
        }
        
        /* 语音文件样式 */
        .mi-note-sound-container {
            margin: 8px 0;
        }
        
        .mi-note-sound {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background-color: var(--bg-color);
            border: 1px solid var(--quote-border);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        
        .mi-note-sound:hover {
            background-color: var(--hr-color);
        }
        
        .mi-note-sound-icon {
            font-size: 20px;
            margin-right: 8px;
        }
        
        .mi-note-sound-label {
            font-size: var(--editor-font-size);
            color: var(--text-color);
        }
        
        /* 语音播放状态样式 */
        .mi-note-sound.playing {
            background-color: rgba(52, 199, 89, 0.2);
            border-color: rgba(52, 199, 89, 0.5);
        }
        
        .mi-note-sound.loading {
            background-color: rgba(255, 204, 0, 0.2);
            border-color: rgba(255, 204, 0, 0.5);
        }
        
        .mi-note-sound.error {
            background-color: rgba(255, 59, 48, 0.2);
            border-color: rgba(255, 59, 48, 0.5);
        }
        
        /* 录音模板样式 */
        .mi-note-recording-template {
            margin: 8px 0;
            padding: 8px 12px;
            background-color: #f5f5f5;
            border: 1px dashed #ccc;
            border-radius: 4px;
            cursor: default;
        }
        
        /* 深色模式下的录音模板样式 */
        html[data-color-scheme="dark"] .mi-note-recording-template,
        :root[data-color-scheme="dark"] .mi-note-recording-template {
            background-color: #2a2a2a;
            border-color: #555;
        }
        
        .mi-note-recording-icon {
            font-size: 16px;
            animation: pulse 1.5s infinite;
        }
        
        .mi-note-recording-label {
            color: #666;
            font-size: 14px;
        }
        
        /* 深色模式下的录音标签颜色 */
        html[data-color-scheme="dark"] .mi-note-recording-label,
        :root[data-color-scheme="dark"] .mi-note-recording-label {
            color: #999;
        }
        
        /* 脉冲动画 */
        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* 深色模式下的播放状态样式 */
        html[data-color-scheme="dark"] .mi-note-sound.playing,
        :root[data-color-scheme="dark"] .mi-note-sound.playing {
            background-color: rgba(52, 199, 89, 0.3);
            border-color: rgba(52, 199, 89, 0.6);
        }
        
        html[data-color-scheme="dark"] .mi-note-sound.loading,
        :root[data-color-scheme="dark"] .mi-note-sound.loading {
            background-color: rgba(255, 204, 0, 0.3);
            border-color: rgba(255, 204, 0, 0.6);
        }
        
        html[data-color-scheme="dark"] .mi-note-sound.error,
        :root[data-color-scheme="dark"] .mi-note-sound.error {
            background-color: rgba(255, 59, 48, 0.3);
            border-color: rgba(255, 59, 48, 0.6);
        }
        
        /* 占位符 */
        .placeholder {
            color: var(--placeholder-color);
        }
        
        /* 确保所有文本元素使用正确的颜色 */
        .mi-note-text,
        .mi-note-bullet,
        .mi-note-order,
        .mi-note-checkbox {
            color: var(--text-color);
        }
        
        /* 焦点样式 */
        #editor-content:focus {
            outline: none;
        }
    </style>
</head>
<body>
    <div id="editor-container">
        <div id="editor-content" contenteditable="true" spellcheck="false" style="white-space: pre-wrap;">
            <!-- 内容将在这里动态加载 -->
        </div>
    </div>

    <!-- 引入格式转换模块 -->
    <script src="xml-to-html.js"></script>
    <script src="html-to-xml.js"></script>

    <!-- ==================== 模块化加载 ==================== -->
    <!-- 按依赖顺序加载模块 -->
    <!-- 注意：构建时文件被扁平化到 Resources 根目录，所以使用文件名而不是路径 -->
    <!-- 注意：xml-to-html.js 和 html-to-xml.js 必须在 converter.js 之前加载 -->
    <script src="logger.js"></script>
    <script src="constants.js"></script>
    <script src="utils.js"></script>
    <script src="xml-to-html.js"></script>
    <script src="html-to-xml.js"></script>
    <script src="command.js"></script>
    <script src="format-commands.js"></script>
    <script src="dom-writer.js"></script>
    <script src="converter.js"></script>
    <script src="cursor.js"></script>
    <!-- 光标管理模块 -->
    <script src="modules/cursor/position.js"></script>
    <script src="modules/cursor/selection.js"></script>
    <script src="modules/cursor/schema.js"></script>
    <script src="modules/cursor/post-fixer.js"></script>
    <script src="modules/cursor/manager.js"></script>
    <script src="modules/cursor/index.js"></script>
    <script src="format.js"></script>
    <script src="enter-handler.js"></script>
    <script src="editor-core.js"></script>
    <script src="editor-api.js"></script>
    <script src="editor-init.js"></script>
    
    <!-- 模块加载错误处理 -->
    <script>
        window.addEventListener('error', function(e) {
            if (e.filename && (e.filename.includes('modules/') || e.filename.endsWith('.js'))) {
                console.error('[Module Load Error]', e.filename, e.lineno, e.message);
                // 可以显示友好的错误提示
            }
        }, true);
    </script>

    <script>
        // ==================== 日志系统 ====================
        // 注意：Logger 已移至 modules/core/logger.js
        // 以下代码保留作为备份，将在所有模块提取完成后删除
        /*
        /**
         * 统一日志系统：分级日志和配置
         * 参考 CKEditor 5 的日志系统设计
         * 
         * 日志级别：
         * - debug: 详细的调试信息，用于开发调试
         * - info: 一般信息，记录正常操作流程
         * - warn: 警告信息，不影响功能但需要注意
         * - error: 错误信息，功能异常或失败
         * 
         * 日志格式：[级别] [模块] 消息 [上下文]
         * 示例：[DEBUG] [Editor] 加载内容完成 {xmlLength: 1234}
         */
        class Logger {
            constructor() {
                this.level = 'info'; // debug, info, warn, error
                this.enabled = true;
                this.levels = {
                    debug: 0,
                    info: 1,
                    warn: 2,
                    error: 3
                };
                this.enabledModules = new Set(); // 空集合表示所有模块都启用
                this.timers = new Map(); // 用于性能计时
                this.logHistory = []; // 日志历史记录（可选，用于调试）
                this.maxHistorySize = 100; // 最大历史记录数
            }
            
            /**
             * 设置日志级别
             * @param {string} level - 日志级别 (debug, info, warn, error)
             */
            setLevel(level) {
                if (this.levels.hasOwnProperty(level)) {
                    const oldLevel = this.level;
                    this.level = level;
                    // 使用原生 console 避免循环调用
                    if (oldLevel !== level) {
                        this._rawLog('info', `[Logger] 日志级别从 ${oldLevel} 更改为 ${level}`);
                    }
                } else {
                    this._rawLog('warn', `[Logger] 无效的日志级别: ${level}，有效值: ${Object.keys(this.levels).join(', ')}`);
                }
            }
            
            /**
             * 启用日志
             */
            enable() {
                if (!this.enabled) {
                    this.enabled = true;
                    this._rawLog('info', '[Logger] 日志已启用');
                }
            }
            
            /**
             * 禁用日志
             */
            disable() {
                if (this.enabled) {
                    this.enabled = false;
                    // 禁用时使用原生 console，因为 logger 已禁用
                    console.info('[Logger] 日志已禁用');
                }
            }
            
            /**
             * 启用特定模块的日志
             * @param {string|string[]} modules - 模块名称或模块名称数组
             */
            enableModules(modules) {
                const moduleArray = Array.isArray(modules) ? modules : [modules];
                moduleArray.forEach(module => {
                    this.enabledModules.add(module);
                });
            }
            
            /**
             * 禁用特定模块的日志
             * @param {string|string[]} modules - 模块名称或模块名称数组
             */
            disableModules(modules) {
                const moduleArray = Array.isArray(modules) ? modules : [modules];
                moduleArray.forEach(module => {
                    this.enabledModules.delete(module);
                });
            }
            
            /**
             * 检查模块是否启用
             * @param {string} module - 模块名称
             * @returns {boolean}
             */
            _isModuleEnabled(module) {
                // 如果 enabledModules 为空，所有模块都启用
                if (this.enabledModules.size === 0) {
                    return true;
                }
                return this.enabledModules.has(module);
            }
            
            /**
             * 格式化日志消息
             * @param {string} level - 日志级别
             * @param {string} module - 模块名称
             * @param {string} message - 消息
             * @param {object} context - 上下文对象（可选）
             * @returns {string}
             */
            _formatMessage(level, module, message, context) {
                const levelUpper = level.toUpperCase();
                const modulePart = module ? `[${module}]` : '';
                let formatted = `[${levelUpper}] ${modulePart} ${message}`;
                
                if (context && Object.keys(context).length > 0) {
                    try {
                        const contextStr = JSON.stringify(context, null, 0);
                        formatted += ` ${contextStr}`;
                    } catch (e) {
                        formatted += ` [上下文序列化失败: ${e.message}]`;
                    }
                }
                
                return formatted;
            }
            
            /**
             * 原始日志输出（避免循环调用）
             * @private
             */
            _rawLog(level, message, ...args) {
                const method = level === 'error' ? 'error' : 
                              level === 'warn' ? 'warn' : 
                              level === 'debug' ? 'debug' : 'info';
                console[method](message, ...args);
            }
            
            /**
             * 记录日志（内部方法）
             * @private
             */
            _log(level, module, message, context, ...args) {
                if (!this.enabled || !this._shouldLog(level) || !this._isModuleEnabled(module)) {
                    return;
                }
                
                const formattedMessage = this._formatMessage(level, module, message, context);
                
                // 根据级别选择输出方法
                const consoleMethod = level === 'error' ? 'error' : 
                                     level === 'warn' ? 'warn' : 
                                     level === 'debug' ? 'debug' : 'info';
                
                console[consoleMethod](formattedMessage, ...args);
                
                // 可选：保存到历史记录
                if (this.logHistory.length >= this.maxHistorySize) {
                    this.logHistory.shift();
                }
                this.logHistory.push({
                    timestamp: new Date().toISOString(),
                    level,
                    module,
                    message,
                    context,
                    args: args.length > 0 ? args : undefined
                });
            }
            
            /**
             * 调试日志
             * @param {string} module - 模块名称
             * @param {string} message - 消息
             * @param {object} context - 上下文对象（可选）
             * @param {...any} args - 额外参数
             */
            debug(module, message, context, ...args) {
                if (typeof module === 'string' && typeof message === 'string') {
                    this._log('debug', module, message, context, ...args);
                } else {
                    // 兼容旧格式：logger.debug('[Module] message', ...args)
                    this._log('debug', '', module, message, ...args);
                }
            }
            
            /**
             * 信息日志
             * @param {string} module - 模块名称
             * @param {string} message - 消息
             * @param {object} context - 上下文对象（可选）
             * @param {...any} args - 额外参数
             */
            info(module, message, context, ...args) {
                if (typeof module === 'string' && typeof message === 'string') {
                    this._log('info', module, message, context, ...args);
                } else {
                    // 兼容旧格式：logger.info('[Module] message', ...args)
                    this._log('info', '', module, message, ...args);
                }
            }
            
            /**
             * 警告日志
             * @param {string} module - 模块名称
             * @param {string} message - 消息
             * @param {object} context - 上下文对象（可选）
             * @param {...any} args - 额外参数
             */
            warn(module, message, context, ...args) {
                if (typeof module === 'string' && typeof message === 'string') {
                    this._log('warn', module, message, context, ...args);
                } else {
                    // 兼容旧格式：logger.warn('[Module] message', ...args)
                    this._log('warn', '', module, message, ...args);
                }
            }
            
            /**
             * 错误日志
             * @param {string} module - 模块名称
             * @param {string} message - 消息
             * @param {object} context - 上下文对象（可选）
             * @param {...any} args - 额外参数
             */
            error(module, message, context, ...args) {
                if (typeof module === 'string' && typeof message === 'string') {
                    this._log('error', module, message, context, ...args);
                } else {
                    // 兼容旧格式：logger.error('[Module] message', ...args)
                    this._log('error', '', module, module, message, ...args);
                }
            }
            
            /**
             * 开始性能计时
             * @param {string} module - 模块名称
             * @param {string} label - 计时标签
             */
            time(module, label) {
                const timerKey = `${module}:${label}`;
                this.timers.set(timerKey, performance.now());
                this.debug(module, `开始计时: ${label}`);
            }
            
            /**
             * 结束性能计时并输出
             * @param {string} module - 模块名称
             * @param {string} label - 计时标签
             */
            timeEnd(module, label) {
                const timerKey = `${module}:${label}`;
                const startTime = this.timers.get(timerKey);
                if (startTime !== undefined) {
                    const duration = performance.now() - startTime;
                    this.debug(module, `计时结束: ${label}`, { duration: `${duration.toFixed(2)}ms` });
                    this.timers.delete(timerKey);
                } else {
                    this.warn(module, `未找到计时器: ${label}`);
                }
            }
            
            /**
             * 开始日志分组
             * @param {string} module - 模块名称
             * @param {string} label - 分组标签
             */
            group(module, label) {
                if (this.enabled && this._shouldLog('debug') && this._isModuleEnabled(module)) {
                    console.group(`[${module}] ${label}`);
                }
            }
            
            /**
             * 结束日志分组
             */
            groupEnd() {
                if (this.enabled && this._shouldLog('debug')) {
                    console.groupEnd();
                }
            }
            
            /**
             * 获取日志历史
             * @param {number} count - 获取最近 N 条日志
             * @returns {Array}
             */
            getHistory(count) {
                if (count) {
                    return this.logHistory.slice(-count);
                }
                return this.logHistory.slice();
            }
            
            /**
             * 清空日志历史
             */
            clearHistory() {
                this.logHistory = [];
            }
            
            /**
             * 检查是否应该记录该级别的日志
             * @private
             */
            _shouldLog(level) {
                return this.levels[level] >= this.levels[this.level];
            }
        }
        
        // 全局日志实例
        const logger = new Logger();
        
        // 从 URL 参数或 localStorage 读取日志配置
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // 日志级别
            const logLevel = urlParams.get('logLevel') || localStorage.getItem('editorLogLevel') || 'info';
            logger.setLevel(logLevel);
            
            // 启用的模块（逗号分隔）
            const enabledModules = urlParams.get('logModules') || localStorage.getItem('editorLogModules');
            if (enabledModules) {
                logger.enableModules(enabledModules.split(',').map(m => m.trim()));
            }
            
            // 禁用的模块（逗号分隔）
            const disabledModules = urlParams.get('logDisableModules') || localStorage.getItem('editorLogDisableModules');
            if (disabledModules) {
                logger.disableModules(disabledModules.split(',').map(m => m.trim()));
            }
        })();
        
        // 导出到全局，方便调试
        window.MiNoteLogger = logger;
        
        // ==================== 日志模块常量 ====================
        /**
         * 日志模块名称常量
         * 用于统一标识不同的功能模块
         */
        const LOG_MODULES = {
            EDITOR: 'Editor',           // 编辑器核心
            DOM_WRITER: 'DOMWriter',   // DOM 操作
            CONVERTER: 'Converter',     // XML/HTML 转换
            CURSOR: 'Cursor',           // 光标管理
            FORMAT: 'Format',           // 格式操作
            HISTORY: 'History',         // 撤销/重做
            IMAGE: 'Image',             // 图片处理
            LIST: 'List',               // 列表操作
            SELECTION: 'Selection',     // 选择管理
            SYNC: 'Sync',               // 状态同步
            INIT: 'Init',               // 初始化
            EVENT: 'Event',             // 事件处理
            UTILS: 'Utils'              // 工具函数
        };
        
        /**
         * 日志辅助函数：简化日志调用
         * 使用方式：
         *   log.debug(LOG_MODULES.EDITOR, '消息', {context: 'value'})
         *   log.info(LOG_MODULES.EDITOR, '消息')
         *   log.warn(LOG_MODULES.EDITOR, '消息', error)
         *   log.error(LOG_MODULES.EDITOR, '消息', {error: error.message})
         */
        const log = {
            debug: (module, message, context, ...args) => logger.debug(module, message, context, ...args),
            info: (module, message, context, ...args) => logger.info(module, message, context, ...args),
            warn: (module, message, context, ...args) => logger.warn(module, message, context, ...args),
            error: (module, message, context, ...args) => logger.error(module, message, context, ...args),
            time: (module, label) => logger.time(module, label),
            timeEnd: (module, label) => logger.timeEnd(module, label),
            group: (module, label) => logger.group(module, label),
            groupEnd: () => logger.groupEnd()
        };
        
        // ==================== 操作类型枚举 ====================
        /**
         * 操作类型枚举
         * 用于分类和合并操作
         */
        const OPERATION_TYPES = {
            INPUT: 'input',           // 文本输入
            DELETE: 'delete',         // 删除操作
            FORMAT: 'format',         // 格式操作（加粗、斜体等）
            FORMAT_REMOVE: 'format_remove', // 移除格式
            HEADING: 'heading',       // 标题
            ALIGNMENT: 'alignment',   // 对齐
            LIST: 'list',             // 列表
            CHECKBOX: 'checkbox',     // 复选框
            QUOTE: 'quote',           // 引用
            IMAGE: 'image',           // 图片
            INDENT: 'indent',         // 缩进
            HR: 'hr',                 // 水平线
            BATCH: 'batch',           // 批量操作
            OTHER: 'other'            // 其他操作
        };
        
        // ==================== 命令系统 ====================
        /**
         * 命令基类
         * 参考 CKEditor 5 的命令系统设计
         * 统一所有操作的接口，支持执行、撤销、状态检查
         */
        class Command {
            /**
             * 创建命令
             * @param {string} name - 命令名称
             * @param {Object} options - 命令选项
             * @param {Function} options.execute - 执行函数
             * @param {Function} options.undo - 撤销函数（可选）
             * @param {Function} options.canExecute - 是否可执行检查函数（可选）
             * @param {Function} options.getState - 获取状态函数（可选）
             * @param {string} options.type - 操作类型（用于历史记录）
             */
            constructor(name, options = {}) {
                this.name = name;
                this.executeFn = options.execute;
                this.undoFn = options.undo;
                this.canExecuteFn = options.canExecute;
                this.getStateFn = options.getState;
                this.type = options.type || OPERATION_TYPES.OTHER;
                this.state = null; // 命令执行后的状态（用于撤销）
                this.metadata = options.metadata || {}; // 命令元数据
                
                if (!this.executeFn) {
                    throw new Error(`Command ${name} must have an execute function`);
                }
            }
            
            /**
             * 执行命令
             * @param {Object} context - 执行上下文
             * @returns {*} 执行结果
             */
            execute(context = {}) {
                // 检查是否可执行
                if (!this.canExecute(context)) {
                    const error = new Error(`Command ${this.name} cannot be executed in current context`);
                    log.warn(LOG_MODULES.FORMAT, '命令无法执行', { 
                        command: this.name, 
                        context 
                    });
                    throw error;
                }
                
                try {
                    // 执行命令
                    this.state = this.executeFn(context);
                    
                    log.debug(LOG_MODULES.FORMAT, '命令执行成功', { 
                        command: this.name,
                        type: this.type
                    });
                    
                    return this.state;
                } catch (error) {
                    log.error(LOG_MODULES.FORMAT, '命令执行失败', { 
                        command: this.name, 
                        error: error.message,
                        stack: error.stack
                    });
                    throw error;
                }
            }
            
            /**
             * 撤销命令
             * @param {Object} context - 执行上下文
             * @returns {*} 撤销结果
             */
            undo(context = {}) {
                if (!this.undoFn) {
                    throw new Error(`Command ${this.name} does not support undo`);
                }
                
                if (this.state === null) {
                    throw new Error(`Command ${this.name} has no state to undo`);
                }
                
                try {
                    const result = this.undoFn(context, this.state);
                    
                    log.debug(LOG_MODULES.FORMAT, '命令撤销成功', { 
                        command: this.name 
                    });
                    
                    return result;
                } catch (error) {
                    log.error(LOG_MODULES.FORMAT, '命令撤销失败', { 
                        command: this.name, 
                        error: error.message 
                    });
                    throw error;
                }
            }
            
            /**
             * 检查命令是否可执行
             * @param {Object} context - 执行上下文
             * @returns {boolean} 是否可执行
             */
            canExecute(context = {}) {
                if (!this.canExecuteFn) {
                    return true; // 默认可以执行
                }
                
                try {
                    return this.canExecuteFn(context);
                } catch (error) {
                    log.warn(LOG_MODULES.FORMAT, '命令可执行性检查失败', { 
                        command: this.name, 
                        error: error.message 
                    });
                    return false;
                }
            }
            
            /**
             * 获取命令状态
             * @param {Object} context - 执行上下文
             * @returns {*} 命令状态
             */
            getState(context = {}) {
                if (!this.getStateFn) {
                    return null;
                }
                
                try {
                    return this.getStateFn(context);
                } catch (error) {
                    log.warn(LOG_MODULES.FORMAT, '获取命令状态失败', { 
                        command: this.name, 
                        error: error.message 
                    });
                    return null;
                }
            }
        }
        
        /**
         * 命令管理器
         * 负责命令的注册、执行和管理
         */
        class CommandManager {
            constructor(domWriter) {
                this.domWriter = domWriter;
                this.commands = new Map(); // 命令注册表
                this.commandHistory = []; // 命令执行历史
                this.historyIndex = -1;
                this.stateCache = new Map(); // 状态缓存
                this.stateCacheTimeout = 50; // 状态缓存超时时间（毫秒）
            }
            
            /**
             * 注册命令
             * @param {string} name - 命令名称
             * @param {Command|Object} command - 命令对象或命令选项
             */
            register(name, command) {
                if (command instanceof Command) {
                    this.commands.set(name, command);
                } else {
                    // 如果是选项对象，创建命令
                    this.commands.set(name, new Command(name, command));
                }
                
                log.debug(LOG_MODULES.FORMAT, '注册命令', { command: name });
            }
            
            /**
             * 执行命令
             * @param {string} name - 命令名称
             * @param {Object} context - 执行上下文
             * @returns {*} 执行结果
             */
            execute(name, context = {}) {
                const command = this.commands.get(name);
                if (!command) {
                    throw new Error(`Command ${name} is not registered`);
                }
                
                // 执行命令
                const result = command.execute(context);
                
                // 如果命令支持撤销，记录到历史
                if (command.undoFn) {
                    this._addToCommandHistory(name, command, context);
                }
                
                return result;
            }
            
            /**
             * 撤销上一个命令
             * @returns {boolean} 是否成功撤销
             */
            undo() {
                if (this.historyIndex < 0) {
                    return false;
                }
                
                const historyItem = this.commandHistory[this.historyIndex];
                const command = this.commands.get(historyItem.name);
                
                if (!command || !command.undoFn) {
                    return false;
                }
                
                try {
                    command.undo(historyItem.context);
                    this.historyIndex--;
                    return true;
                } catch (error) {
                    log.error(LOG_MODULES.FORMAT, '撤销命令失败', { 
                        command: historyItem.name, 
                        error: error.message 
                    });
                    return false;
                }
            }
            
            /**
             * 检查命令是否可执行
             * @param {string} name - 命令名称
             * @param {Object} context - 执行上下文
             * @returns {boolean} 是否可执行
             */
            canExecute(name, context = {}) {
                const command = this.commands.get(name);
                if (!command) {
                    return false;
                }
                
                return command.canExecute(context);
            }
            
            /**
             * 获取命令状态
             * @param {string} name - 命令名称
             * @param {Object} context - 执行上下文
             * @param {boolean} useCache - 是否使用缓存（默认 true）
             * @returns {*} 命令状态
             */
            getState(name, context = {}, useCache = true) {
                const command = this.commands.get(name);
                if (!command) {
                    return null;
                }
                
                // 检查缓存
                if (useCache && this.stateCache.has(name)) {
                    const cached = this.stateCache.get(name);
                    const now = Date.now();
                    if (now - cached.timestamp < this.stateCacheTimeout) {
                        return cached.state;
                    }
                }
                
                // 获取新状态
                const state = command.getState(context);
                
                // 更新缓存
                if (useCache) {
                    this.stateCache.set(name, {
                        state: state,
                        timestamp: Date.now()
                    });
                }
                
                return state;
            }
            
            /**
             * 批量获取多个命令的状态
             * @param {string[]} names - 命令名称数组
             * @param {Object} context - 执行上下文
             * @returns {Object} 命令状态映射
             */
            getStates(names, context = {}) {
                const states = {};
                names.forEach(name => {
                    states[name] = this.getState(name, context);
                });
                return states;
            }
            
            /**
             * 清除状态缓存
             * @param {string} name - 命令名称（可选，不提供则清除所有缓存）
             */
            clearStateCache(name = null) {
                if (name) {
                    this.stateCache.delete(name);
                } else {
                    this.stateCache.clear();
                }
            }
            
            /**
             * 检查命令是否可执行（批量检查）
             * @param {string[]} names - 命令名称数组
             * @param {Object} context - 执行上下文
             * @returns {Object} 命令可执行性映射
             */
            canExecuteBatch(names, context = {}) {
                const results = {};
                names.forEach(name => {
                    results[name] = this.canExecute(name, context);
                });
                return results;
            }
            
            /**
             * 添加到命令历史
             * @private
             */
            _addToCommandHistory(name, command, context) {
                // 如果当前不在历史末尾，删除后面的记录
                if (this.historyIndex < this.commandHistory.length - 1) {
                    this.commandHistory = this.commandHistory.slice(0, this.historyIndex + 1);
                }
                
                this.commandHistory.push({
                    name: name,
                    command: command,
                    context: context,
                    timestamp: Date.now()
                });
                
                this.historyIndex = this.commandHistory.length - 1;
            }
        }
        
        // ==================== 命令注册函数 ====================
        /**
         * 注册格式命令
         * @param {CommandManager} cmdManager - 命令管理器
         * @param {DOMWriter} domWriter - DOM 写入器
         */
        function _registerFormatCommands(cmdManager, domWriter) {
            const editor = document.getElementById('editor-content');
            if (!editor) {
                log.warn(LOG_MODULES.FORMAT, '编辑器元素不存在，无法注册格式命令');
                return;
            }
            
            // 格式命令：加粗、斜体、下划线、删除线、高亮
            const formatCommands = ['bold', 'italic', 'underline', 'strikethrough', 'highlight'];
            
            formatCommands.forEach(format => {
                cmdManager.register(`format:${format}`, {
                    type: OPERATION_TYPES.FORMAT,
                    execute: (context) => {
                        // 使用现有的 applyFormat 方法
                        const result = window.MiNoteWebEditor.applyFormat(format);
                        
                        // 返回状态（用于撤销）
                        return {
                            format: format,
                            result: result
                        };
                    },
                    canExecute: (context) => {
                        // 检查是否有选择内容
                        const selection = window.getSelection();
                        return selection && selection.rangeCount > 0;
                    },
                    getState: (context) => {
                        // 检查当前格式状态
                        const selection = window.getSelection();
                        if (!selection || selection.rangeCount === 0) {
                            return { active: false };
                        }
                        
                        const range = selection.getRangeAt(0);
                        const isActive = window.MiNoteWebEditor.checkFormatState(range, format);
                        return { active: isActive };
                    },
                    metadata: {
                        format: format,
                        category: 'text-format'
                    }
                });
            });
            
            log.info(LOG_MODULES.FORMAT, '格式命令注册完成', { 
                count: formatCommands.length 
            });
        }
        
        // ==================== 全局变量 ====================
        // 注意：这些变量现在由模块管理，这里只做初始化以确保向后兼容
        // 实际初始化在 modules/editor/editor-init.js 中完成
        window.xmlToHtmlConverter = window.xmlToHtmlConverter || null;
        window.htmlToXmlConverter = window.htmlToXmlConverter || null;
        window.currentContent = window.currentContent || '';
        window.isInitialized = window.isInitialized || false;
        window.isLoadingContent = window.isLoadingContent || false;
        window.contentChangeTimer = window.contentChangeTimer || null;
        window.formatStateSyncTimer = window.formatStateSyncTimer || null;
        window.isComposing = window.isComposing || false;
        window.commandManager = window.commandManager || null;
        window.domWriter = window.domWriter || null;

        // ==================== 回车键处理 ====================
        // 注意：回车键处理函数已迁移到 modules/editor/enter-handler.js
        // 以下代码已删除，请参考 enter-handler.js 模块

        // ==================== 光标位置修复 ====================
        // ==================== 格式状态同步 ====================
        // ==================== 内容变化通知 ====================
        // 注意：这些函数已提取到 modules/editor/editor-core.js

        // ==================== 日志重定向 ====================
        // 重写 console 方法以发送日志到 Swift
        (function() {
            const originalLog = console.log;
            const originalWarn = console.warn;
            const originalError = console.error;

            function createLogSender(level, original) {
                return function(...args) {
                    original.apply(console, args);
                    const message = args.map(arg => {
                        if (typeof arg === 'object') {
                            try { 
                                return JSON.stringify(arg); 
                            } catch(e) { 
                                return String(arg); 
                            }
                        }
                        return String(arg);
                    }).join(' ');
                    
                    if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.editorBridge) {
                        window.webkit.messageHandlers.editorBridge.postMessage({
                            type: 'log',
                            level: level,
                            message: message
                        });
                    }
                };
            }

            console.log = createLogSender('log', originalLog);
            console.warn = createLogSender('warn', originalWarn);
            console.error = createLogSender('error', originalError);
        })();
    </script>
</body>
</html>
