{
  "info": {
    "_postman_id": "audio-file-support-collection",
    "name": "小米笔记语音文件支持测试",
    "description": "用于测试语音文件解析和上传功能的 Postman 测试集合",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "获取笔记",
      "item": [
        {
          "name": "获取包含语音的笔记",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Cookie",
                "value": "{{cookies}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/note/note/{{note_id}}/?ts={{$timestamp}}",
              "host": ["{{base_url}}"],
              "path": ["note", "note", "{{note_id}}", ""],
              "query": [
                {
                  "key": "ts",
                  "value": "{{$timestamp}}"
                }
              ]
            },
            "description": "获取包含语音文件的笔记，验证 sound 标签解析"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// 测试响应状态",
                  "pm.test('响应状态码为 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "// 测试响应结构",
                  "pm.test('响应包含正确的结构', function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.result).to.eql('ok');",
                  "    pm.expect(jsonData.code).to.eql(0);",
                  "    pm.expect(jsonData.data).to.have.property('entry');",
                  "});",
                  "",
                  "// 测试 sound 标签解析",
                  "pm.test('笔记内容包含 sound 标签', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const content = jsonData.data.entry.content;",
                  "    pm.expect(content).to.include('<sound');",
                  "    pm.expect(content).to.include('fileid=');",
                  "});",
                  "",
                  "// 测试 fileId 提取",
                  "pm.test('能够正确提取 fileId', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const content = jsonData.data.entry.content;",
                  "    const fileIdMatch = content.match(/fileid=\"([^\"]+)\"/);",
                  "    pm.expect(fileIdMatch).to.not.be.null;",
                  "    pm.expect(fileIdMatch[1]).to.not.be.empty;",
                  "    ",
                  "    // 保存 fileId 供后续测试使用",
                  "    if (fileIdMatch) {",
                  "        pm.environment.set('sound_file_id', fileIdMatch[1]);",
                  "    }",
                  "});",
                  "",
                  "// 测试 setting.data 元数据",
                  "pm.test('setting.data 包含语音文件元数据', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const setting = jsonData.data.entry.setting;",
                  "    pm.expect(setting).to.have.property('data');",
                  "    pm.expect(setting.data).to.be.an('array');",
                  "    pm.expect(setting.data.length).to.be.greaterThan(0);",
                  "    ",
                  "    const audioMeta = setting.data[0];",
                  "    pm.expect(audioMeta).to.have.property('fileId');",
                  "    pm.expect(audioMeta).to.have.property('digest');",
                  "    pm.expect(audioMeta).to.have.property('mimeType');",
                  "    pm.expect(audioMeta.mimeType).to.include('audio');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "语音文件解析测试",
      "item": [
        {
          "name": "验证 sound 标签格式",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Cookie",
                "value": "{{cookies}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/note/note/{{note_id}}/?ts={{$timestamp}}",
              "host": ["{{base_url}}"],
              "path": ["note", "note", "{{note_id}}", ""],
              "query": [
                {
                  "key": "ts",
                  "value": "{{$timestamp}}"
                }
              ]
            },
            "description": "验证 sound 标签的 XML 格式是否正确"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// 测试 sound 标签格式",
                  "pm.test('sound 标签格式正确', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const content = jsonData.data.entry.content;",
                  "    ",
                  "    // 验证 sound 标签格式: <sound fileid=\"xxx\" />",
                  "    const soundTagRegex = /<sound\\s+fileid=\"[^\"]+\"\\s*\\/>/;",
                  "    pm.expect(content).to.match(soundTagRegex);",
                  "});",
                  "",
                  "// 测试 fileId 格式",
                  "pm.test('fileId 格式正确', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const content = jsonData.data.entry.content;",
                  "    const fileIdMatch = content.match(/fileid=\"([^\"]+)\"/);",
                  "    ",
                  "    pm.expect(fileIdMatch).to.not.be.null;",
                  "    const fileId = fileIdMatch[1];",
                  "    ",
                  "    // fileId 格式: 数字.随机字符串",
                  "    // 例如: 1315204657.jgHyouv563iSF_XCE4jhAg",
                  "    const fileIdFormatRegex = /^\\d+\\.[A-Za-z0-9_-]+$/;",
                  "    pm.expect(fileId).to.match(fileIdFormatRegex);",
                  "});",
                  "",
                  "// 测试 digest 格式",
                  "pm.test('digest 格式正确（SHA1 + 扩展名）', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const setting = jsonData.data.entry.setting;",
                  "    const audioMeta = setting.data[0];",
                  "    ",
                  "    // digest 格式: SHA1哈希值.扩展名",
                  "    // 例如: 8a41074a7bf788cf921a32a781e7b676f3103968.mp3",
                  "    const digestRegex = /^[a-f0-9]{40}\\.[a-z0-9]+$/;",
                  "    pm.expect(audioMeta.digest).to.match(digestRegex);",
                  "});",
                  "",
                  "// 测试 mimeType",
                  "pm.test('mimeType 为音频类型', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const setting = jsonData.data.entry.setting;",
                  "    const audioMeta = setting.data[0];",
                  "    ",
                  "    // 验证 mimeType 以 audio/ 开头",
                  "    pm.expect(audioMeta.mimeType).to.match(/^audio\\//);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "错误处理测试",
      "item": [
        {
          "name": "获取不存在的笔记",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Cookie",
                "value": "{{cookies}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/note/note/invalid_note_id/?ts={{$timestamp}}",
              "host": ["{{base_url}}"],
              "path": ["note", "note", "invalid_note_id", ""],
              "query": [
                {
                  "key": "ts",
                  "value": "{{$timestamp}}"
                }
              ]
            },
            "description": "测试获取不存在的笔记时的错误处理"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// 测试错误响应",
                  "pm.test('返回错误响应', function () {",
                  "    const jsonData = pm.response.json();",
                  "    // 可能返回 404 或错误码",
                  "    pm.expect(jsonData.code).to.not.eql(0);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "语音文件下载",
      "item": [
        {
          "name": "获取语音文件下载 URL",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Cookie",
                "value": "{{cookies}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/file/full/v2?ts={{$timestamp}}&type=note_img&fileid={{sound_file_id}}",
              "host": ["{{base_url}}"],
              "path": ["file", "full", "v2"],
              "query": [
                {
                  "key": "ts",
                  "value": "{{$timestamp}}"
                },
                {
                  "key": "type",
                  "value": "note_img"
                },
                {
                  "key": "fileid",
                  "value": "{{sound_file_id}}"
                }
              ]
            },
            "description": "获取语音文件的下载 URL\n\n使用 /file/full/v2 API 获取下载 URL。\n注意：type 参数使用 note_img（与上传时相同）。\n\n响应格式可能是两种：\n1. 简单格式：{\"data\": {\"url\": \"https://...\"}}\n2. KSS 格式：{\"data\": {\"kss\": {\"blocks\": [{\"urls\": [\"http://...\"]}]}}}"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// 测试响应状态",
                  "pm.test('响应状态码为 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "// 测试响应结构",
                  "pm.test('响应包含正确的结构', function () {",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.code).to.eql(0);",
                  "    pm.expect(jsonData.data).to.exist;",
                  "});",
                  "",
                  "// 测试下载 URL（支持两种格式）",
                  "pm.test('响应包含下载 URL（简单格式或 KSS 格式）', function () {",
                  "    const jsonData = pm.response.json();",
                  "    let downloadUrl = null;",
                  "    let formatType = '';",
                  "    ",
                  "    // 尝试简单格式：{\"data\": {\"url\": \"https://...\"}}",
                  "    if (jsonData.data.url) {",
                  "        downloadUrl = jsonData.data.url;",
                  "        formatType = '简单格式';",
                  "    }",
                  "    // 尝试 KSS 格式：{\"data\": {\"kss\": {\"blocks\": [{\"urls\": [\"http://...\"]}]}}}",
                  "    else if (jsonData.data.kss && ",
                  "             jsonData.data.kss.blocks && ",
                  "             jsonData.data.kss.blocks.length > 0 &&",
                  "             jsonData.data.kss.blocks[0].urls &&",
                  "             jsonData.data.kss.blocks[0].urls.length > 0) {",
                  "        downloadUrl = jsonData.data.kss.blocks[0].urls[0];",
                  "        formatType = 'KSS 格式';",
                  "    }",
                  "    ",
                  "    pm.expect(downloadUrl).to.not.be.null;",
                  "    pm.expect(downloadUrl).to.include('http');",
                  "    ",
                  "    // 保存下载 URL 供后续测试使用",
                  "    pm.environment.set('audio_download_url', downloadUrl);",
                  "    console.log('响应格式: ' + formatType);",
                  "    console.log('下载 URL: ' + downloadUrl.substring(0, 100) + '...');",
                  "});",
                  "",
                  "// 记录完整响应结构（调试用）",
                  "pm.test('记录响应结构', function () {",
                  "    const jsonData = pm.response.json();",
                  "    console.log('完整响应: ' + JSON.stringify(jsonData, null, 2).substring(0, 500));",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "下载语音文件",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{audio_download_url}}",
              "host": ["{{audio_download_url}}"]
            },
            "description": "使用获取到的下载 URL 下载实际的音频文件\n\n注意：下载请求不需要认证头，因为 URL 已经包含了认证信息。"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// 测试响应状态",
                  "pm.test('响应状态码为 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "// 测试响应内容类型",
                  "pm.test('响应内容类型为音频', function () {",
                  "    const contentType = pm.response.headers.get('Content-Type');",
                  "    console.log('Content-Type: ' + contentType);",
                  "    // 可能是 audio/mpeg, audio/mp3, application/octet-stream 等",
                  "    pm.expect(contentType).to.exist;",
                  "});",
                  "",
                  "// 测试响应大小",
                  "pm.test('响应包含音频数据', function () {",
                  "    const responseSize = pm.response.responseSize;",
                  "    console.log('响应大小: ' + responseSize + ' 字节');",
                  "    pm.expect(responseSize).to.be.greaterThan(0);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "语音文件上传（推断）",
      "item": [
        {
          "name": "请求上传语音文件 (type=note_sound - 已确认无效)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Cookie",
                "value": "{{cookies}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/x-www-form-urlencoded; charset=UTF-8",
                "type": "text"
              },
              {
                "key": "Origin",
                "value": "https://i.mi.com",
                "type": "text"
              },
              {
                "key": "Referer",
                "value": "https://i.mi.com/note/h5",
                "type": "text"
              }
            ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {
                  "key": "data",
                  "value": "{\"type\":\"note_sound\",\"storage\":{\"filename\":\"recording.mp3\",\"size\":{{file_size}},\"sha1\":\"{{file_sha1}}\",\"mimeType\":\"audio/mpeg\",\"kss\":{\"block_infos\":[{\"blob\":{},\"size\":{{file_size}},\"md5\":\"{{file_md5}}\",\"sha1\":\"{{file_sha1}}\"}]}}}",
                  "type": "text",
                  "description": "上传请求数据（type=note_sound，已确认无效）"
                },
                {
                  "key": "serviceToken",
                  "value": "{{service_token}}",
                  "type": "text"
                }
              ]
            },
            "url": {
              "raw": "{{base_url}}/file/v2/user/request_upload_file",
              "host": ["{{base_url}}"],
              "path": ["file", "v2", "user", "request_upload_file"]
            },
            "description": "请求上传语音文件（type=note_sound）\n\n⚠️ 已确认无效：2026-01-11 测试结果显示 note_sound 不是有效的 type 值，会返回 'wrong type value' 错误。"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// 测试响应状态",
                  "pm.test('响应状态码为 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "// 测试响应结构 - 预期失败",
                  "pm.test('type=note_sound 应该返回错误', function () {",
                  "    const jsonData = pm.response.json();",
                  "    console.log('响应: ' + JSON.stringify(jsonData));",
                  "    // 预期失败，因为 note_sound 不是有效的 type",
                  "    if (jsonData.code !== 0) {",
                  "        console.log('✅ 预期行为：type=note_sound 无效，错误码: ' + jsonData.code);",
                  "        pm.expect(jsonData.code).to.not.eql(0);",
                  "    } else {",
                  "        console.log('⚠️ 意外成功，需要进一步验证');",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "请求上传语音文件 (type=note_audio - 已确认无效)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Cookie",
                "value": "{{cookies}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/x-www-form-urlencoded; charset=UTF-8",
                "type": "text"
              },
              {
                "key": "Origin",
                "value": "https://i.mi.com",
                "type": "text"
              },
              {
                "key": "Referer",
                "value": "https://i.mi.com/note/h5",
                "type": "text"
              }
            ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {
                  "key": "data",
                  "value": "{\"type\":\"note_audio\",\"storage\":{\"filename\":\"recording.mp3\",\"size\":{{file_size}},\"sha1\":\"{{file_sha1}}\",\"mimeType\":\"audio/mpeg\",\"kss\":{\"block_infos\":[{\"blob\":{},\"size\":{{file_size}},\"md5\":\"{{file_md5}}\",\"sha1\":\"{{file_sha1}}\"}]}}}",
                  "type": "text",
                  "description": "上传请求数据（type=note_audio，已确认无效）"
                },
                {
                  "key": "serviceToken",
                  "value": "{{service_token}}",
                  "type": "text"
                }
              ]
            },
            "url": {
              "raw": "{{base_url}}/file/v2/user/request_upload_file",
              "host": ["{{base_url}}"],
              "path": ["file", "v2", "user", "request_upload_file"]
            },
            "description": "请求上传语音文件（type=note_audio）\n\n⚠️ 已确认无效：2026-01-11 测试结果显示 note_audio 不是有效的 type 值，会返回 'wrong type value' 错误。"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// 测试响应状态",
                  "pm.test('响应状态码为 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "// 测试响应结构 - 预期失败",
                  "pm.test('type=note_audio 应该返回错误', function () {",
                  "    const jsonData = pm.response.json();",
                  "    console.log('响应: ' + JSON.stringify(jsonData));",
                  "    // 预期失败，因为 note_audio 不是有效的 type",
                  "    if (jsonData.code !== 0) {",
                  "        console.log('✅ 预期行为：type=note_audio 无效，错误码: ' + jsonData.code);",
                  "        pm.expect(jsonData.code).to.not.eql(0);",
                  "    } else {",
                  "        console.log('⚠️ 意外成功，需要进一步验证');",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "请求上传语音文件 (type=note_file - 无效)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Cookie",
                "value": "{{cookies}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/x-www-form-urlencoded; charset=UTF-8",
                "type": "text"
              },
              {
                "key": "Origin",
                "value": "https://i.mi.com",
                "type": "text"
              },
              {
                "key": "Referer",
                "value": "https://i.mi.com/note/h5",
                "type": "text"
              }
            ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {
                  "key": "data",
                  "value": "{\"type\":\"note_file\",\"storage\":{\"filename\":\"recording.mp3\",\"size\":{{file_size}},\"sha1\":\"{{file_sha1}}\",\"mimeType\":\"audio/mpeg\",\"kss\":{\"block_infos\":[{\"blob\":{},\"size\":{{file_size}},\"md5\":\"{{file_md5}}\",\"sha1\":\"{{file_sha1}}\"}]}}}",
                  "type": "text",
                  "description": "上传请求数据（type=note_file，已确认无效）"
                },
                {
                  "key": "serviceToken",
                  "value": "{{service_token}}",
                  "type": "text"
                }
              ]
            },
            "url": {
              "raw": "{{base_url}}/file/v2/user/request_upload_file",
              "host": ["{{base_url}}"],
              "path": ["file", "v2", "user", "request_upload_file"]
            },
            "description": "请求上传语音文件（type=note_file）\n\n⚠️ 已确认无效：2026-01-11 测试结果显示 note_file 不是有效的 type 值。"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// 测试响应状态",
                  "pm.test('响应状态码为 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "// 测试响应结构",
                  "pm.test('响应包含正确的结构', function () {",
                  "    const jsonData = pm.response.json();",
                  "    console.log('响应: ' + JSON.stringify(jsonData));",
                  "    // 预期失败，因为 note_file 不是有效的 type",
                  "    if (jsonData.code !== 0) {",
                  "        console.log('❌ type=note_file 无效，错误码: ' + jsonData.code);",
                  "    } else {",
                  "        console.log('⚠️ 意外成功，需要进一步验证');",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "请求上传语音文件 (type=note_img - 推荐)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Cookie",
                "value": "{{cookies}}",
                "type": "text"
              },
              {
                "key": "Content-Type",
                "value": "application/x-www-form-urlencoded; charset=UTF-8",
                "type": "text"
              },
              {
                "key": "Origin",
                "value": "https://i.mi.com",
                "type": "text"
              },
              {
                "key": "Referer",
                "value": "https://i.mi.com/note/h5",
                "type": "text"
              }
            ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {
                  "key": "data",
                  "value": "{\"type\":\"note_img\",\"storage\":{\"filename\":\"recording.mp3\",\"size\":{{file_size}},\"sha1\":\"{{file_sha1}}\",\"mimeType\":\"audio/mpeg\",\"kss\":{\"block_infos\":[{\"blob\":{},\"size\":{{file_size}},\"md5\":\"{{file_md5}}\",\"sha1\":\"{{file_sha1}}\"}]}}}",
                  "type": "text",
                  "description": "上传请求数据（使用 note_img 类型，标准 MIME 类型 audio/mpeg）"
                },
                {
                  "key": "serviceToken",
                  "value": "{{service_token}}",
                  "type": "text"
                }
              ]
            },
            "url": {
              "raw": "{{base_url}}/file/v2/user/request_upload_file",
              "host": ["{{base_url}}"],
              "path": ["file", "v2", "user", "request_upload_file"]
            },
            "description": "请求上传语音文件（使用 type=note_img）\n\n根据测试结果，note_sound 和 note_audio 都不是有效的 type 值。\n尝试使用 note_img 作为 type（可能所有笔记附件都使用相同的类型）。\n\n注意：不使用 sortedKeys，保持与图片上传相同的字段顺序。"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// 测试响应状态",
                  "pm.test('响应状态码为 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "// 测试响应结构",
                  "pm.test('响应包含正确的结构', function () {",
                  "    const jsonData = pm.response.json();",
                  "    console.log('响应: ' + JSON.stringify(jsonData));",
                  "    // 检查是否成功",
                  "    if (jsonData.code === 0) {",
                  "        console.log('✅ type=note_img 成功！');",
                  "        pm.expect(jsonData.data).to.exist;",
                  "    } else {",
                  "        console.log('❌ 失败，错误码: ' + jsonData.code);",
                  "    }",
                  "});",
                  "",
                  "// 保存上传信息",
                  "pm.test('保存上传信息', function () {",
                  "    const jsonData = pm.response.json();",
                  "    if (jsonData.code === 0) {",
                  "        if (jsonData.data.fileId) {",
                  "            pm.environment.set('uploaded_sound_file_id', jsonData.data.fileId);",
                  "            console.log('文件已存在，fileId: ' + jsonData.data.fileId);",
                  "        } else if (jsonData.data.storage && jsonData.data.storage.uploadId) {",
                  "            pm.environment.set('upload_id', jsonData.data.storage.uploadId);",
                  "            console.log('需要上传，uploadId: ' + jsonData.data.storage.uploadId);",
                  "        }",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// 全局预请求脚本",
          "// 设置时间戳",
          "pm.environment.set('timestamp', Date.now());"
        ]
      }
    }
  ],
  "variable": [
    {
      "key": "base_url",
      "value": "https://i.mi.com",
      "type": "string"
    },
    {
      "key": "note_id",
      "value": "48926433520534752",
      "type": "string",
      "description": "包含语音文件的测试笔记 ID"
    }
  ]
}
