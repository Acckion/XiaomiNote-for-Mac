# 笔记切换时标题和内容不更新问题分析

## 问题描述
切换笔记时，标题不会跟随切换，正文内容有时候也不会切换。

## 根本原因分析

### 1. **标题更新问题**
在 `NoteDetailView.swift` 中，标题更新逻辑存在以下问题：

#### 问题位置 1：`quickSwitchToNote` 方法（第 577-582 行）
```swift
// 立即更新标题（显示占位符）
let title = note.title.isEmpty || note.title.hasPrefix("未命名笔记_") ? "" : note.title
editedTitle = title
originalTitle = title
```

**问题**：标题更新后立即被清空，因为后续代码会清空内容：
```swift
// 清空内容，显示加载状态
currentXMLContent = ""
```

#### 问题位置 2：`loadNoteContentFromCache` 方法（第 632-650 行）
```swift
// 加载标题
let title = note.title.isEmpty || note.title.hasPrefix("未命名笔记_") ? "" : note.title
editedTitle = title
originalTitle = title
```

**问题**：虽然这里正确设置了标题，但由于异步加载和状态管理问题，标题可能在视图更新前被覆盖。

### 2. **内容更新问题**

#### 问题位置 1：`UnifiedEditorWrapper.swift` 的内容同步逻辑
在 `handleXMLContentChange` 方法中（第 115-137 行）：
```swift
private func handleXMLContentChange(oldValue: String?, newValue: String?) {
    guard let newContent = newValue else { return }
    
    // 如果内容相同，不需要处理
    if newContent == oldValue && newContent == lastLoadedContent {
        return
    }
    
    // ... 重新加载内容
}
```

**问题**：
1. 条件判断过于严格，可能导致某些情况下内容不更新
2. `lastLoadedContent` 的更新时机不正确，可能导致内容被错误地认为"已加载"

#### 问题位置 2：原生编辑器的内容加载
在 `NativeEditorContext.swift` 的 `loadFromXML` 方法中（第 363-391 行）：
```swift
func loadFromXML(_ xml: String) {
    do {
        let attributed = try formatConverter.xmlToAttributedString(xml, folderId: currentFolderId)
        attributedText = attributed
        
        // 转换为 NSAttributedString
        let nsAttributed = try NSAttributedString(attributed, including: \.appKit)
        // ...
        nsAttributedText = mutableAttributed
        
        hasUnsavedChanges = false
    } catch {
        print("[NativeEditorContext] 加载 XML 失败: \(error)")
    }
}
```

**问题**：
1. 没有清除旧内容的逻辑，可能导致内容叠加
2. 错误处理不完善，失败时没有清空编辑器

### 3. **状态管理问题**

#### 问题位置：`isUpdatingFromExternal` 标志
在 `UnifiedEditorWrapper.swift` 中：
```swift
@State private var isUpdatingFromExternal: Bool = false
```

**问题**：
1. 这个标志用于防止循环更新，但在某些情况下可能导致正常的更新被阻止
2. 标志的设置和清除时机不够精确

#### 问题位置：`currentEditingNoteId` 验证
在多个地方都有这样的验证：
```swift
guard note.id == currentEditingNoteId else {
    Swift.print("[保存流程] ⚠️ 内容变化时笔记已切换，忽略此次保存")
    return
}
```

**问题**：虽然这个验证是必要的，但 `currentEditingNoteId` 的更新时机可能不正确，导致新笔记的内容被错误地忽略。

## 修复方案

### 修复 1：改进标题更新逻辑
确保标题在笔记切换时立即更新，并且不会被后续操作覆盖。

### 修复 2：改进内容加载逻辑
1. 在加载新内容前，先清空编辑器
2. 确保 `lastLoadedContent` 在正确的时机更新
3. 移除过于严格的内容相同性检查

### 修复 3：改进原生编辑器的内容加载
1. 在 `loadFromXML` 前先清空旧内容
2. 添加更好的错误处理

### 修复 4：优化状态管理
1. 确保 `currentEditingNoteId` 在笔记切换开始时立即更新
2. 优化 `isUpdatingFromExternal` 标志的使用

## 实施步骤

1. 修复 `NoteDetailView.swift` 中的标题更新逻辑
2. 修复 `UnifiedEditorWrapper.swift` 中的内容同步逻辑
3. 修复 `NativeEditorContext.swift` 中的内容加载逻辑
4. 添加调试日志以便追踪问题
5. 测试各种切换场景
