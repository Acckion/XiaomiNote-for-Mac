# 图片渲染修复实现计划

## 概述

本实现计划将修复原生编辑器的图片渲染问题，通过简化图片加载逻辑来仅支持统一的 `images/{userId}.{fileId}.{format}` 格式。

## 任务

### 1. 简化 LocalStorageService 图片加载

- [ ] 1.1 添加统一格式图片加载方法
  - 实现 `loadImageWithFullFormat(fullFileId: String, fileType: String) -> Data?` 方法
  - 实现 `loadImageWithFullFormatAllFormats(fullFileId: String) -> (data: Data, fileType: String)?` 方法
  - 仅支持 `images/{fullFileId}.{format}` 格式
  - 添加详细的加载日志记录
  - _需求: 1.1, 1.2, 4.1_

- [ ] 1.2 移除复杂的智能加载逻辑
  - 移除 `parseFileId()` 方法
  - 移除 `loadImageSmart()` 方法
  - 移除 `loadImageFromSpecialDirectory()` 方法
  - 简化错误处理逻辑
  - _需求: 2.1, 6.2_

- [ ]* 1.3 为简化的加载方法编写单元测试
  - 测试统一格式的图片加载
  - 测试各种图片格式（jpg, png, gif）
  - 测试文件不存在的错误处理
  - _需求: 1.1, 1.3_

### 2. 更新 ImageAttachment 加载逻辑

- [ ] 2.1 简化 loadImageFromLocalStorage 方法
  - 使用新的统一格式加载方法
  - 移除所有回退逻辑和复杂的路径尝试
  - 保持现有的异步加载和错误处理逻辑
  - _需求: 1.1, 2.1_

- [ ] 2.2 改进错误处理和用户反馈
  - 简化加载失败日志记录
  - 改进占位符图片的显示逻辑
  - 提供更清晰的错误信息
  - _需求: 4.2, 4.3, 5.1_

- [ ]* 2.3 为 ImageAttachment 编写集成测试
  - 测试从 XML 解析到图片显示的完整流程
  - 测试统一格式的图片加载
  - 测试错误处理和占位符显示
  - _需求: 1.1, 2.1, 4.2_

### 3. 更新 ImageStorageManager

- [ ] 3.1 简化图片加载方法
  - 更新 `loadImage(fileId: String)` 方法使用统一格式
  - 更新 `loadImageAsync(fileId: String, completion:)` 方法
  - 移除所有回退逻辑
  - _需求: 1.1, 1.2_

- [ ] 3.2 保持缓存机制
  - 确保缓存逻辑正常工作
  - 优化缓存键的使用
  - 添加缓存命中率统计
  - _需求: 5.4_

- [ ]* 3.3 为 ImageStorageManager 编写单元测试
  - 测试统一格式的图片加载
  - 测试缓存机制
  - 测试异步加载功能
  - _需求: 1.1, 5.4_

### 4. 验证与 Web 编辑器的兼容性

- [ ] 4.1 确认 Web 编辑器使用相同格式
  - 验证 WebEditorView.swift 中的 ImageURLSchemeHandler 使用完整文件名
  - 确保原生编辑器和 Web 编辑器使用相同的文件路径
  - 验证 URL 格式解析的一致性
  - _需求: 3.1, 3.2_

- [ ] 4.2 创建兼容性测试用例
  - 使用相同的测试图片文件测试两个编辑器
  - 验证相同的 XML 在两个编辑器中都能正确显示图片
  - 测试统一格式的兼容性
  - _需求: 3.1, 7.1_

### 5. 性能优化和用户体验改进

- [ ] 5.1 优化加载性能
  - 由于只有一种路径格式，加载速度应该更快
  - 实现并发控制，避免同时加载过多图片
  - 添加加载超时机制
  - _需求: 5.3, 5.5_

- [ ] 5.2 改进用户体验
  - 实现平滑的占位符到图片的过渡动画
  - 添加加载进度指示器
  - 优化图片显示的布局稳定性
  - _需求: 5.1, 5.2_

### 6. 调试和监控工具

- [ ] 6.1 创建简化的图片加载调试工具
  - 实现简化的 ImageLoadingDebugInfo 结构体
  - 添加详细的加载过程日志记录
  - 创建加载统计和性能监控
  - _需求: 4.1, 4.4_

- [ ] 6.2 添加开发者调试界面
  - 在调试模式下显示图片加载状态
  - 提供手动重试加载的功能
  - 显示缓存状态和统计信息
  - _需求: 4.4, 4.5_

### 7. 最终验证和测试

- [ ] 7.1 端到端测试
  - 测试完整的图片显示流程：XML 解析 → 图片加载 → 显示
  - 使用真实的小米笔记数据进行测试
  - 验证统一格式的正确性
  - _需求: 1.1, 2.1_

- [ ]* 7.2 性能基准测试
  - 测试简化后的图片加载性能
  - 对比修复前后的性能差异
  - 验证内存使用和缓存效果
  - _需求: 5.3, 5.4_

- [ ] 7.3 用户验收测试
  - 在实际使用场景中测试图片显示
  - 验证用户体验的改进
  - 收集用户反馈和问题报告
  - _需求: 5.1, 5.2, 7.4_

## 注意事项

- 任务标记 `*` 的为可选任务，可以跳过以加快 MVP 开发
- 每个任务都引用了相应的需求编号，确保实现的可追溯性
- 简化后的实现应该更容易维护和调试
- 统一的文件格式使得错误诊断更加直接