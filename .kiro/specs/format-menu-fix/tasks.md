# 实施计划：原生编辑器格式菜单修复

## 概述

本实施计划将设计文档中的修复方案转换为具体的开发任务。我们将采用渐进式修复方法，首先解决核心的格式应用问题，然后优化状态同步机制，最后完善错误处理和性能监控。所有代码将使用 Swift 和 SwiftUI 实现，确保与现有原生编辑器架构的兼容性。

## 任务

- [x] 1. 建立修复基础设施和调试工具
  - 创建格式菜单修复相关的调试和监控工具
  - 设置详细的日志记录机制
  - 建立性能测量基础设施
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [-] 2. 修复核心格式应用功能
  - [x] 2.1 增强 NativeEditorView.Coordinator.applyFormat() 方法
    - 完善所有格式类型的应用逻辑
    - 添加对空选择范围的处理
    - 增强错误处理和日志记录
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8_

  - [x] 2.2 编写格式应用的属性测试
    - **属性 1: 内联格式应用一致性**
    - **验证需求: 1.1, 1.2, 1.3, 1.4, 1.5**

  - [x] 2.3 编写块级格式应用的属性测试
    - **属性 2: 块级格式应用正确性**
    - **验证需求: 1.6, 1.7, 1.8**

  - [x] 2.4 修复字体特性应用逻辑
    - 完善加粗、斜体的 NSFontManager 处理
    - 修复字体特性切换的边界情况
    - 确保字体特性应用的一致性
    - _需求: 1.1, 1.2_

  - [x] 2.5 修复文本装饰应用逻辑
    - 完善下划线、删除线、高亮的属性设置
    - 修复属性切换的逻辑错误
    - 确保装饰效果的正确显示
    - _需求: 1.3, 1.4, 1.5_

- [x] 3. 修复格式状态检测和同步
  - [x] 3.1 增强 NativeEditorContext.updateCurrentFormats() 方法
    - 完善所有格式类型的状态检测
    - 优化检测算法的性能
    - 添加状态验证机制
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10_

  - [x] 3.2 编写内联格式状态检测的属性测试
    - **属性 3: 内联格式状态检测准确性**
    - **验证需求: 2.1, 2.2, 2.3, 2.4, 2.5**

  - [x] 3.3 编写块级格式状态检测的属性测试
    - **属性 4: 块级格式状态检测准确性**
    - **验证需求: 2.6, 2.7, 2.8, 2.9, 2.10**

  - [x] 3.4 实现格式状态同步器
    - 创建 FormatStateSynchronizer 类
    - 实现防抖机制避免频繁更新
    - 添加性能监控和优化
    - _需求: 3.2, 3.3_

  - [x] 3.5 修复特殊格式的状态检测
    - 完善列表格式的状态检测逻辑
    - 修复引用块状态检测
    - 添加特殊元素的状态处理
    - _需求: 2.9, 2.10, 7.1, 7.2, 7.3_

- [x] 4. 实现性能优化和响应性改进
  - [x] 4.1 优化格式应用的响应时间
    - 实现格式应用的性能监控
    - 优化格式应用的执行路径
    - 确保50ms内开始格式应用
    - _需求: 3.1_

  - [x] 4.2 编写格式应用性能的属性测试
    - **属性 5: 格式应用响应性能**
    - **验证需求: 3.1**

  - [x] 4.3 优化状态同步的响应时间
    - 实现状态同步的性能监控
    - 优化状态检测算法
    - 确保100ms内完成状态更新
    - _需求: 3.2_

  - [x] 4.4 编写状态同步性能的属性测试
    - **属性 6: 状态同步响应性能**
    - **验证需求: 3.2**

  - [x] 4.5 实现连续操作处理优化
    - 添加操作队列管理
    - 防止操作丢失和冲突
    - 确保连续操作的正确性
    - _需求: 3.4_

- [x] 5. 检查点 - 确保核心功能正常工作
  - 确保所有测试通过，如有问题请询问用户。

- [x] 6. 实现错误处理和恢复机制
  - [x] 6.1 增强格式应用的错误处理
    - 实现 FormatError 错误类型
    - 添加错误恢复机制
    - 完善错误日志记录
    - _需求: 4.1, 4.2_

  - [x] 6.2 编写错误处理的属性测试
    - **属性 8: 格式应用错误恢复**
    - **属性 9: 状态同步错误恢复**
    - **验证需求: 4.1, 4.2**

  - [x] 6.3 实现编辑器状态一致性检查
    - 添加编辑器状态监控
    - 实现按钮状态的自动禁用
    - 确保状态一致性
    - _需求: 4.3_

  - [x] 6.4 编写编辑器状态一致性的属性测试
    - **属性 10: 编辑器状态一致性**
    - **验证需求: 4.3**

- [-] 7. 实现快捷键与格式菜单的一致性
  - [x] 7.1 修复快捷键状态同步
    - 确保快捷键操作后菜单状态更新
    - 实现快捷键与菜单的双向同步
    - 添加快捷键操作的监听
    - _需求: 5.1, 5.2, 5.3_

  - [ ] 7.2 编写快捷键状态同步的属性测试
    - **属性 11: 快捷键状态同步一致性**
    - **验证需求: 5.1, 5.2, 5.3**

  - [x] 7.3 确保格式应用方式一致性
    - 验证菜单和快捷键的格式应用效果
    - 修复任何不一致的行为
    - 添加一致性验证机制
    - _需求: 5.4_

  - [ ] 7.4 编写格式应用一致性的属性测试
    - **属性 12: 格式应用方式一致性**
    - **验证需求: 5.4**

  - [x] 7.5 实现撤销操作的状态同步
    - 监听撤销/重做操作
    - 确保撤销后状态正确更新
    - 添加撤销操作的状态处理
    - _需求: 5.5_

- [x] 8. 实现混合格式和特殊元素处理
  - [x] 8.1 实现混合格式状态处理
    - 添加混合格式的状态检测逻辑
    - 实现部分激活状态的显示
    - 处理多种格式组合的情况
    - _需求: 6.1, 6.2_

  - [x] 8.2 编写混合格式处理的属性测试
    - **属性 14: 混合格式状态处理**
    - **验证需求: 6.1, 6.2**

  - [x] 8.3 实现混合格式的应用逻辑
    - 确保格式应用到整个选中范围
    - 处理格式冲突和覆盖
    - 优化混合格式的处理性能
    - _需求: 6.3_

  - [x] 8.4 编写混合格式应用的属性测试
    - **属性 15: 混合格式应用一致性**
    - **验证需求: 6.3**

  - [x] 8.5 实现跨段落格式处理
    - 添加跨段落选择的格式处理
    - 正确处理段落级格式的应用
    - 优化跨段落操作的性能
    - _需求: 6.4_

  - [x] 8.6 实现特殊元素的格式处理
    - 添加特殊元素附近的状态检测
    - 实现特殊元素的格式应用决策
    - 处理复选框、分割线、图片等元素
    - _需求: 7.1, 7.2, 7.3, 7.4_

- [ ] 9. 实现调试和监控功能
  - [ ] 9.1 实现详细的调试日志
    - 添加格式状态变化的日志记录
    - 实现可配置的日志级别
    - 创建调试模式的开关
    - _需求: 8.1_

  - [ ] 9.2 实现性能监控和指标收集
    - 添加格式应用时间的测量
    - 实现状态同步延迟的监控
    - 创建性能报告机制
    - _需求: 8.3_

  - [ ] 9.3 编写性能监控的属性测试
    - **属性 20: 性能指标监控**
    - **验证需求: 8.3**

  - [ ] 9.4 实现诊断信息收集
    - 创建格式问题的诊断工具
    - 实现上下文信息的收集
    - 添加问题报告的生成功能
    - _需求: 8.4_

- [ ] 10. 集成测试和最终验证
  - [ ] 10.1 进行全面的集成测试
    - 测试所有格式类型的完整流程
    - 验证格式菜单与编辑器的集成
    - 确保所有修复都正常工作
    - _需求: 所有需求_

  - [ ] 10.2 编写剩余的属性测试
    - **属性 7: 连续操作处理正确性**
    - **属性 13: 撤销操作状态同步**
    - **属性 16: 跨段落格式处理**
    - **属性 17: 特殊元素状态检测**
    - **属性 18: 特殊元素格式应用决策**
    - **属性 19: 错误日志记录完整性**

  - [ ] 10.3 性能基准测试
    - 测试格式应用的响应时间
    - 测试状态同步的性能
    - 验证性能要求的达成
    - _需求: 3.1, 3.2_

  - [ ] 10.4 用户体验验证
    - 验证格式菜单的交互体验
    - 确保状态指示的准确性
    - 测试错误情况的处理
    - _需求: 4.4_

- [ ] 11. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，格式菜单修复完成！

## 注意事项

- 所有任务都是必需的，确保完整和全面的修复验证
- 每个任务都引用了具体的需求，确保可追溯性
- 检查点确保增量验证和问题及时发现
- 属性测试验证通用正确性属性，单元测试验证具体示例和边界情况
- 重点关注现有代码的修复而不是重写，保持架构稳定性