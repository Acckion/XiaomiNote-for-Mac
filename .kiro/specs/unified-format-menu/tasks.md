# 实现计划：统一格式菜单系统

## 概述

实现统一的格式菜单系统，确保原生编辑器和 Web 编辑器在工具栏菜单和菜单栏菜单中的格式状态显示和操作行为完全一致。

## 任务

- [x] 1. 核心数据结构和接口
  - [x] 1.1 定义 FormatState 结构体
    - 创建 `Sources/View/Bridge/FormatState.swift` 文件
    - 定义 `ParagraphFormat` 枚举（heading1, heading2, heading3, body, bulletList, numberedList, checkbox）
    - 定义 `AlignmentFormat` 枚举（left, center, right）
    - 定义 `FormatState` 结构体，包含所有格式状态属性
    - 添加 `hasSelection` 和 `selectionLength` 属性
    - 实现 `Equatable` 协议
    - _Requirements: 1.1, 1.2, 1.3, 2.1_
  - [x] 1.2 定义 FormatMenuProvider 协议
    - 创建 `Sources/View/Bridge/FormatMenuProvider.swift` 文件
    - 定义 `getCurrentFormatState() -> FormatState` 方法
    - 定义 `isFormatActive(_ format: TextFormat) -> Bool` 方法
    - 定义 `applyFormat(_ format: TextFormat)` 方法
    - 定义 `toggleFormat(_ format: TextFormat)` 方法
    - 定义 `clearParagraphFormat()` 和 `clearAlignmentFormat()` 方法
    - 定义 `formatStatePublisher` 属性
    - 使用 `@MainActor` 标记协议
    - _Requirements: 3.1, 3.2, 3.3_
  - [x] 1.3 实现 FormatStateManager
    - 创建 `Sources/View/Bridge/FormatStateManager.swift` 文件
    - 实现单例模式
    - 添加 `@Published currentState: FormatState` 属性
    - 添加 `@Published activeProvider: FormatMenuProvider?` 属性
    - 实现 `setActiveProvider(_ provider:)` 方法
    - 实现 `applyFormat(_ format:)` 和 `toggleFormat(_ format:)` 方法
    - 实现状态变化通知发送
    - 实现编辑器焦点变化监听
    - _Requirements: 3.1, 3.2, 3.3, 4.1_
  - [x] 1.4 定义通知名称
    - 在 `Sources/Extensions/Notification+FormatState.swift` 中添加通知定义
    - 添加 `formatStateDidChange` 通知
    - 添加 `requestFormatStateUpdate` 通知
    - 确保通知可以在 MiNoteLibrary 和 MiNoteMac 两个 target 中访问
    - _Requirements: 4.1, 4.2_

- [x] 2. 原生编辑器格式检测实现
  - [x] 2.1 实现 NativeFormatProvider
    - 创建 `Sources/View/NativeEditor/NativeFormatProvider.swift` 文件
    - 实现 `FormatMenuProvider` 协议
    - 注入 `NativeEditorContext` 依赖
    - 实现所有协议方法
    - _Requirements: 3.1, 3.2, 3.3_
  - [x] 2.2 实现光标模式格式检测
    - 实现 `detectFormatStateAtCursor(position:)` 方法
    - 获取光标前一个字符的属性
    - 处理光标在文档开头的边界情况
    - 处理光标在段落开头的边界情况
    - 检测所有字符级格式（bold, italic, underline, strikethrough, highlight）
    - 检测段落级格式（heading1-3, body, bulletList, numberedList, checkbox）
    - 检测对齐格式（left, center, right）
    - 检测引用块格式
    - _Requirements: 5.1, 5.2, 5.3_
  - [x] 2.3 实现选择模式格式检测
    - 实现 `detectFormatStateInSelection(range:)` 方法
    - 遍历选择范围内的所有字符
    - 实现"全选检测"逻辑：只有所有字符都有某格式时才显示为激活
    - 检测所有字符级格式
    - 检测段落级格式（取第一个字符的段落格式）
    - 检测对齐格式（取第一个字符的对齐格式）
    - 检测引用块格式
    - _Requirements: 6.1, 6.2, 6.3_
  - [x] 2.4 实现格式应用逻辑
    - 实现选择模式下的格式应用
    - 实现光标模式下的 typingAttributes 设置
    - 实现段落格式互斥处理（标题和列表互斥）
    - 实现对齐格式互斥处理
    - 实现字符格式叠加处理
    - 实现引用块独立切换
    - _Requirements: 7.1, 7.2, 7.3, 7.4_
  - [x] 2.5 更新 NativeEditorContext
    - 添加 `formatProvider: NativeFormatProvider` 属性
    - 在初始化时创建 NativeFormatProvider
    - 更新 `updateCurrentFormats()` 方法使用新的检测逻辑
    - 更新 `applyFormat(_ format:)` 方法使用新的应用逻辑
    - 添加 `typingAttributes` 管理
    - 确保光标位置变化时重置 typingAttributes
    - _Requirements: 5.1, 6.1, 7.1_

- [x] 3. 菜单集成
  - [x] 3.1 更新 MenuManager 格式菜单
    - 添加 `updateFormatMenuState(_ state: FormatState)` 方法
    - 实现 `updateParagraphFormatMenuItems(_ format:)` 方法
    - 实现 `updateAlignmentMenuItems(_ alignment:)` 方法
    - 实现 `updateCharacterFormatMenuItems(_ state:)` 方法
    - 实现 `updateQuoteMenuItem(_ isQuote:)` 方法
    - 监听 `formatStateDidChange` 通知
    - 在通知回调中更新菜单状态
    - _Requirements: 8.1, 8.2, 8.3_
  - [x] 3.2 更新 MenuActionHandler 格式操作
    - 更新格式菜单项的 action 方法
    - 使用 `FormatStateManager.shared.applyFormat()` 应用格式
    - 确保菜单操作和工具栏操作使用相同的逻辑
    - _Requirements: 8.1, 8.2_
  - [x] 3.3 更新 NativeFormatMenuView
    - 注入 `FormatStateManager` 依赖
    - 使用 `stateManager.currentState` 显示格式状态
    - 使用 `stateManager.toggleFormat()` 应用格式
    - 更新段落格式列表显示逻辑
    - 更新对齐按钮显示逻辑
    - 更新字符格式按钮显示逻辑
    - 更新引用块按钮显示逻辑
    - _Requirements: 9.1, 9.2, 9.3_
  - [x] 3.4 实现工具栏和菜单栏状态同步
    - 确保 FormatStateManager 发送状态变化通知
    - 确保 MenuManager 监听状态变化通知
    - 确保 NativeFormatMenuView 监听状态变化
    - 测试工具栏操作后菜单栏状态更新
    - 测试菜单栏操作后工具栏状态更新
    - _Requirements: 4.1, 4.2, 10.1_

- [x] 4. 测试和优化
  - [ ]* 4.1 编写单元测试
    - 创建 `Tests/NativeEditorTests/FormatStateTests.swift`
    - 测试 FormatState 结构体
    - 测试 ParagraphFormat 和 AlignmentFormat 枚举
    - 创建 `Tests/NativeEditorTests/NativeFormatProviderTests.swift`
    - 测试光标模式格式检测
    - 测试选择模式格式检测
    - 测试格式应用逻辑
    - 测试互斥规则
    - _Requirements: 1.1, 1.2, 1.3, 5.1, 6.1, 7.1_
  - [ ]* 4.2 编写集成测试
    - 创建 `Tests/NativeEditorTests/FormatMenuIntegrationTests.swift`
    - 测试工具栏格式操作
    - 测试菜单栏格式操作
    - 测试状态同步
    - 测试编辑器切换
    - _Requirements: 10.1, 10.2_
  - [x] 4.3 性能优化
    - 实现格式状态检测防抖（50ms）
    - 实现增量状态更新
    - 优化选择模式下的遍历性能
    - 添加性能监控日志
    - _Requirements: 10.3_
  - [x] 4.4 边界条件处理
    - 处理空文档情况
    - 处理光标在文档开头情况
    - 处理光标在文档末尾情况
    - 处理选择跨段落情况
    - 处理编辑器不可用情况
    - 添加错误处理和日志
    - _Requirements: 5.3, 6.3_

## 备注

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以便追溯
- 段落格式和列表格式互斥，列表默认为正文样式
- 光标模式下点击格式后，后续输入的内容都应该带有该格式
- 选择模式下的混合状态处理：只要有任意一个字符没有该格式，就显示为未激活状态
