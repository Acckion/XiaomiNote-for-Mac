# 实现计划: 格式菜单段落样式显示和应用修复

## 概述

修复格式菜单中段落样式显示和应用不正确的问题，通过以下方式：
1. 调整字体大小检测阈值
2. 修正标题和正文的字体大小设置
3. 完善格式应用逻辑，确保应用"正文"格式时正确重置字体大小

## 任务

- [x] 1. 修改字体大小常量定义
  - 在 `FormatAttributesBuilder.swift` 中修改字体大小常量
  - 将正文字体大小从 15pt 改为 13pt
  - 将三级标题字体大小从 15pt 改为 16pt
  - 保持大标题（22pt）和二级标题（18pt）不变
  - _需求: 1.6, 1.7, 4.6, 4.7_

- [x] 1.1 编写字体大小常量的单元测试
  - 测试 `determineFontSize(for: .body)` 返回 13pt
  - 测试 `determineFontSize(for: .heading3)` 返回 16pt
  - 测试 `determineFontSize(for: .heading2)` 返回 18pt
  - 测试 `determineFontSize(for: .heading1)` 返回 22pt
  - _需求: 1.6, 1.7, 4.6, 4.7_

- [x] 2. 修改字体大小检测阈值
  - 在 `NativeEditorContext.detectFontFormats()` 方法中调整字体大小阈值
  - 将三级标题最小字体大小从 14pt 提高到 15pt
  - 将二级标题最小字体大小从 16pt 提高到 17pt
  - 确保小于 15pt 的字体不被识别为任何标题
  - _需求: 1.1, 1.3, 2.5, 4.1, 4.2, 4.3, 4.4_

- [ ]* 2.1 编写字体大小阈值检测的单元测试
  - 测试 13pt 字体识别为正文
  - 测试 14pt 字体识别为正文（边界条件）
  - 测试 15pt 字体识别为三级标题（边界条件）
  - 测试 16pt 字体识别为三级标题
  - 测试 17pt 字体识别为二级标题（边界条件）
  - 测试 20pt 字体识别为大标题（边界条件）
  - _需求: 1.2, 2.4, 4.1, 4.2, 4.3, 4.4_

- [ ]* 2.2 编写字体大小阈值的属性测试
  - **属性 3: 字体大小阈值正确性**
  - **验证需求: 4.1, 4.2, 4.3, 4.4**
  - 生成随机字体大小，验证阈值判断的正确性
  - 配置: 100 次迭代

- [x] 3. 实现 resetFontSizeToBody() 方法
  - 在 `NativeEditorContext` 中添加 `resetFontSizeToBody()` 私有方法
  - 该方法将选中文本的字体大小重置为 13pt
  - 保留字体特性（加粗、斜体等）
  - 更新编辑器内容
  - _需求: 1.6, 1.7, 4.7_

- [ ]* 3.1 编写 resetFontSizeToBody() 的单元测试
  - 测试重置正常文本的字体大小
  - 测试重置加粗文本的字体大小（保留加粗）
  - 测试重置斜体文本的字体大小（保留斜体）
  - 测试重置加粗+斜体文本的字体大小（保留两种特性）
  - _需求: 1.6, 1.7, 4.7_

- [x] 4. 修改 clearHeadingFormat() 方法
  - 在移除标题格式标记后，调用 `resetFontSizeToBody()`
  - 确保文本字体大小被重置为 13pt
  - 添加调试日志记录字体大小重置
  - _需求: 1.6, 1.7, 5.1, 5.4, 5.5_

- [ ]* 4.1 编写 clearHeadingFormat() 的单元测试
  - 测试清除大标题格式后字体大小变为 13pt
  - 测试清除二级标题格式后字体大小变为 13pt
  - 测试清除三级标题格式后字体大小变为 13pt
  - 测试清除标题格式后 headingLevel 属性被移除
  - _需求: 1.6, 1.7, 5.1_

- [ ]* 4.2 编写格式应用字体大小一致性的属性测试
  - **属性 9: 格式应用字体大小一致性**
  - **验证需求: 1.6, 1.7, 4.6, 4.7**
  - 测试应用正文格式后字体大小为 13pt
  - 测试应用三级标题格式后字体大小为 16pt
  - 配置: 100 次迭代

- [x] 5. 验证 headingLevel 属性优先级
  - 确认 `detectFontFormats()` 方法优先检查 headingLevel 属性
  - 确保当 headingLevel 存在时，忽略字体大小检测
  - 添加调试日志记录优先级选择
  - _需求: 2.1, 2.2, 2.3, 4.5_

- [ ]* 5.1 编写 headingLevel 优先级的单元测试
  - 测试 headingLevel=1 且字体大小为 13pt，识别为大标题
  - 测试 headingLevel=2 且字体大小为 13pt，识别为二级标题
  - 测试 headingLevel=3 且字体大小为 13pt，识别为三级标题
  - 测试没有 headingLevel 且字体大小为 20pt，识别为大标题
  - _需求: 2.1, 2.2, 4.5_

- [ ]* 5.2 编写标题属性优先级的属性测试
  - **属性 2: 标题属性优先级**
  - **验证需求: 2.1, 2.2, 4.5**
  - 生成随机 headingLevel 值和字体大小，验证优先使用 headingLevel
  - 配置: 100 次迭代

- [x] 6. 测试格式菜单状态同步
  - 验证格式菜单能正确反映段落样式变化
  - 测试正文、大标题、二级标题、三级标题的菜单勾选状态
  - 确保菜单状态互斥性（只有一个段落样式被勾选）
  - _需求: 1.4, 1.5, 3.1, 3.2, 3.3_

- [ ]* 6.1 编写菜单状态同步的单元测试
  - 测试正文状态时，只有"正文"菜单项被勾选
  - 测试大标题状态时，只有"大标题"菜单项被勾选
  - 测试二级标题状态时，只有"二级标题"菜单项被勾选
  - 测试三级标题状态时，只有"三级标题"菜单项被勾选
  - _需求: 1.4, 1.5, 3.2, 3.3_

- [ ]* 6.2 编写菜单状态互斥性的属性测试
  - **属性 4: 菜单状态互斥性**
  - **验证需求: 1.4, 1.5, 3.2, 3.3**
  - 生成随机段落样式，验证菜单状态互斥性
  - 配置: 100 次迭代

- [ ]* 6.3 编写状态同步及时性的属性测试
  - **属性 6: 状态同步及时性**
  - **验证需求: 3.1, 3.4**
  - 测量状态更新时间，验证在 50ms 内完成
  - 配置: 100 次迭代

- [ ] 7. 测试正文格式识别和应用
  - 验证默认输入的文本被识别为正文
  - 测试 12-14pt 范围内的字体都被识别为正文
  - 确保格式菜单显示"正文"为选中状态
  - 测试应用"正文"格式后字体大小为 13pt
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7_

- [ ]* 7.1 编写正文格式识别的单元测试
  - 测试空白编辑器输入文本，识别为正文
  - 测试 12pt 字体识别为正文
  - 测试 13pt 字体识别为正文（默认字体）
  - 测试 14pt 字体识别为正文
  - _需求: 1.1, 1.2, 1.3_

- [ ]* 7.2 编写正文格式应用的单元测试
  - 测试应用正文格式后字体大小为 13pt
  - 测试将大标题转换为正文后字体大小为 13pt
  - 测试将二级标题转换为正文后字体大小为 13pt
  - 测试将三级标题转换为正文后字体大小为 13pt
  - _需求: 1.6, 1.7_

- [ ]* 7.3 编写正文字体大小识别的属性测试
  - **属性 1: 正文字体大小识别**
  - **验证需求: 1.1, 1.3, 2.5, 4.4**
  - 生成随机字体大小（< 15pt），验证都被识别为正文
  - 配置: 100 次迭代

- [ ] 8. 测试新段落样式继承
  - 测试在正文段落末尾按回车，新段落继承正文样式（13pt）
  - 测试在标题段落末尾按回车，新段落恢复为正文样式（13pt）
  - 验证格式菜单状态正确更新
  - _需求: 5.2, 5.3_

- [ ]* 8.1 编写新段落样式继承的单元测试
  - 测试在正文后按回车，新段落为正文（13pt）
  - 测试在大标题后按回车，新段落为正文（13pt）
  - 测试在二级标题后按回车，新段落为正文（13pt）
  - 测试在三级标题后按回车，新段落为正文（13pt）
  - _需求: 5.2, 5.3_

- [ ]* 8.2 编写新段落样式继承的属性测试
  - **属性 8: 新段落样式继承**
  - **验证需求: 5.2, 5.3**
  - 模拟回车操作，验证新段落样式继承规则
  - 配置: 100 次迭代

- [ ] 9. 测试双向同步一致性
  - 测试通过菜单切换段落样式，格式检测立即反映新状态
  - 验证菜单操作后再次检测返回相同样式
  - 确保状态同步的一致性
  - _需求: 3.5_

- [ ]* 9.1 编写双向同步一致性的单元测试
  - 测试通过菜单切换到大标题，检测结果为大标题
  - 测试通过菜单切换到正文，检测结果为正文
  - 测试菜单操作后立即检测，状态一致
  - _需求: 3.5_

- [ ]* 9.2 编写双向同步一致性的属性测试
  - **属性 7: 双向同步一致性**
  - **验证需求: 3.5**
  - 模拟菜单操作，验证双向同步一致性
  - 配置: 100 次迭代

- [ ] 10. 集成测试和手动验证
  - 在实际编辑器中测试各种场景
  - 验证格式菜单显示正确
  - 测试用户工作流程
  - _需求: 所有需求_

- [ ]* 10.1 执行集成测试场景
  - 场景 1: 空白编辑器输入文本，验证格式菜单显示"正文"，字体大小为 13pt
  - 场景 2: 应用大标题格式，验证格式菜单显示"大标题"，字体大小为 22pt
  - 场景 3: 将大标题转换为正文，验证格式菜单显示"正文"，字体大小为 13pt
  - 场景 4: 在大标题后按回车，验证新段落格式菜单显示"正文"，字体大小为 13pt
  - 场景 5: 移动光标到不同段落，验证格式菜单实时更新
  - _需求: 所有需求_

- [ ] 11. 代码审查和文档更新
  - 代码审查
  - 更新相关注释和文档
  - 确保代码质量和可维护性
  - 移除调试日志（保留关键日志）

## 注意事项

- 任务标记 `*` 的为可选任务（主要是测试相关）
- 每个任务都引用了对应的需求编号
- 属性测试配置为 100 次迭代
- 优先完成核心修改（任务 1-5），然后进行测试（任务 6-9）
- 最后进行集成测试和代码审查（任务 10-11）

## 关键修复点

1. **字体大小常量**: `bodyFontSize` 从 15pt 改为 13pt，`heading3FontSize` 从 15pt 改为 16pt
2. **检测阈值**: 三级标题从 >= 14pt 改为 >= 15pt
3. **格式应用**: 应用"正文"格式时，不仅移除 headingLevel 属性，还要将字体大小重置为 13pt
4. **新方法**: 添加 `resetFontSizeToBody()` 方法来重置字体大小
5. **默认字体统一**: 将所有格式处理器中的默认字体从 15pt 统一为 13pt（与 `FormatAttributesBuilder.bodyFontSize` 保持一致）

## Bug 修复记录

### 2026-01-14: 修复标题转正文后字体大小变为 15pt 的问题

**问题描述**:
- 选中大标题样式的内容，点击格式菜单中的"正文"
- 字体大小先变为 13pt（正确），但随后又变为 15pt
- 15pt 被检测为三级标题（因为阈值是 `>=15pt`）

**根本原因**:
- `BlockFormatHandler.defaultFont` 定义为 `NSFont.systemFont(ofSize: 15)`（15pt）
- `FormatAttributesBuilder.bodyFontSize` 定义为 `13`（13pt）
- 当调用 `removeBlockFormat()` 时，它会将字体重置为 `defaultFont`（15pt）
- 这导致 `clearHeadingFormat()` 设置的 13pt 被覆盖为 15pt

**修复方案**:
将以下文件中的默认字体大小从 15pt 改为 13pt：
- `Sources/View/NativeEditor/Format/BlockFormatHandler.swift`
- `Sources/View/NativeEditor/Format/InlineFormatHandler.swift`
- `Sources/View/NativeEditor/Format/NewLineHandler.swift`
- `Sources/View/NativeEditor/Format/FormatManager.swift`
- `Sources/View/NativeEditor/Core/NativeEditorView.swift`
- `Sources/View/NativeEditor/Performance/PerformanceOptimizer.swift`
- `Sources/View/NativeEditor/Format/MixedFormatApplicationHandler.swift`

### 2026-01-14: 修复 heading2/heading3 转正文时错误应用大标题格式的问题

**问题描述**:
- 当内容是二级标题或三级标题时，点击格式菜单中的"正文"
- 内容会先变成"大标题"，而不是直接变成"正文"
- 从日志可以看到：`clearHeadingFormat()` 正确执行后，`[FormatApplicator] 开始应用格式: 大标题` 被立即调用

**根本原因**:
- `clearHeadingFormat()` 方法在清除标题格式后，调用了 `formatChangeSubject.send(.heading1)`
- 这个信号被 `NativeEditorView.Coordinator` 中的 `formatChangePublisher` 订阅者接收
- 订阅者调用 `applyFormat(.heading1)`，导致大标题格式被错误地应用

**修复方案**:
- 在 `clearHeadingFormat()` 方法中移除 `formatChangeSubject.send(.heading1)` 调用
- 改为调用 `updateCurrentFormats()` 来更新 UI 状态
- 同样修复 `clearAlignmentFormat()` 方法，避免类似问题

**修改文件**:
- `Sources/View/Bridge/NativeEditorContext.swift`
