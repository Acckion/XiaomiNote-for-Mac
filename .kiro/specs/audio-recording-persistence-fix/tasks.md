# 录音模板持久化修复实现计划

## 概述

将录音模板持久化问题的修复分解为具体的编码任务，确保Web编辑器和原生编辑器都支持完整的录音流程，并且录音内容能正确保存到数据库。

## 任务

- [x] 1. 修改Web编辑器录音模板格式
- [x] 1.1 更新 format.js 中的 insertRecordingTemplate 方法
  - 修改为插入XML格式：`<sound fileid="temp_[templateId]" des="temp"/>`
  - 确保占位符使用小米笔记标准格式
  - _需求: 4.1_

- [x] 1.2 更新 format.js 中的 updateRecordingTemplate 方法
  - 修改为更新XML格式：`<sound fileid="[fileId]"/>`（去掉des属性）
  - 立即调用 notifyContentChanged 触发保存
  - _需求: 1.1, 1.2_

- [x] 1.3 修复 html-to-xml.js 中对原生 sound 标签的处理
  - 添加对 `<sound>` 标签的检测（tagName === 'sound'）
  - 添加对原生 sound 元素的 XML 导出逻辑
  - 正确处理 fileid 和 des 属性
  - _需求: 4.1_

- [ ]* 1.4 为Web编辑器录音模板编写属性测试
  - **属性 1: 录音完成后立即保存**
  - **验证: 需求 1.1, 1.2**

- [x] 2. 实现原生编辑器录音模板支持
- [x] 2.1 在 NativeEditorContext 中添加 insertRecordingTemplate 方法
  - 插入相同的XML格式占位符
  - 与Web编辑器保持格式一致
  - _需求: 4.2_

- [x] 2.2 在 NativeEditorContext 中添加 updateRecordingTemplate 方法
  - 更新XML内容，替换临时占位符为实际音频元素
  - 触发内容变化通知
  - _需求: 4.3_

- [ ]* 2.3 为原生编辑器录音模板编写属性测试
  - **属性 8: 编辑器类型无关性**
  - **验证: 需求 4.1, 4.2, 4.3**

- [x] 3. 增强内容保存机制
- [x] 3.1 在 WebEditorContext 中添加 updateRecordingTemplateAndSave 方法
  - 更新模板后立即强制保存
  - 不依赖防抖机制，确保重要内容立即保存
  - _需求: 1.1, 2.1_

- [x] 3.2 在 NativeEditorContext 中添加 updateRecordingTemplateAndSave 方法
  - 实现与Web编辑器相同的强制保存逻辑
  - 确保原生编辑器也能立即保存录音内容
  - _需求: 1.1, 2.1_

- [ ]* 3.3 为强制保存机制编写属性测试
  - **属性 3: 模板更新触发保存**
  - **验证: 需求 2.1, 1.5**

- [x] 4. 实现内容持久化验证
- [x] 4.1 在编辑器上下文中添加 verifyContentPersistence 方法
  - 验证保存后的内容是否包含预期的音频附件
  - 检查数据库中的XML内容与编辑器内容一致性
  - _需求: 1.3, 3.4_

- [x] 4.2 在 NoteDetailView 中集成持久化验证
  - 笔记切换时验证加载的内容
  - 确保音频附件在切换后仍然可见
  - _需求: 1.3_

- [ ]* 4.3 为持久化验证编写属性测试
  - **属性 2: 内容持久化往返一致性**
  - **验证: 需求 1.3**

- [x] 5. 修改录音完成处理流程
- [x] 5.1 更新 MainWindowController.handleAudioRecordingComplete 方法
  - 根据当前编辑器类型选择相应的更新方法
  - 调用强制保存和验证机制
  - 确保两种编辑器使用相同的处理流程
  - _需求: 1.1, 4.3_

- [x] 5.2 添加统一的录音模板插入接口
  - 在 MainWindowController 中添加 insertRecordingTemplate 方法
  - 根据编辑器类型调用相应的插入方法
  - _需求: 4.1, 4.2_

- [ ]* 5.3 为录音完成处理编写属性测试
  - **属性 4: 内容变化检测准确性**
  - **验证: 需求 2.2**

- [x] 6. 增强错误处理和状态管理
- [x] 6.1 改进录音模板状态跟踪
  - 实现 RecordingTemplateState 枚举
  - 跟踪从插入到完成的完整状态
  - _需求: 2.5_

- [x] 6.2 添加详细的调试日志
  - 记录录音模板更新的每个步骤
  - 记录保存前后的内容状态
  - 记录失败原因和上下文信息
  - _需求: 3.1, 3.2, 3.3_

- [ ]* 6.3 为错误处理编写属性测试
  - **属性 6: 错误处理状态保持**
  - **验证: 需求 2.5**

- [x] 7. 实现缓存一致性维护
- [x] 7.1 更新内存缓存同步机制
  - 保存完成后立即更新内存缓存（已在 performXMLSave 中实现）
  - 清除未保存内容标志（已在 performXMLSave 中实现）
  - _需求: 2.3, 2.4_

- [ ]* 7.2 为缓存一致性编写属性测试
  - **属性 5: 缓存一致性维护**
  - **验证: 需求 2.3, 2.4**

- [x] 8. 检查点 - 确保所有测试通过
- 代码编译通过，核心功能已实现。

- [ ] 9. 集成测试和验证
- [ ] 9.1 端到端录音流程测试
  - 测试Web编辑器完整录音流程
  - 测试原生编辑器完整录音流程
  - 测试跨编辑器兼容性
  - _需求: 4.4, 4.5_

- [ ]* 9.2 为内容加载验证编写属性测试
  - **属性 7: 内容加载验证**
  - **验证: 需求 3.4**

- [ ] 9.3 笔记切换场景测试
  - 录音后切换笔记再回来的完整流程
  - 验证音频附件持久化和显示
  - _需求: 1.3_

- [ ] 10. 最终检查点 - 确保所有测试通过
- 确保所有测试通过，询问用户是否有问题。

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况