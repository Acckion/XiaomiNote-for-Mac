# 录音模板持久化修复需求文档

## 介绍

修复录音模板持久化问题。当前问题是录音完成后，录音模板能正确更新为实际音频附件并在编辑器中显示，但切换笔记后再回来时音频附件消失，说明内容变化没有正确持久化到数据库。

## 术语表

- **Recording_Template**: 录音模板，录制开始时插入的占位符元素
- **Audio_Attachment**: 音频附件，录制完成后替换模板的实际音频元素
- **Content_Persistence**: 内容持久化，将编辑器内容保存到数据库的过程
- **Template_Update**: 模板更新，将录音模板替换为音频附件的操作
- **WebEditorContext**: Web编辑器上下文，管理编辑器状态和操作
- **NotifyContentChanged**: 内容变化通知，编辑器通知Swift端内容已变化的机制

## 需求

### 需求 1

**用户故事：** 作为用户，我希望录音完成后音频附件能正确保存，这样切换笔记后再回来时音频仍然存在。

#### 验收标准

1. WHEN 录音完成且模板更新为音频附件 THEN 系统 SHALL 立即触发内容保存到数据库
2. WHEN 模板更新操作完成 THEN 系统 SHALL 确保 XML 内容包含实际的音频附件而不是模板
3. WHEN 用户切换到其他笔记再回来 THEN 系统 SHALL 显示之前录制的音频附件
4. WHEN 内容变化通知被触发 THEN 系统 SHALL 在合适的时机执行数据库保存操作
5. WHEN 录音模板被更新 THEN 系统 SHALL 标记笔记内容为已修改状态

### 需求 2

**用户故事：** 作为开发者，我希望录音模板更新流程能可靠地触发内容保存，确保数据一致性。

#### 验收标准

1. WHEN updateRecordingTemplate 方法被调用 THEN 系统 SHALL 确保后续的保存操作被正确执行
2. WHEN notifyContentChanged 被触发 THEN 系统 SHALL 验证内容确实发生了变化
3. WHEN 内容保存到数据库 THEN 系统 SHALL 更新内存缓存中的笔记内容
4. WHEN 保存操作完成 THEN 系统 SHALL 清除未保存内容标志
5. WHEN 模板更新失败 THEN 系统 SHALL 记录错误并保持原有状态

### 需求 3

**用户故事：** 作为系统管理员，我希望能监控和调试录音模板持久化过程，快速定位问题。

#### 验收标准

1. WHEN 录音模板更新开始 THEN 系统 SHALL 记录详细的调试日志
2. WHEN 内容保存操作执行 THEN 系统 SHALL 记录保存前后的内容状态
3. WHEN 保存操作失败 THEN 系统 SHALL 记录失败原因和上下文信息
4. WHEN 笔记切换时加载内容 THEN 系统 SHALL 验证加载的内容是否包含预期的音频附件
5. WHEN 调试模式启用 THEN 系统 SHALL 提供录音模板持久化状态的可视化信息

### 需求 4

**用户故事：** 作为用户，我希望无论使用Web编辑器还是原生编辑器，录音功能都能完整可用，确保一致的用户体验。

#### 验收标准

1. WHEN 用户在Web编辑器中开始录音 THEN 系统 SHALL 插入XML格式的录音模板占位符
2. WHEN 用户在原生编辑器中开始录音 THEN 系统 SHALL 插入相同格式的XML录音模板占位符
3. WHEN 录音完成无论在哪种编辑器 THEN 系统 SHALL 使用相同的流程更新模板为音频附件
4. WHEN 在Web编辑器中录制的音频 THEN 系统 SHALL 在原生编辑器中正确显示和播放
5. WHEN 在原生编辑器中录制的音频 THEN 系统 SHALL 在Web编辑器中正确显示和播放