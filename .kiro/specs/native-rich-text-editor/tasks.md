# 实施计划：原生富文本编辑器

## 概述

本实施计划将设计文档中的架构转换为具体的开发任务。我们将采用渐进式开发方法，首先实现核心功能，然后逐步添加高级特性。所有代码将使用 Swift 和 SwiftUI 实现，确保与 macOS 的原生集成。

## 任务

- [x] 1. 建立项目结构和核心接口
  - 创建原生编辑器相关的目录结构
  - 定义核心接口和协议
  - 设置测试框架
  - _需求: 1.1, 8.1_

- [x] 2. 实现编辑器选择系统
  - [x] 2.1 创建编辑器类型枚举和设置存储
    - 定义 EditorType 枚举（native, web）
    - 实现 UserDefaults 扩展用于编辑器偏好存储
    - _需求: 1.2, 1.3_

  - [x] 2.2 实现编辑器设置界面
    - 创建 EditorSettingsView SwiftUI 视图
    - 添加编辑器选择 Picker 组件
    - 实现系统兼容性检查
    - _需求: 1.1, 1.4_

  - [x] 2.3 实现编辑器工厂模式
    - 创建 EditorProtocol 协议
    - 实现 EditorFactory 类
    - 创建 NoteEditorCoordinator 管理器
    - _需求: 1.2, 1.3_

- [x] 3. 检查点 - 确保所有测试通过
  - ✅ 编辑器偏好设置服务测试：8个测试全部通过
  - ✅ 原生编辑器上下文测试：12个测试全部通过
  - ⚠️ 格式转换器测试：部分失败（预期，因为转换器还未完全实现）
  - 所有核心编辑器选择系统测试通过，可以继续下一阶段开发

- [x] 4. 实现格式转换器
  - [x] 4.1 创建小米笔记 XML 解析器
    - 实现 XMLElement 解析逻辑
    - 处理各种 XML 元素类型（text, bullet, order, checkbox, hr, quote, img）
    - 实现错误处理和验证
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 7.10, 7.11, 7.12_

  - [x] 4.2 实现 AttributedString 到 XML 转换
    - 创建 XiaoMiFormatConverter 类
    - 实现 attributedStringToXML 方法
    - 处理富文本格式标签转换
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 7.10, 7.11, 7.12_

  - [x] 4.3 实现 XML 到 AttributedString 转换
    - 实现 xmlToAttributedString 方法
    - 处理特殊元素到 NSTextAttachment 的转换
    - 实现富文本属性映射
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 7.10, 7.11, 7.12_

- [x] 5. 实现自定义渲染器
  - [x] 5.1 创建基础 NSTextAttachment 子类
    - 实现 InteractiveCheckboxAttachment 类
    - 实现 HorizontalRuleAttachment 类
    - 实现 BulletAttachment 类
    - _需求: 8.1, 8.2, 8.5_

  - [x] 5.2 实现复选框渲染和交互
    - 创建复选框图像生成逻辑
    - 实现点击检测和状态切换
    - 添加深色/浅色模式适配
    - _需求: 3.1, 3.2, 3.4, 3.5, 8.4_

  - [x] 5.3 实现分割线渲染
    - 创建水平分割线图像生成
    - 实现主题适配和布局处理
    - _需求: 4.1, 4.2, 4.4, 4.5_

  - [x] 5.4 实现引用块渲染
    - 创建自定义 NSLayoutManager 子类
    - 实现背景和边框绘制
    - 处理多行引用块布局
    - _需求: 5.1, 5.2, 5.3, 8.3_
- [ ] 6. 实现原生编辑器核心
  - [ ] 6.1 创建 NativeEditorContext 类
    - 实现编辑器状态管理
    - 添加格式状态跟踪
    - 实现光标位置和选择范围管理
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

  - [ ] 6.2 实现 NativeEditorView SwiftUI 视图
    - 创建基于 TextEditor 的编辑器视图
    - 集成 NSTextView 高级功能
    - 实现自定义 NSTextAttachment 支持
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8_

  - [ ] 6.3 实现格式应用逻辑
    - 添加富文本格式应用（加粗、斜体、下划线、删除线、高亮）
    - 实现对齐方式设置（居中、右对齐）
    - 处理缩进级别调整
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8_

- [ ] 7. 实现列表和标题功能
  - [ ] 7.1 实现无序列表功能
    - 创建项目符号渲染
    - 实现列表项创建和编辑
    - 处理嵌套列表缩进
    - _需求: 6.1, 6.6, 6.7_

  - [ ] 7.2 实现有序列表功能
    - 创建自动编号逻辑
    - 实现 inputNumber 规则处理
    - 处理连续列表状态管理
    - _需求: 6.2, 6.6, 6.7_

  - [ ] 7.3 实现标题功能
    - 添加大标题、二级标题、三级标题样式
    - 实现标题格式应用和切换
    - _需求: 6.3, 6.4, 6.5_

- [ ] 8. 实现特殊元素插入
  - [ ] 8.1 实现复选框列表功能
    - 添加复选框插入逻辑
    - 实现回车键创建新复选框项
    - 处理复选框状态管理（仅编辑器显示）
    - _需求: 3.1, 3.2, 3.3, 3.6_

  - [ ] 8.2 实现分割线插入功能
    - 添加分割线插入按钮和快捷键
    - 实现分割线选择和删除
    - _需求: 4.1, 4.3_

  - [ ] 8.3 实现引用块功能
    - 添加引用块创建和编辑
    - 实现多行引用内容处理
    - 处理引用块内富文本格式
    - _需求: 5.1, 5.3, 5.4, 5.6_

- [ ] 9. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 10. 实现图片和媒体支持
  - [ ] 10.1 实现图片粘贴和插入
    - 添加图片粘贴检测
    - 实现本地存储保存
    - 创建图片 NSTextAttachment
    - _需求: 10.1, 10.2_

  - [ ] 10.2 实现图片显示和加载
    - 实现 minote:// URL 方案支持
    - 添加图片加载失败占位符
    - 实现图片缩放和布局调整
    - _需求: 10.3, 10.4, 10.5_

- [ ] 11. 实现性能优化
  - [ ] 11.1 添加渲染性能优化
    - 实现 NSTextAttachment 缓存机制
    - 添加增量渲染支持
    - 优化大文档处理
    - _需求: 11.3, 11.5_

  - [ ] 11.2 实现编辑器响应性优化
    - 确保编辑器快速初始化（<100ms）
    - 添加实时格式反馈
    - 优化光标位置和选择状态保持
    - _需求: 11.1, 11.2, 11.4_

- [ ] 12. 实现错误处理和调试功能
  - [ ] 12.1 添加错误处理机制
    - 实现初始化失败处理
    - 添加渲染失败回退机制
    - 实现格式转换错误处理
    - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

  - [ ] 12.2 实现调试和监控功能
    - 添加详细日志记录
    - 实现性能指标收集
    - 创建错误报告生成
    - _需求: 13.1, 13.2, 13.3, 13.4, 13.5_

- [ ] 13. 集成和最终测试
  - [ ] 13.1 集成编辑器到主应用
    - 将原生编辑器集成到现有笔记视图
    - 实现编辑器切换功能
    - 确保数据同步正常工作
    - _需求: 1.2, 1.3_

  - [ ] 13.2 进行全面测试
    - 执行所有单元测试和集成测试
    - 测试复杂文档的编辑和转换
    - 验证与小米笔记服务器的同步兼容性
    - _需求: 7.1-7.12, 11.1-11.5_

- [ ] 14. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

## 注意事项

- 所有任务都是必需的，确保完整和全面的实现
- 每个任务都引用了具体的需求，确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况