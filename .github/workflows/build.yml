name: Build

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

permissions:
  contents: read

jobs:
  build:
    name: Build and Test
    runs-on: macos-15

    steps:
      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-env

      - name: SwiftLint (PR annotation)
        id: swiftlint-pr
        if: github.event_name == 'pull_request'
        uses: norio-nomura/action-swiftlint@3.2.1
        with:
          args: --config .swiftlint.yml
        env:
          DIFF_BASE: ${{ github.event.pull_request.base.sha }}

      - name: SwiftLint
        id: swiftlint
        if: github.event_name != 'pull_request'
        run: swiftlint lint --config .swiftlint.yml --reporter xcode

      - name: Build
        id: build
        run: |
          xcodebuild -project MiNoteMac.xcodeproj \
            -scheme MiNoteMac \
            -configuration Debug \
            -destination 'platform=macOS' \
            build

      - name: Test
        id: test
        run: |
          xcodebuild test -project MiNoteMac.xcodeproj \
            -scheme MiNoteLibrary \
            -destination 'platform=macOS'

      - name: Job Summary
        if: always()
        run: |
          echo "## CI 构建报告" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 项目 | 结果 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| SwiftLint | ${{ steps.swiftlint-pr.outcome || steps.swiftlint.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 构建 (Debug) | ${{ steps.build.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 单元测试 | ${{ steps.test.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**分支**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**提交**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**触发**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**状态**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
