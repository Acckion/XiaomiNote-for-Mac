# 窗口状态管理测试指南

## 已完成的工作

### 第一步：创建窗口状态数据类型 ✅
- 创建了 `MainWindowState.swift` - 主窗口状态类，实现 NSSecureCoding
- 创建了 `SidebarWindowState.swift` - 侧边栏状态类
- 创建了 `NotesListWindowState.swift` - 笔记列表状态类
- 创建了 `NoteDetailWindowState.swift` - 笔记详情状态类
- 创建了 `WindowStateManager.swift` - 窗口状态管理器

### 第二步：实现 NSWindow 扩展 ✅
- 创建了 `NSWindow+MiNote.swift` 扩展
- 实现了窗口位置调整方法：`setPointAndSizeAdjustingForScreen`
- 实现了窗口居中方法：`centerOnScreen`
- 实现了窗口状态保存和恢复方法：`savableState` 和 `restoreState(from:)`

### 第三步：修改 AppDelegate ✅
- 在 `AppDelegate.swift` 中添加了 `MiNoteWindowStateManager` 类
- 实现了窗口 frame 的保存和恢复功能
- 实现了旧版窗口状态迁移功能
- 修改了应用程序状态保存和恢复逻辑
- 添加了 `applicationShouldHandleReopen` 方法，修复了 Dock 图标点击问题

## 测试方法

### 1. 基础功能测试

运行测试脚本验证核心功能：
```bash
cd /Users/acckion/Desktop/SwiftUI-MiNote-for-Mac
swift run_window_state_test.swift
```

测试内容包括：
- UserDefaults 存储窗口 frame
- NSSecureCoding 序列化
- 旧版窗口状态迁移

### 2. 编译测试

验证代码编译是否成功：
```bash
cd /Users/acckion/Desktop/SwiftUI-MiNote-for-Mac
xcodebuild -project MiNoteMac.xcodeproj -scheme MiNoteMac build
```

### 3. 应用程序测试

#### 测试步骤：

1. **启动应用程序测试**
   ```bash
   cd /Users/acckion/Desktop/SwiftUI-MiNote-for-Mac
   open MiNoteMac.xcodeproj
   ```
   在 Xcode 中运行应用程序（⌘R）

2. **窗口位置和大小保存测试**
   - 启动应用程序
   - 移动窗口到屏幕上的任意位置
   - 调整窗口大小
   - 关闭应用程序（⌘Q）
   - 重新启动应用程序
   - 验证窗口是否恢复到上次的位置和大小

3. **多个窗口状态管理测试**
   - 启动应用程序
   - 创建新窗口（⌘⌥N）
   - 调整每个窗口的位置和大小
   - 关闭所有窗口
   - 重新启动应用程序
   - 验证所有窗口是否恢复到上次的状态

4. **全屏状态保存测试**
   - 启动应用程序
   - 进入全屏模式（点击窗口左上角绿色按钮或 ⌃⌘F）
   - 退出全屏模式
   - 关闭应用程序
   - 重新启动应用程序
   - 验证窗口是否保持上次的全屏状态

5. **Dock 图标点击测试（修复的问题）**
   - 启动应用程序
   - 关闭所有窗口（点击窗口左上角红色按钮或 ⌘W）
   - 点击 Dock 中的应用程序图标
   - 验证是否重新打开主窗口
   - 重复多次，确保功能稳定

### 4. 数据验证

检查保存的数据：
```bash
# 查看 UserDefaults 中保存的窗口 frame 数据
defaults read com.apple.MiNote MiNoteWindowFrames

# 或者直接查看 plist 文件
cat ~/Library/Preferences/com.apple.MiNote.plist | grep -A 10 MiNoteWindowFrames
```

### 5. 错误处理测试

1. **边界情况测试**
   - 将窗口移动到屏幕外，然后关闭并重新启动应用程序
   - 将窗口调整到极小尺寸（小于最小尺寸限制）
   - 在多显示器环境中测试窗口状态恢复

2. **数据损坏测试**
   - 手动修改 plist 文件中的窗口 frame 数据为无效值
   - 启动应用程序，验证是否能正确处理错误数据

## 预期结果

### 成功标准：
1. ✅ 应用程序能够成功编译
2. ✅ 窗口位置和大小能够正确保存和恢复
3. ✅ 多个窗口的状态能够独立管理
4. ✅ 全屏状态能够正确保存和恢复
5. ✅ 旧版窗口状态能够正确迁移
6. ✅ Dock 图标点击能够重新打开窗口
7. ✅ 边界情况和错误数据能够正确处理

### 验证方法：
1. 观察控制台输出，查看是否有错误信息
2. 检查 UserDefaults 中保存的数据是否正确
3. 手动验证窗口的实际位置和大小
4. 测试应用程序的稳定性

## 故障排除

### 常见问题：

1. **窗口没有恢复到上次的位置**
   - 检查控制台输出，查看是否有保存/恢复相关的错误信息
   - 验证 UserDefaults 中是否保存了正确的数据
   - 检查 `MiNoteWindowStateManager` 的保存和恢复逻辑

2. **Dock 图标点击无法打开窗口**
   - 检查 `applicationShouldHandleReopen` 方法是否正确实现
   - 验证 `createMainWindow` 方法是否能够正确创建窗口
   - 检查窗口控制器列表是否被正确管理

3. **编译错误**
   - 确保所有新创建的文件都已添加到 Xcode 项目中
   - 检查导入语句是否正确
   - 验证 NSSecureCoding 实现是否正确

4. **应用程序崩溃**
   - 检查是否有 nil 值解包
   - 验证 NSSecureCoding 的编码/解码逻辑
   - 检查线程安全性问题

### 调试建议：

1. 在 `AppDelegate.swift` 中添加更多调试输出
2. 使用 Xcode 的调试器检查变量值
3. 检查控制台日志中的错误信息
4. 逐步测试每个功能模块

## 下一步工作

根据 implementation_plan.md 中的计划，下一步需要：

### 第四步：重构 MainWindowController
- 添加 `savableWindowState()` 方法
- 添加 `restoreWindowState(_:)` 方法
- 集成窗口状态管理功能

### 第五步：为视图控制器添加状态管理
- 为侧边栏、笔记列表、笔记详情视图控制器添加状态管理
- 实现分割视图宽度的保存和恢复

### 第六步：配置分割视图行为
- 实现 3→2→1 压缩顺序
- 实现 1→2→3 展开顺序
- 配置分割视图的最小和最大宽度

### 第七步：测试和验证
- 全面测试所有功能
- 验证边缘情况处理
- 性能测试

### 第八步：错误处理和边缘情况
- 添加错误处理逻辑
- 处理数据损坏情况
- 添加恢复机制

## 联系信息

如果在测试过程中遇到问题，请参考：
- `implementation_plan.md` - 完整的实现计划
- 控制台输出 - 查看调试信息
- Xcode 调试器 - 进行代码级调试

测试完成后，请继续实施第四步：重构 MainWindowController。
