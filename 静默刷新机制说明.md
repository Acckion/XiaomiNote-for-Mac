# 静默刷新机制说明

## 概述

静默刷新是小米笔记Mac客户端的一个重要功能，用于在后台自动刷新Cookie，避免因Cookie过期导致同步失败。该功能在用户无感知的情况下完成认证更新，提供更流畅的用户体验。

## 触发时机

### 1. Cookie失效检测触发（主要触发方式）

**触发条件**：
- 网络正常（`NetworkMonitor.isOnline == true`）
- Cookie无效（`MiNoteService.hasValidCookie() == false`）
- 用户未选择"保持离线模式"（`shouldStayOffline == false`）
- 未显示过Cookie失效弹窗（`cookieExpiredShown == false`）
- 设置中启用了"Cookie失效时静默刷新"（`silentRefreshOnFailure == true`）

**检测机制**：
1. **定时检查**：`AuthenticationStateManager`的智能定时器定期检查Cookie状态
   - 前台活跃：每10秒检查一次
   - 应用后台：每30秒检查一次  
   - 网络断开：每60秒检查一次
   - Cookie长时间有效：降低检查频率

2. **API请求触发**：`MiNoteService`在API请求返回401错误时触发
   - 检查响应内容是否包含认证错误关键词
   - 考虑Cookie保护期（刚设置Cookie后的10秒内不视为过期）
   - 使用锁机制确保只触发一次回调

### 2. 自动定期刷新（可选功能）

**触发条件**：
- 设置中启用了"自动刷新Cookie"（`autoRefreshCookie == true`）
- 达到设定的刷新间隔（默认每天86400秒）
- 用户已登录且有有效Cookie

**配置选项**：
- 每天刷新（86400秒）
- 每周刷新（604800秒）
- 每月刷新（2592000秒）

## 静默刷新流程

### 阶段一：触发与准备

```
AuthenticationStateManager.handleCookieExpired()
    ↓
检查设置：silentRefreshOnFailure == true?
    ↓ 是
标记状态：cookieExpiredShown = true
    ↓
调用静默刷新：attemptSilentRefresh()
```

### 阶段二：静默刷新执行

```
MiNoteService.refreshCookie()
    ↓
检查Cookie是否仍然有效（避免重复刷新）
    ↓ 无效
调用SilentCookieRefreshManager.refresh()
```

**SilentCookieRefreshManager刷新流程**：

1. **初始化**：
   - 创建隐藏的WKWebView
   - 设置Chrome用户代理
   - 配置30秒超时机制

2. **页面加载**：
   ```swift
   webView.load(URLRequest(url: "https://i.mi.com"))
   ```

3. **登录状态检测**：
   - 主页加载完成后检查Cookie store
   - 验证是否包含`serviceToken=`和`userId=`
   - 如果已登录：直接导航到profile页面
   - 如果未登录：执行自动点击登录按钮

4. **自动点击登录按钮**（JavaScript注入）：
   ```javascript
   // 四种检测方式：
   // 1. 通过class选择器：'.miui-btn.miui-btn-primary...'
   // 2. 通过文本内容：'使用小米账号登录'
   // 3. 通过"登录"文本
   // 4. 通过"小米账号"文本
   ```

5. **Cookie提取**：
   - 导航到profile页面：`https://i.mi.com/status/lite/profile?ts=...`
   - 从WKWebView的cookie store获取所有Cookie
   - 复制到URLSession的HTTPCookieStorage
   - 构建完整的Cookie字符串

6. **验证与保存**：
   - 验证Cookie包含`serviceToken=`和`userId=`
   - 调用`MiNoteService.setCookie(cookieString)`
   - 保存到UserDefaults

### 阶段三：状态恢复

```
静默刷新成功
    ↓
AuthenticationStateManager.restoreOnlineStatus()
    ↓
清除失效标志：isCookieExpired = false
清除弹窗状态：cookieExpiredShown = false
清除离线模式：shouldStayOffline = false
    ↓
重新计算在线状态：isOnline = networkOnline && hasValidCookie
    ↓
通知ViewModel处理待同步操作
```

### 阶段四：失败处理

```
静默刷新失败（最多3次尝试）
    ↓
指数退避重试：2秒 → 4秒 → 6秒
    ↓
所有尝试失败
    ↓
显示Cookie失效弹窗：showCookieExpiredAlert = true
    ↓
用户选择：
1. 刷新Cookie → 打开CookieRefreshView（手动刷新）
2. 取消 → 保持离线模式（shouldStayOffline = true）
```

## 重试机制

### 静默刷新重试
- **最大尝试次数**：3次
- **重试间隔**：指数退避（2秒、4秒、6秒）
- **重试条件**：网络错误、页面加载失败、Cookie提取失败

### 网络请求重试
- 在`MiNoteService.refreshCookie()`中实现
- 每次尝试调用完整的刷新流程
- 记录最后一次错误用于最终报告

## 状态管理

### 关键状态变量

| 变量 | 类型 | 说明 |
|------|------|------|
| `isCookieExpired` | Bool | Cookie是否失效 |
| `cookieExpiredShown` | Bool | 是否已显示过失效弹窗 |
| `shouldStayOffline` | Bool | 用户是否选择保持离线 |
| `showCookieExpiredAlert` | Bool | 是否显示失效弹窗 |
| `cookieExpiredFlag` | Bool | Cookie失效标志（防止重复触发） |

### 状态流转

```
正常状态 → Cookie失效 → 静默刷新尝试
    ↓成功                  ↓失败
恢复在线状态 → 显示弹窗 → 用户选择
                           ↓
                   刷新Cookie/保持离线
```

## 配置选项

### 用户设置（SettingsView）
1. **Cookie失效时静默刷新**（默认启用）
   - 键：`silentRefreshOnFailure`
   - 默认值：`true`
   - 作用：控制是否在Cookie失效时尝试静默刷新

2. **自动刷新Cookie**（可选）
   - 键：`autoRefreshCookie`
   - 默认值：`false`
   - 作用：定期自动刷新Cookie，避免过期

### 系统配置
1. **超时时间**：30秒
2. **保护期**：10秒（Cookie刚设置后）
3. **最大重试次数**：3次
4. **检查频率**：动态调整（10-60秒）

## 错误处理

### 错误类型
1. **网络错误**：连接失败、超时
2. **页面错误**：加载失败、元素找不到
3. **认证错误**：登录失败、Cookie无效
4. **超时错误**：30秒内未完成

### 处理策略
1. **静默重试**：自动重试最多3次
2. **降级处理**：静默刷新失败后显示弹窗
3. **状态保持**：失败后保持离线状态，避免重复请求
4. **用户干预**：最终由用户决定刷新或保持离线

## 日志与调试

### 关键日志点
1. **触发检测**：`[AuthenticationStateManager] 处理Cookie失效`
2. **开始刷新**：`[SilentCookieRefreshManager] 🚀 开始静默Cookie刷新`
3. **页面加载**：`[SilentCookieRefreshManager] 导航完成: https://i.mi.com`
4. **Cookie提取**：`[SilentCookieRefreshManager] 从WKWebView获取到X个cookie`
5. **验证结果**：`[SilentCookieRefreshManager] ✅ Cookie验证通过，提取成功`
6. **失败记录**：`[SilentCookieRefreshManager] ❌ 刷新失败: 错误描述`

### 网络日志
- 所有静默刷新请求和响应都记录到`NetworkLogger`
- 包含时间戳、URL、状态码、错误信息

## 最佳实践

### 开发建议
1. **保持JavaScript更新**：定期检查小米登录页面结构变化
2. **监控失败率**：统计静默刷新成功率，优化策略
3. **用户反馈**：收集用户遇到的认证问题，改进体验

### 用户建议
1. **保持设置启用**：建议用户启用"Cookie失效时静默刷新"
2. **网络环境**：确保稳定的网络连接
3. **定期登录**：长时间未使用后手动检查登录状态

## 注意事项

1. **隐私安全**：静默刷新使用隐藏WebView，不记录用户密码
2. **性能影响**：刷新过程消耗网络和CPU资源，智能控制频率
3. **用户体验**：失败时及时提示，避免长时间无反馈
4. **兼容性**：依赖小米登录页面结构，需关注网站更新

---

*文档版本：1.0*
*最后更新：2026年1月6日*
*基于代码版本：c7124f9c8ec8a0ee93cdb51a14e2eed4013c78cc*
