# 文本存储方式说明

本文档详细说明该项目经过转换之后的文本存储方式。

## 概述

该项目采用**双重存储策略**：
- **本地存储**：使用 RTF 格式（archivedData）存储富文本，保证格式完整性和编辑体验
- **云端存储**：使用 XML 格式（小米笔记格式）存储，与小米笔记服务器兼容

## 数据模型

### Note 数据结构

```swift
public struct Note {
    public let id: String
    public var title: String
    public var content: String          // XML格式（用于云端同步）
    public var folderId: String
    public var isStarred: Bool
    public var createdAt: Date
    public var updatedAt: Date
    public var tags: [String]
    public var rawData: [String: Any]?  // 原始API数据（JSON格式）
    public var rtfData: Data?           // RTF格式（用于本地存储）
}
```

## 本地存储（SQLite 数据库）

### 数据库表结构

```sql
CREATE TABLE notes (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,              -- XML格式（小米笔记格式）
    folder_id TEXT NOT NULL DEFAULT '0',
    is_starred INTEGER NOT NULL DEFAULT 0,
    created_at REAL NOT NULL,
    updated_at REAL NOT NULL,
    tags TEXT,                          -- JSON 数组
    raw_data TEXT,                      -- JSON 对象（包含tag、createDate等）
    rtf_data BLOB                       -- RTF格式的AttributedString数据
);
```

### 字段说明

#### 1. `content` 字段（TEXT）
- **格式**：XML 格式（小米笔记格式）
- **用途**：用于云端同步
- **示例**：
  ```xml
  <new-format/>
  <text indent="1">这是第一段文本</text>
  <text indent="1" bold="1">这是加粗文本</text>
  ```

#### 2. `rtf_data` 字段（BLOB）
- **格式**：RTF 格式（使用 `.archivedData` 格式）
- **用途**：本地存储富文本，保证格式完整性
- **优势**：
  - 保留所有格式信息（字体、颜色、样式等）
  - 支持图片附件
  - 快速加载和编辑
- **存储方式**：二进制 BLOB 数据

#### 3. `raw_data` 字段（TEXT）
- **格式**：JSON 字符串
- **用途**：存储从 API 获取的原始数据
- **包含内容**：
  ```json
  {
    "tag": "笔记的唯一标识",
    "createDate": 1234567890000,
    "modifyDate": 1234567890000,
    "setting": {
      "data": [
        {
          "fileId": "图片ID",
          "mimeType": "image/png"
        }
      ]
    },
    "snippet": "笔记摘要"
  }
  ```

## 云端存储（小米笔记服务器）

### 存储格式

云端使用 **XML 格式**（小米笔记格式）存储笔记内容。

#### XML 格式示例

```xml
<new-format/>
<text indent="1">普通文本</text>
<text indent="1" bold="1">加粗文本</text>
<text indent="1" italic="1">斜体文本</text>
<text indent="1" underline="1">下划线文本</text>
<text indent="1" strikethrough="1">删除线文本</text>
<text indent="1" highlight="1">高亮文本</text>
```

#### XML 标签说明

- `<new-format/>`：新格式标识（必须）
- `<text>`：文本段落
  - `indent`：缩进级别（1-9）
  - `bold`：加粗（1=是，0=否）
  - `italic`：斜体（1=是，0=否）
  - `underline`：下划线（1=是，0=否）
  - `strikethrough`：删除线（1=是，0=否）
  - `highlight`：高亮（1=是，0=否）

## 数据转换流程

### 1. 用户输入 → 本地存储

```
用户输入文本
    ↓
NSAttributedString（编辑器内部格式）
    ↓
转换为 RTF Data（.archivedData 格式）
    ↓
保存到数据库 rtf_data 字段（BLOB）
```

**代码位置**：
- `RichTextEditorWrapper.handleContentChange()` - 处理用户输入
- `NoteDetailView.performSave()` - 保存到本地

### 2. 本地存储 → 云端同步

```
从编辑器获取 NSAttributedString
    ↓
转换为 AttributedString（SwiftUI）
    ↓
转换为 XML（小米笔记格式）
    ↓
保存到数据库 content 字段（TEXT）
    ↓
上传到云端服务器
```

**代码位置**：
- `AttributedStringConverter.attributedStringToXML()` - AttributedString → XML
- `MiNoteContentParser.parseToXML()` - NSAttributedString → XML
- `MiNoteService.updateNote()` - 上传到服务器

### 3. 云端同步 → 本地加载

```
从服务器获取 XML 内容
    ↓
保存到数据库 content 字段（TEXT）
    ↓
转换为 NSAttributedString
    ↓
转换为 RTF Data
    ↓
保存到数据库 rtf_data 字段（BLOB）
    ↓
加载到编辑器显示
```

**代码位置**：
- `MiNoteContentParser.parseToAttributedString()` - XML → NSAttributedString
- `AttributedStringConverter.xmlToAttributedString()` - XML → AttributedString
- `NoteDetailView.loadNoteContent()` - 加载笔记内容

## 存储优先级

### 加载笔记时

1. **优先使用 `rtf_data`**：
   - 如果 `rtf_data` 存在，直接使用（最快、格式最完整）
   - 转换为 `NSAttributedString` 显示在编辑器

2. **回退到 `content`**：
   - 如果 `rtf_data` 不存在，从 `content`（XML）转换
   - 转换为 `NSAttributedString` 后再生成 `rtf_data`

3. **回退到 `raw_data["snippet"]`**：
   - 如果 `content` 也为空，使用 `snippet` 作为临时内容

### 保存笔记时

1. **同时保存两种格式**：
   - `rtf_data`：用于本地快速加载和编辑
   - `content`：用于云端同步

2. **更新策略**：
   - 用户编辑时，更新 `rtf_data`
   - 保存时，从 `rtf_data` 转换为 `content`（XML）
   - 同时保存到数据库

## 格式转换细节

### RTF 格式（archivedData）

- **格式类型**：`.archivedData`（RichTextKit 格式）
- **支持内容**：
  - 文本格式（字体、大小、颜色）
  - 文本样式（加粗、斜体、下划线等）
  - 段落格式（对齐、缩进）
  - 图片附件
- **优势**：保留完整的富文本信息，支持复杂格式

### XML 格式（小米笔记格式）

- **格式类型**：自定义 XML
- **支持内容**：
  - 文本格式（通过属性）
  - 文本样式（通过属性）
  - 段落格式（通过 indent 属性）
  - 图片（通过 `raw_data["setting"]["data"]` 存储图片信息）
- **限制**：格式相对简单，主要支持基本样式

## 数据同步策略

### 离线模式

- 保存到本地数据库（`rtf_data` 和 `content`）
- 添加到离线操作队列
- 网络恢复后自动同步

### 在线模式

1. **先保存到本地**（确保数据不丢失）
2. **再上传到云端**（同步到服务器）
3. **更新本地数据**（使用服务器返回的最新数据）

## 图片存储

### 本地存储

- **位置**：`~/Documents/MiNoteImages/`
- **命名**：`{fileId}.{fileType}`（如 `abc123.png`）
- **管理**：`LocalStorageService` 负责图片的保存和加载

### 云端存储

- **信息存储**：在 `raw_data["setting"]["data"]` 中存储图片元信息
  ```json
  {
    "setting": {
      "data": [
        {
          "fileId": "图片ID",
          "mimeType": "image/png"
        }
      ]
    }
  }
  ```
- **实际文件**：通过 `MiNoteService.uploadFile()` 上传到服务器
- **下载**：通过 `MiNoteService.downloadFile()` 从服务器下载

## 数据完整性

### 数据一致性保证

1. **双重存储**：
   - `rtf_data` 和 `content` 同时保存
   - 确保即使一种格式损坏，另一种格式仍可用

2. **自动转换**：
   - 加载时自动从 XML 生成 RTF
   - 保存时自动从 RTF 生成 XML

3. **数据验证**：
   - 保存前验证数据格式
   - 加载时检查数据完整性

## 性能优化

### 本地存储优化

- **RTF 格式**：快速加载，无需转换
- **延迟加载**：列表只加载基本信息，详情页才加载完整内容
- **缓存机制**：已加载的内容缓存在内存中

### 云端同步优化

- **增量同步**：只同步变更的笔记
- **批量操作**：合并多个操作减少网络请求
- **离线队列**：网络不可用时排队等待

## 总结

该项目采用**双重存储策略**：

1. **本地存储**：
   - `rtf_data`（BLOB）：RTF 格式，用于快速加载和编辑
   - `content`（TEXT）：XML 格式，用于云端同步

2. **云端存储**：
   - XML 格式（小米笔记格式）
   - 与小米笔记服务器完全兼容

3. **转换机制**：
   - 用户输入 → RTF → 本地存储
   - RTF → XML → 云端同步
   - XML → RTF → 本地加载

这种设计既保证了本地编辑的流畅性，又确保了与云端服务器的兼容性。


