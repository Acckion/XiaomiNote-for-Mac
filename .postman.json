{
  "name": "小米笔记语音文件支持",
  "description": "语音文件解析、上传、下载和解密功能的 Postman 测试配置",
  "collections": [
    {
      "name": "audio-file-support-collection",
      "path": ".postman/audio-file-support-collection.json",
      "description": "语音文件支持测试集合"
    }
  ],
  "environments": [
    {
      "name": "audio-file-support-env",
      "path": ".postman/audio-file-support-environment.json",
      "description": "语音文件测试环境"
    }
  ],
  "testData": {
    "noteId": "48926433520534752",
    "soundFileId": "1315204657.jgHyouv563iSF_XCE4jhAg",
    "soundDigest": "8a41074a7bf788cf921a32a781e7b676f3103968.mp3",
    "soundMimeType": "audio/mpeg"
  },
  "mimeTypeNotes": {
    "audio/mp3": "❌ 非标准 MIME 类型（不推荐使用）",
    "audio/mpeg": "✅ 标准 MIME 类型（推荐使用，已在代码中更新）"
  },
  "fileExtensionNotes": {
    ".mp3": "✅ API 接受的标准扩展名",
    ".m4a": "⚠️ 客户端自动转换为 .mp3（AudioUploadService 处理）",
    "其他格式": "⚠️ 客户端自动添加 .mp3 扩展名"
  },
  "apiEndpoints": {
    "getNote": "GET /note/note/{noteId}/?ts={timestamp}",
    "requestUpload": "POST /file/v2/user/request_upload_file",
    "uploadChunk": "POST {nodeUrl}/upload_block_chunk",
    "commitUpload": "POST /file/v2/user/commit",
    "getDownloadUrl": "GET /file/full/v2?ts={timestamp}&type=note_img&fileid={fileId}"
  },
  "downloadResponseFormats": {
    "simpleFormat": {
      "description": "简单格式 - 直接返回下载 URL",
      "example": "{\"data\": {\"url\": \"https://...\"}}"
    },
    "kssFormat": {
      "description": "KSS 格式 - 分块下载 URL（可能包含解密密钥）",
      "example": "{\"data\": {\"kss\": {\"blocks\": [{\"urls\": [\"http://...\"]}], \"secure_key\": \"22eaa6338446d728\"}}}",
      "secureKeyNote": "secure_key 字段是十六进制字符串，用于解密加密的音频文件"
    }
  },
  "decryptionInfo": {
    "service": "AudioDecryptService",
    "location": "Sources/Service/AudioDecryptService.swift",
    "description": "音频文件解密服务，支持多种解密算法",
    "supportedAlgorithms": [
      {
        "name": "RC4 变体 (1024轮预热)",
        "description": "小米云服务常用的加密方式，在标准 RC4 基础上增加 1024 轮预热",
        "priority": 1
      },
      {
        "name": "标准 RC4",
        "description": "标准 RC4 流密码算法",
        "priority": 2
      },
      {
        "name": "简单 XOR",
        "description": "简单的 XOR 加密",
        "priority": 3
      }
    ],
    "keyFormat": {
      "type": "十六进制字符串",
      "example": "22eaa6338446d728",
      "note": "从 KSS 响应的 secure_key 字段获取"
    },
    "supportedAudioFormats": [
      {"format": "MP3 (ID3)", "magicBytes": "49 44 33", "description": "ID3 标签开头"},
      {"format": "MP3 (帧同步)", "magicBytes": "FF FB/FA/F3/F2", "description": "MP3 帧同步字"},
      {"format": "AAC (ADTS)", "magicBytes": "FF F0/F1", "description": "AAC ADTS 同步字"},
      {"format": "M4A/MP4", "magicBytes": "xx xx xx xx 66 74 79 70", "description": "ftyp 标识"},
      {"format": "WAV", "magicBytes": "52 49 46 46 ... 57 41 56 45", "description": "RIFF...WAVE"},
      {"format": "OGG", "magicBytes": "4F 67 67 53", "description": "OggS 标识"},
      {"format": "FLAC", "magicBytes": "66 4C 61 43", "description": "fLaC 标识"}
    ],
    "decryptionFlow": [
      "1. 从 getAudioDownloadInfo 获取下载 URL 和 secure_key",
      "2. 下载加密的音频数据",
      "3. 如果存在 secure_key，调用 AudioDecryptService.decrypt()",
      "4. 解密服务自动尝试多种算法，返回第一个成功的结果",
      "5. 通过检查音频文件头部魔数验证解密是否成功"
    ]
  },
  "uploadTypeNotes": {
    "note_sound": "❌ 无效的 type 值（已测试）",
    "note_audio": "❌ 无效的 type 值（已测试）",
    "note_recording": "❌ 无效的 type 值（已测试）",
    "note_file": "❌ 无效的 type 值（2026-01-11 测试）",
    "note_img": "✅ 推荐使用（与图片上传相同的类型，已验证成功）",
    "note": "语音文件上传应使用 note_img 类型，不使用 sortedKeys 选项"
  },
  "implementationStatus": {
    "uploadAudio": "✅ 已实现 (2026-01-11)",
    "requestAudioUpload": "✅ 已实现 - 第一步：请求上传",
    "uploadFileChunk": "✅ 复用图片上传方法 - 第二步：上传文件块",
    "commitAudioUpload": "✅ 已实现 - 第三步：提交上传",
    "getAudioDownloadURL": "✅ 已实现 - 支持简单格式和 KSS 格式 (2026-01-11 更新)",
    "getAudioDownloadInfo": "✅ 已实现 - 返回 URL 和 secure_key 解密密钥 (2026-01-11 新增)",
    "audioDecryption": "✅ 已实现 - AudioDecryptService 支持 RC4 变体/标准 RC4/XOR (2026-01-11 新增)"
  },
  "uploadFlowNotes": {
    "step1": "requestAudioUpload - 请求上传，获取 uploadId 和 KSS 信息",
    "step2": "uploadFileChunk - 上传实际文件数据到 nodeUrl",
    "step3": "commitAudioUpload - 提交上传，获取最终 fileId",
    "cacheHit": "如果服务器已有缓存，step1 直接返回 fileId，跳过 step2 和 step3"
  },
  "lastUpdated": "2026-01-12",
  "updateNotes": "Web 编辑器新增语音占位符点击播放功能，通过 WebKit 消息处理器通知 Swift 进行播放",
  "webEditorAudioSupport": {
    "description": "Web 编辑器中的语音播放支持",
    "requirements": "13.1 - 点击语音占位符时通知 Swift 进行播放",
    "implementation": {
      "file": "Sources/Web/modules/editor/editor-init.js",
      "eventHandler": "click 事件监听器",
      "messageType": "playAudio",
      "messagePayload": {
        "type": "playAudio",
        "fileId": "语音文件 ID"
      }
    },
    "htmlStructure": {
      "containerClass": "mi-note-sound-container",
      "elementClass": "mi-note-sound",
      "dataAttribute": "data-fileid",
      "example": "<div class=\"mi-note-sound-container\"><div class=\"mi-note-sound\" data-fileid=\"1315204657.xxx\">...</div></div>"
    },
    "swiftIntegration": {
      "messageHandler": "editorBridge",
      "contextFile": "Sources/View/Bridge/WebEditorContext.swift",
      "playMethod": "playAudio(fileId:)",
      "pauseMethod": "pauseAudio(fileId:)",
      "stateUpdateMethod": "updateAudioPlaybackState(fileId:isPlaying:isLoading:error:)"
    }
  },
  "recentChanges": [
    {
      "date": "2026-01-12",
      "method": "editor-init.js",
      "change": "新增语音占位符点击事件处理",
      "reason": "实现需求 13.1 - 点击语音占位符时通知 Swift 进行播放",
      "impact": "用户可以在 Web 编辑器中点击语音占位符触发播放"
    },
    {
      "date": "2026-01-12",
      "method": "AudioUploadService.uploadFromFile",
      "change": "自动将 .m4a 文件扩展名转换为 .mp3",
      "reason": "API 只接受 .mp3 扩展名，.m4a 会导致上传失败",
      "impact": "用户可以上传 .m4a 格式的录音文件，客户端自动处理扩展名转换"
    },
    {
      "date": "2026-01-11",
      "method": "AudioDecryptService",
      "change": "新增音频文件解密服务",
      "reason": "小米云服务返回的音频文件可能是加密的，需要使用 secure_key 解密",
      "impact": "支持播放加密的音频文件"
    },
    {
      "date": "2026-01-11",
      "method": "getAudioDownloadInfo",
      "change": "访问级别从 public 改为 internal（默认）",
      "reason": "该方法是内部实现，公开 API 应使用 getAudioDownloadURL",
      "impact": "无外部影响，内部调用正常"
    }
  ]
}
