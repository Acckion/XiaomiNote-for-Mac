# 架构迁移计划执行摘要

## 🎯 迁移目标

将 MiNote macOS 从单例模式完全迁移到依赖注入架构

## 📊 当前状态分析

### 实际扫描结果 (2026-01-22)
- **单例类数量**: 69 个 (比预估的 45 个多 53%)
- **单例使用次数**: 723 次
- **最大类文件**: NotesViewModel (4,530 行)

### Top 10 最常用单例
1. NetworkLogger.shared - 132 次
2. MiNoteService.shared - 54 次
3. FormatStateManager.shared - 47 次
4. FontSizeManager.shared - 45 次
5. FormatManager.shared - 36 次
6. URLSession.shared - 34 次 (系统单例,不需迁移)
7. ViewOptionsManager.shared - 30 次
8. DatabaseService.shared - 估计 40+ 次
9. SyncService.shared - 估计 35+ 次
10. AudioPlayerService.shared - 估计 25+ 次

## 📅 修订后的时间表

### 原计划: 6-8 周
### 修订计划: 8-10 周 (考虑到实际复杂度)

## 🗓️ 详细阶段规划

### Phase 7.1: 准备工作 (1 周)
**目标**: 建立完整的迁移基础设施

**关键任务**:
- ✅ 创建单例检测脚本 (已完成)
- ✅ 创建完整迁移计划 (已完成)
- [ ] 完善 ServiceLocator 配置
- [ ] 建立测试套件
- [ ] 创建特性开关系统

**验收标准**:
- ServiceLocator 正确初始化所有服务
- 测试覆盖率基线建立
- 特性开关可以切换新旧架构

---

### Phase 7.2: 核心服务迁移 (2 周)
**目标**: 迁移 8 个最关键的服务

**优先级排序**:
1. MiNoteService (54 次使用) - 最关键
2. DatabaseService (估计 40+ 次) - 数据层
3. SyncService (估计 35+ 次) - 同步核心
4. NetworkMonitor (估计 20+ 次) - 网络状态
5. CacheService (估计 15+ 次) - 缓存
6. AudioService (估计 25+ 次) - 音频
7. ImageService (估计 20+ 次) - 图片

**迁移策略**:

```swift
// 阶段 1: 让现有单例实现新协议
extension MiNoteService: NoteServiceProtocol { }

// 阶段 2: 在 ServiceLocator 中注册
ServiceLocator.shared.configure() {
    container.register(NoteServiceProtocol.self, instance: MiNoteService.shared)
}

// 阶段 3: 逐步替换使用点
// 从: MiNoteService.shared.fetchNotes()
// 到: ServiceLocator.shared.noteService.fetchNotes()
// 最终: noteService.fetchNotes() (通过构造函数注入)
```

**验收标准**:
- 8 个核心服务已注册到 ServiceLocator
- 至少 50% 的使用点已迁移
- 所有功能正常工作

---

### Phase 7.3: NotesViewModel 拆分 (2 周)
**目标**: 将 4,530 行的上帝对象拆分为 7 个专注的 ViewModel

**拆分计划**:
```
NotesViewModel (4,530 行)
├── NoteListViewModel (400 行) - 列表管理
├── NoteEditorViewModel (500 行) - 编辑功能
├── SyncCoordinator (400 行) - 同步协调
├── AuthenticationViewModel (300 行) - 认证
├── SearchViewModel (300 行) - 搜索
├── FolderViewModel (300 行) - 文件夹
└── AudioPanelViewModel (300 行) - 音频
```

**迁移策略**:
1. 重新添加之前移除的 ViewModel 文件
2. 修复协议不匹配问题
3. 创建 AppCoordinator 管理 ViewModel 生命周期
4. 使用特性开关逐步启用新 ViewModel
5. 保留旧 NotesViewModel 作为备份

**验收标准**:
- 7 个新 ViewModel 已创建并测试
- AppCoordinator 正常工作
- 可以通过特性开关切换

---

### Phase 7.4: 格式管理器迁移 (1 周)
**目标**: 迁移编辑器相关的格式管理器

**需要迁移** (128 次使用):
- FormatStateManager (47 次)
- FontSizeManager (45 次)
- FormatManager (36 次)

**迁移策略**:
这些管理器与编辑器紧密耦合,需要:
1. 创建 FormatManagementProtocol
2. 将管理器注入到 NativeEditorContext
3. 更新所有使用点

**验收标准**:
- 格式管理器已协议化
- 编辑器功能正常
- 格式应用准确

---

### Phase 7.5: 状态管理器迁移 (1 周)
**目标**: 迁移 ViewOptionsManager 和其他状态管理器

**需要迁移**:
- ViewOptionsManager (30 次)
- AppStateManager
- ViewStateCoordinator
- 其他状态管理器

**迁移策略**:
1. 状态应该属于相关的 ViewModel
2. 跨 ViewModel 状态通过 AppCoordinator 管理
3. 使用 Combine 进行状态同步

**验收标准**:
- 状态管理更加集中
- 减少状态同步问题
- UI 响应正常

---

### Phase 7.6: 网络日志迁移 (1 周)
**目标**: 迁移 NetworkLogger (132 次使用 - 最多!)

**特殊考虑**:
NetworkLogger 使用次数最多,需要特别小心

**迁移策略**:
1. 创建 NetworkLoggingProtocol
2. 实现可配置的日志级别
3. 支持多个日志输出目标
4. 批量替换所有使用点

**验收标准**:
- 日志功能正常
- 性能无影响
- 可以动态配置

---

### Phase 7.7: 剩余服务迁移 (1 周)
**目标**: 迁移所有剩余的单例

**包括**:
- 操作队列 (UnifiedOperationQueue, OperationProcessor 等)
- 辅助服务 (ErrorRecoveryService, StartupSequenceManager 等)
- 编辑器服务 (XMLNormalizer, TitleExtractionService 等)
- 其他服务

**迁移策略**:
按依赖关系排序,逐个迁移

**验收标准**:
- 所有单例已迁移
- 功能完整
- 测试通过

---

### Phase 7.8: 清理和优化 (1 周)
**目标**: 移除旧代码,优化性能

**任务**:
1. 移除所有 `.shared` 属性
2. 删除或标记废弃 NotesViewModel
3. 清理冗余代码
4. 性能优化
5. 文档更新

**验收标准**:
- 单例数量: 69 → 0
- 最大类行数: 4,530 → < 500
- 测试覆盖率: > 80%
- 性能达标

---

## 🎯 成功指标

### 定量指标
- ✅ 单例类: 69 → 0 (100% 减少)
- ✅ 单例使用: 723 → 0 (100% 减少)
- ✅ 最大类: 4,530 → < 500 行 (89% 减少)
- ✅ 测试覆盖率: ~40% → > 80% (100% 提升)

### 定性指标
- ✅ 代码更易维护
- ✅ 更容易测试
- ✅ 更好的模块化
- ✅ 更清晰的依赖关系

### 开发效率指标
- ✅ 新功能开发时间减少 50%
- ✅ Bug 修复时间减少 40%
- ✅ 代码审查时间减少 30%
- ✅ 新人上手时间减少 60%

---

## 🔄 风险管理

### 高风险项
1. **NotesViewModel 拆分** - 影响范围大
   - 缓解: 使用特性开关,保留旧代码
   
2. **NetworkLogger 迁移** - 使用次数最多 (132 次)
   - 缓解: 创建兼容层,分批迁移

3. **格式管理器迁移** - 与编辑器紧密耦合
   - 缓解: 充分测试,逐步替换

### 回滚策略
每个 Phase 都可以独立回滚:
- Phase 7.2-7.7: 恢复使用旧单例
- Phase 7.3: 使用特性开关切换回旧 ViewModel
- 完全回滚: 切换到迁移前的 Git 分支

---

## 📋 执行检查清单

### 开始前
- [ ] 团队成员了解迁移计划
- [ ] 创建迁移分支
- [ ] 备份当前代码
- [ ] 建立性能基线

### 每个 Phase 后
- [ ] 所有任务完成
- [ ] 测试通过
- [ ] 性能验证
- [ ] 代码审查
- [ ] 文档更新

### 完成后
- [ ] 所有单例已移除
- [ ] 所有测试通过
- [ ] 性能达标
- [ ] 文档完整
- [ ] 团队培训

---

## 📞 资源和支持

### 文档
- 完整计划: `docs/架构迁移完整计划.md`
- 进度追踪: `docs/迁移进度追踪.md`
- 架构文档: `docs/Architecture.md`

### 工具
- 单例检测: `scripts/detect_singletons.rb`
- DI 转换: `scripts/convert_to_di.rb` (待创建)

### 命令
```bash
# 检测单例使用
ruby scripts/detect_singletons.rb

# 运行测试
xcodebuild test -project MiNoteMac.xcodeproj -scheme MiNoteMac

# 检查编译
xcodebuild build -project MiNoteMac.xcodeproj -scheme MiNoteMac
```

---

## 🎉 预期成果

完成迁移后,项目将具有:

1. **现代化架构**
   - 依赖注入
   - 协议抽象
   - 模块化设计

2. **更好的可测试性**
   - 80%+ 测试覆盖率
   - Mock 服务支持
   - 集成测试

3. **更高的开发效率**
   - 清晰的代码结构
   - 更快的开发速度
   - 更容易维护

4. **更好的代码质量**
   - 无单例模式
   - 小而专注的类
   - 显式依赖

---

**创建日期**: 2026-01-22  
**预计开始**: 待定  
**预计完成**: 8-10 周后  
**状态**: 计划阶段
