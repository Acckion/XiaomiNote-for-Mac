# æ¶æ„è¿ç§»å›æ»šæ–¹æ¡ˆ

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2026-01-22  
**çŠ¶æ€**: å‡†å¤‡å°±ç»ª

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å›æ»šç­–ç•¥](#å›æ»šç­–ç•¥)
3. [å„é˜¶æ®µå›æ»šæ–¹æ¡ˆ](#å„é˜¶æ®µå›æ»šæ–¹æ¡ˆ)
4. [ç´§æ€¥å›æ»šæµç¨‹](#ç´§æ€¥å›æ»šæµç¨‹)
5. [å›æ»šéªŒè¯](#å›æ»šéªŒè¯)

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†æ¶æ„è¿ç§»è¿‡ç¨‹ä¸­çš„å›æ»šæ–¹æ¡ˆï¼Œç¡®ä¿åœ¨å‡ºç°é—®é¢˜æ—¶èƒ½å¤Ÿå¿«é€Ÿæ¢å¤åˆ°ç¨³å®šçŠ¶æ€ã€‚

### å›æ»šåŸåˆ™

1. **å¿«é€Ÿå“åº”**: å‘ç°é—®é¢˜ç«‹å³åœæ­¢è¿ç§»
2. **æœ€å°å½±å“**: åªå›æ»šæœ‰é—®é¢˜çš„éƒ¨åˆ†
3. **æ•°æ®å®‰å…¨**: ç¡®ä¿ç”¨æˆ·æ•°æ®ä¸ä¸¢å¤±
4. **åŠŸèƒ½å®Œæ•´**: å›æ»šåæ‰€æœ‰åŠŸèƒ½æ­£å¸¸

---

## å›æ»šç­–ç•¥

### ç­–ç•¥ 1: Git åˆ†æ”¯å›æ»šï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**: è¿ç§»å¯¼è‡´ä¸¥é‡é—®é¢˜ï¼Œéœ€è¦å®Œå…¨å›æ»š

**æ­¥éª¤**:
```bash
# 1. ä¿å­˜å½“å‰å·¥ä½œï¼ˆå¦‚æœéœ€è¦ï¼‰
git stash save "è¿ç§»å·¥ä½œä¿å­˜"

# 2. åˆ‡æ¢åˆ°è¿ç§»å‰çš„åˆ†æ”¯
git checkout main  # æˆ–å…¶ä»–ç¨³å®šåˆ†æ”¯

# 3. éªŒè¯åŠŸèƒ½
xcodebuild test -project MiNoteMac.xcodeproj -scheme MiNoteMac

# 4. å¦‚æœéœ€è¦æ¢å¤å·¥ä½œ
git stash pop
```

**ä¼˜ç‚¹**:
- âœ… å®Œå…¨å›æ»šï¼Œæ— æ®‹ç•™
- âœ… å¿«é€Ÿå¯é 
- âœ… å¯ä»¥ä¿ç•™è¿ç§»å·¥ä½œ

**ç¼ºç‚¹**:
- âŒ ä¸¢å¤±è¿ç§»æœŸé—´çš„å…¶ä»–ä¿®æ”¹
- âŒ éœ€è¦é‡æ–°å¼€å§‹è¿ç§»

### ç­–ç•¥ 2: ç‰¹æ€§å¼€å…³å›æ»š

**é€‚ç”¨åœºæ™¯**: æ–°æ—§ç³»ç»Ÿå…±å­˜ï¼Œåªéœ€å…³é—­æ–°åŠŸèƒ½

**æ­¥éª¤**:
```swift
// 1. åœ¨ä»£ç ä¸­æ·»åŠ ç‰¹æ€§å¼€å…³
struct FeatureFlags {
    static var useNewArchitecture = false  // è®¾ç½®ä¸º false å…³é—­æ–°æ¶æ„
}

// 2. åœ¨ä½¿ç”¨ç‚¹æ£€æŸ¥å¼€å…³
if FeatureFlags.useNewArchitecture {
    // ä½¿ç”¨æ–°æ¶æ„
    let viewModel = NoteListViewModel(noteService: serviceLocator.noteService)
} else {
    // ä½¿ç”¨æ—§æ¶æ„
    let viewModel = NotesViewModel()
}
```

**ä¼˜ç‚¹**:
- âœ… å¿«é€Ÿåˆ‡æ¢
- âœ… ä¿ç•™è¿ç§»ä»£ç 
- âœ… å¯ä»¥é€æ­¥å¯ç”¨

**ç¼ºç‚¹**:
- âŒ éœ€è¦ç»´æŠ¤ä¸¤å¥—ä»£ç 
- âŒ å¢åŠ ä»£ç å¤æ‚åº¦

### ç­–ç•¥ 3: ä»£ç æ³¨é‡Šå›æ»š

**é€‚ç”¨åœºæ™¯**: å°èŒƒå›´è¿ç§»ï¼Œåªéœ€æ³¨é‡Šæ–°ä»£ç 

**æ­¥éª¤**:
```swift
// 1. æ³¨é‡Šæ–°ä»£ç 
// let noteService = ServiceLocator.shared.noteService
// let notes = try await noteService.fetchNotes()

// 2. æ¢å¤æ—§ä»£ç 
let notes = try await MiNoteService.shared.fetchNotes()
```

**ä¼˜ç‚¹**:
- âœ… ç®€å•å¿«é€Ÿ
- âœ… ä¿ç•™æ–°ä»£ç ä¾›å‚è€ƒ

**ç¼ºç‚¹**:
- âŒ å®¹æ˜“é—æ¼
- âŒ ä»£ç æ··ä¹±

---

## å„é˜¶æ®µå›æ»šæ–¹æ¡ˆ

### Phase 7.1: å‡†å¤‡å·¥ä½œå›æ»š

**é£é™©ç­‰çº§**: ğŸŸ¢ ä½

**å›æ»šæ–¹æ³•**: åˆ é™¤æ–°å¢æ–‡ä»¶

```bash
# åˆ é™¤æ–°å¢çš„å·¥å…·è„šæœ¬
rm scripts/convert_to_di.rb
rm scripts/track_migration_progress.rb

# åˆ é™¤æ–°å¢çš„æµ‹è¯•æ–‡ä»¶
rm Tests/TestSupport/ViewModelTestTemplate.swift
rm Tests/TestSupport/PerformanceBenchmark.swift

# åˆ é™¤æ–°å¢çš„æ–‡æ¡£
rm docs/è¿ç§»æŒ‡å—.md
rm docs/å›æ»šæ–¹æ¡ˆ.md

# æ¢å¤ ServiceLocator
git checkout Sources/Core/DependencyInjection/ServiceLocator.swift
```

**éªŒè¯**:
```bash
xcodebuild build -project MiNoteMac.xcodeproj -scheme MiNoteMac
```

### Phase 7.2: æ ¸å¿ƒæœåŠ¡è¿ç§»å›æ»š

**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­

**å›æ»šæ–¹æ³•**: æ¢å¤å•ä¾‹è°ƒç”¨

#### æ–¹æ³• 1: ä½¿ç”¨ Git

```bash
# æ¢å¤æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶
git checkout Sources/ViewModel/
git checkout Sources/Service/
```

#### æ–¹æ³• 2: æ‰‹åŠ¨æ¢å¤

```swift
// 1. æ³¨é‡Š ServiceLocator æ³¨å†Œ
// container.register(NoteServiceProtocol.self, instance: noteService)

// 2. æ¢å¤å•ä¾‹è°ƒç”¨
// ä»: ServiceLocator.shared.noteService.fetchNotes()
// åˆ°: MiNoteService.shared.fetchNotes()
```

#### æ–¹æ³• 3: ä½¿ç”¨è„šæœ¬

```bash
# åˆ›å»ºå›æ»šè„šæœ¬
cat > scripts/rollback_di.rb << 'EOF'
#!/usr/bin/env ruby

# å›æ»š DI è½¬æ¢
def rollback_file(file_path, singleton_name, service_accessor)
  content = File.read(file_path)
  
  # æ›¿æ¢ ServiceLocator è°ƒç”¨ä¸ºå•ä¾‹è°ƒç”¨
  pattern = /ServiceLocator\.shared\.#{service_accessor}/
  replacement = "#{singleton_name}.shared"
  
  content.gsub!(pattern, replacement)
  File.write(file_path, content)
  puts "âœ… å·²å›æ»š: #{file_path}"
end

# å›æ»šæ‰€æœ‰æ–‡ä»¶
Dir.glob("Sources/**/*.swift").each do |file|
  rollback_file(file, "MiNoteService", "noteService")
end
EOF

chmod +x scripts/rollback_di.rb
ruby scripts/rollback_di.rb
```

**éªŒè¯**:
```bash
# è¿è¡Œæµ‹è¯•
xcodebuild test -project MiNoteMac.xcodeproj -scheme MiNoteMac

# è¿è¡Œåº”ç”¨
open MiNoteMac.app
```

### Phase 7.3: NotesViewModel æ‹†åˆ†å›æ»š

**é£é™©ç­‰çº§**: ğŸ”´ é«˜

**å›æ»šæ–¹æ³•**: ä½¿ç”¨ç‰¹æ€§å¼€å…³

```swift
// AppDelegate.swift
func applicationDidFinishLaunching(_ notification: Notification) {
    ServiceLocator.shared.configure()
    
    // ä½¿ç”¨ç‰¹æ€§å¼€å…³æ§åˆ¶
    if FeatureFlags.useNewArchitecture {
        // ä½¿ç”¨æ–°çš„ ViewModel æ¶æ„
        appCoordinator = AppCoordinator()
    } else {
        // ä½¿ç”¨æ—§çš„ NotesViewModelï¼ˆå›æ»šï¼‰
        notesViewModel = NotesViewModel()
    }
}
```

**æ­¥éª¤**:
1. è®¾ç½® `FeatureFlags.useNewArchitecture = false`
2. é‡æ–°ç¼–è¯‘åº”ç”¨
3. éªŒè¯åŠŸèƒ½æ­£å¸¸
4. å¦‚æœéœ€è¦ï¼Œåˆ é™¤æ–° ViewModel æ–‡ä»¶

**éªŒè¯**:
```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
xcodebuild test -project MiNoteMac.xcodeproj -scheme MiNoteMac

# æ‰‹åŠ¨æµ‹è¯•å…³é”®åŠŸèƒ½
# - ç¬”è®°åˆ—è¡¨æ˜¾ç¤º
# - ç¬”è®°ç¼–è¾‘
# - ç¬”è®°åŒæ­¥
# - æœç´¢åŠŸèƒ½
```

### Phase 7.4-7.7: å…¶ä»–é˜¶æ®µå›æ»š

**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­

**å›æ»šæ–¹æ³•**: åŒ Phase 7.2

æ¯ä¸ªé˜¶æ®µéƒ½å¯ä»¥ç‹¬ç«‹å›æ»šï¼Œä½¿ç”¨ç›¸åŒçš„æ–¹æ³•ï¼š
1. Git åˆ†æ”¯å›æ»š
2. æ‰‹åŠ¨æ¢å¤å•ä¾‹è°ƒç”¨
3. ä½¿ç”¨å›æ»šè„šæœ¬

### Phase 7.8: æ¸…ç†å’Œä¼˜åŒ–å›æ»š

**é£é™©ç­‰çº§**: ğŸŸ¢ ä½

**å›æ»šæ–¹æ³•**: æ¢å¤åˆ é™¤çš„æ–‡ä»¶

```bash
# ä» Git å†å²æ¢å¤æ–‡ä»¶
git checkout HEAD~1 -- Sources/ViewModel/NotesViewModel.swift

# æ¢å¤å•ä¾‹çš„ .shared å±æ€§
git checkout HEAD~1 -- Sources/Service/Network/MiNoteService.swift
```

---

## ç´§æ€¥å›æ»šæµç¨‹

### è§¦å‘æ¡ä»¶

ä»¥ä¸‹æƒ…å†µéœ€è¦ç«‹å³æ‰§è¡Œç´§æ€¥å›æ»šï¼š

1. âŒ åº”ç”¨æ— æ³•å¯åŠ¨
2. âŒ æ•°æ®ä¸¢å¤±æˆ–æŸå
3. âŒ æ ¸å¿ƒåŠŸèƒ½å®Œå…¨å¤±æ•ˆ
4. âŒ ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼ˆå“åº”æ—¶é—´ > 10 ç§’ï¼‰
5. âŒ å†…å­˜æ³„æ¼å¯¼è‡´å´©æºƒ

### ç´§æ€¥å›æ»šæ­¥éª¤

#### æ­¥éª¤ 1: ç«‹å³åœæ­¢ï¼ˆ1 åˆ†é’Ÿï¼‰

```bash
# 1. åœæ­¢æ‰€æœ‰è¿ç§»å·¥ä½œ
# 2. è®°å½•å½“å‰çŠ¶æ€
git status > rollback_status.txt
git diff > rollback_diff.txt

# 3. ä¿å­˜å·¥ä½œ
git stash save "ç´§æ€¥å›æ»šå‰ä¿å­˜ - $(date)"
```

#### æ­¥éª¤ 2: å¿«é€Ÿå›æ»šï¼ˆ2 åˆ†é’Ÿï¼‰

```bash
# æ–¹æ¡ˆ A: åˆ‡æ¢åˆ°ç¨³å®šåˆ†æ”¯ï¼ˆæ¨èï¼‰
git checkout main
git pull origin main

# æ–¹æ¡ˆ B: å›é€€åˆ°ä¸Šä¸€ä¸ªæäº¤
git reset --hard HEAD~1

# æ–¹æ¡ˆ C: å›é€€åˆ°ç‰¹å®šæäº¤
git reset --hard <commit-hash>
```

#### æ­¥éª¤ 3: éªŒè¯åŠŸèƒ½ï¼ˆ3 åˆ†é’Ÿï¼‰

```bash
# 1. å¿«é€Ÿç¼–è¯‘
xcodebuild build -project MiNoteMac.xcodeproj -scheme MiNoteMac

# 2. è¿è¡Œå…³é”®æµ‹è¯•
xcodebuild test -project MiNoteMac.xcodeproj -scheme MiNoteMac -only-testing:MiNoteMacTests/CoreFunctionalityTests

# 3. å¯åŠ¨åº”ç”¨éªŒè¯
open MiNoteMac.app
```

#### æ­¥éª¤ 4: é€šçŸ¥å’Œè®°å½•ï¼ˆ5 åˆ†é’Ÿï¼‰

```bash
# 1. åˆ›å»ºå›æ»šæŠ¥å‘Š
cat > docs/å›æ»šæŠ¥å‘Š_$(date +%Y%m%d_%H%M%S).md << EOF
# ç´§æ€¥å›æ»šæŠ¥å‘Š

**æ—¶é—´**: $(date)
**åŸå› **: [å¡«å†™å›æ»šåŸå› ]
**å½±å“èŒƒå›´**: [å¡«å†™å½±å“èŒƒå›´]
**å›æ»šæ–¹æ³•**: [å¡«å†™ä½¿ç”¨çš„å›æ»šæ–¹æ³•]

## é—®é¢˜æè¿°
[è¯¦ç»†æè¿°é‡åˆ°çš„é—®é¢˜]

## å›æ»šæ­¥éª¤
[è®°å½•æ‰§è¡Œçš„å›æ»šæ­¥éª¤]

## éªŒè¯ç»“æœ
[è®°å½•éªŒè¯ç»“æœ]

## åç»­è®¡åˆ’
[å¡«å†™åç»­è®¡åˆ’]
EOF

# 2. æäº¤å›æ»š
git add .
git commit -m "ç´§æ€¥å›æ»š: [åŸå› ]"
git push origin main
```

### ç´§æ€¥å›æ»šæ£€æŸ¥æ¸…å•

- [ ] åœæ­¢æ‰€æœ‰è¿ç§»å·¥ä½œ
- [ ] ä¿å­˜å½“å‰å·¥ä½œçŠ¶æ€
- [ ] æ‰§è¡Œå›æ»šæ“ä½œ
- [ ] éªŒè¯åº”ç”¨å¯ä»¥å¯åŠ¨
- [ ] éªŒè¯æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸
- [ ] è¿è¡Œæµ‹è¯•å¥—ä»¶
- [ ] åˆ›å»ºå›æ»šæŠ¥å‘Š
- [ ] é€šçŸ¥å›¢é˜Ÿæˆå‘˜
- [ ] åˆ†æé—®é¢˜åŸå› 
- [ ] åˆ¶å®šä¿®å¤è®¡åˆ’

---

## å›æ»šéªŒè¯

### åŠŸèƒ½éªŒè¯æ¸…å•

#### æ ¸å¿ƒåŠŸèƒ½
- [ ] åº”ç”¨å¯ä»¥æ­£å¸¸å¯åŠ¨
- [ ] ç”¨æˆ·å¯ä»¥ç™»å½•
- [ ] ç¬”è®°åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
- [ ] å¯ä»¥åˆ›å»ºæ–°ç¬”è®°
- [ ] å¯ä»¥ç¼–è¾‘ç¬”è®°
- [ ] å¯ä»¥åˆ é™¤ç¬”è®°
- [ ] ç¬”è®°å¯ä»¥åŒæ­¥

#### é«˜çº§åŠŸèƒ½
- [ ] æœç´¢åŠŸèƒ½æ­£å¸¸
- [ ] æ–‡ä»¶å¤¹ç®¡ç†æ­£å¸¸
- [ ] éŸ³é¢‘åŠŸèƒ½æ­£å¸¸
- [ ] å›¾ç‰‡åŠŸèƒ½æ­£å¸¸
- [ ] æ ¼å¼åŒ–åŠŸèƒ½æ­£å¸¸

#### æ€§èƒ½éªŒè¯
- [ ] å¯åŠ¨æ—¶é—´ < 3 ç§’
- [ ] ç¬”è®°åˆ—è¡¨åŠ è½½ < 1 ç§’
- [ ] ç¼–è¾‘å“åº” < 100ms
- [ ] åŒæ­¥æ—¶é—´ < 10 ç§’
- [ ] å†…å­˜å ç”¨ < 300MB

### æµ‹è¯•éªŒè¯

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
xcodebuild test -project MiNoteMac.xcodeproj -scheme MiNoteMac

# è¿è¡Œç‰¹å®šæµ‹è¯•
xcodebuild test -project MiNoteMac.xcodeproj -scheme MiNoteMac \
  -only-testing:MiNoteMacTests/NoteServiceTests \
  -only-testing:MiNoteMacTests/SyncServiceTests

# æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡
xcodebuild test -project MiNoteMac.xcodeproj -scheme MiNoteMac \
  -enableCodeCoverage YES
```

### æ•°æ®éªŒè¯

```bash
# æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§
sqlite3 ~/Library/Application\ Support/MiNoteMac/notes.db "PRAGMA integrity_check;"

# æ£€æŸ¥ç¬”è®°æ•°é‡
sqlite3 ~/Library/Application\ Support/MiNoteMac/notes.db "SELECT COUNT(*) FROM notes;"

# æ£€æŸ¥æ–‡ä»¶å¤¹æ•°é‡
sqlite3 ~/Library/Application\ Support/MiNoteMac/notes.db "SELECT COUNT(*) FROM folders;"
```

---

## å›æ»šåç»­å·¥ä½œ

### 1. é—®é¢˜åˆ†æ

- è®°å½•é—®é¢˜è¯¦æƒ…
- åˆ†ææ ¹æœ¬åŸå› 
- ç¡®å®šå½±å“èŒƒå›´
- è¯„ä¼°é£é™©ç­‰çº§

### 2. ä¿®å¤è®¡åˆ’

- åˆ¶å®šä¿®å¤æ–¹æ¡ˆ
- è¯„ä¼°ä¿®å¤æ—¶é—´
- ç¡®å®šæµ‹è¯•ç­–ç•¥
- å®‰æ’ä¿®å¤å·¥ä½œ

### 3. é‡æ–°è¿ç§»

- ä¿®å¤é—®é¢˜åé‡æ–°å¼€å§‹
- å¢åŠ æµ‹è¯•è¦†ç›–
- æ›´è°¨æ…åœ°è¿ç§»
- æ›´é¢‘ç¹åœ°éªŒè¯

### 4. ç»éªŒæ€»ç»“

- è®°å½•ç»éªŒæ•™è®­
- æ›´æ–°è¿ç§»æŒ‡å—
- æ”¹è¿›å›æ»šæµç¨‹
- åˆ†äº«ç»™å›¢é˜Ÿ

---

## è”ç³»æ–¹å¼

### ç´§æ€¥è”ç³»

- **æŠ€æœ¯è´Ÿè´£äºº**: [è”ç³»æ–¹å¼]
- **æ¶æ„å¸ˆ**: [è”ç³»æ–¹å¼]
- **æµ‹è¯•è´Ÿè´£äºº**: [è”ç³»æ–¹å¼]

### æ”¯æŒèµ„æº

- **æ–‡æ¡£**: `docs/`
- **å·¥å…·**: `scripts/`
- **æµ‹è¯•**: `Tests/`

---

**æœ€åæ›´æ–°**: 2026-01-22  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ  
**ç‰ˆæœ¬**: 1.0
